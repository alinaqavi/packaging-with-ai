
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Packaging Designer</title>


    <link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
/>
    <style>

      .vm-button-container {
    position: fixed;
    top: 60px;
    right: 20px;
    z-index: 1000;
}

.vm-btn {
    background: linear-gradient(135deg, #00B050 0%, #00A040 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 176, 80, 0.3);
    transition: all 0.3s ease;
    position: relative;
}

.vm-btn:hover {
    background: linear-gradient(135deg, #00A040 0%, #008030 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 176, 80, 0.4);
}

.vm-btn:active {
    transform: translateY(0);
}

.vm-btn i {
    font-size: 1.2em;
}

.vm-btn .dropdown-arrow {
    transition: transform 0.3s ease;
}

.vm-btn.active .dropdown-arrow {
    transform: rotate(180deg);
}

/* ========================================================================
   VM DROPDOWN MENU - Nested Structure
   ======================================================================== */
/* ========================================================================
   VM DROPDOWN MENU - WHITE THEME
   ======================================================================== */
.vm-dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: white;
    border: 2px solid #00B050;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 320px;
    max-width: 400px;
    max-height: 600px;
    overflow-y: auto;
    display: none;
    z-index: 1001;
    animation: slideDown 0.3s ease;
}

.vm-dropdown-menu.active {
    display: block;
}

/* ========================================================================
   DROPDOWN HEADER - WHITE WITH SELECT ALL
   ======================================================================== */
.vm-dropdown-header {
    padding: 16px;
    border-bottom: 2px solid #f0f0f0;
    background: white;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vm-dropdown-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #1A1A1A;
    display: flex;
    align-items: center;
    gap: 8px;
}

.vm-select-all-btn {
    background: transparent;
    border: 1px solid #00B050;
    color: #00B050;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.vm-select-all-btn:hover {
    background: #00B050;
    color: white;
}

.vm-select-all-btn.selected {
    background: #00B050;
    color: white;
}

/* ========================================================================
   PRODUCT LIST - WHITE BACKGROUND
   ======================================================================== */
.vm-product-list {
    padding: 8px;
    background: white;
}
.vm-product-item {
    padding: 12px 16px;
    margin-bottom: 6px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border: 1px solid #f0f0f0;
}

/* ‚úÖ DEFAULT: Name green (bina select kiye) */
.vm-product-item span {
    color: #00B050 !important;
    font-weight: 600;
    transition: all 0.2s ease;
}

/* ‚úÖ HOVER: Light green background */
.vm-product-item:hover {
    background: #f0faf0;
    transform: translateX(4px);
    border-color: #00B050;
}

/* ‚úÖ SELECTED: Full block green + white text */
.vm-product-item.selected {
    background: #00B050 !important;
    border-left: 4px solid #007030;
    transform: translateX(0);
}

.vm-product-item.selected span {
    color: white !important;
    font-weight: 700 !important;
}

/* ‚úÖ Sub-items bhi same */
.vm-sub-item span {
    color: #00B050 !important;
    font-weight: 500;
}

.vm-sub-item.selected {
    background: #00B050 !important;
    border-left: 4px solid #007030;
}

.vm-sub-item.selected span {
    color: white !important;
    font-weight: 700 !important;
}
/* ========================================================================
   ACTION BUTTONS - GREEN GENERATE
   ======================================================================== */
.vm-dropdown-footer {
    padding: 12px 16px;
    border-top: 2px solid #f0f0f0;
    background: white;
    border-radius: 0 0 10px 10px;
    display: flex;
    gap: 8px;
    flex-direction: column;
}

.vm-action-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.vm-action-btn.generate-all,
.vm-action-btn.generate-selected {
    background: #00B050; /*  Green instead of orange */
    color: white;
}

.vm-action-btn.generate-all:hover,
.vm-action-btn.generate-selected:hover {
    background: #008030;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 176, 80, 0.3);
}

.vm-action-btn.cancel {
    background: #f0f0f0;
    color: #333;
}

.vm-action-btn.cancel:hover {
    background: #e0e0e0;
}

/* ========================================================================
   SELECTED PRODUCTS INDICATOR
   ======================================================================== */
.vm-selected-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #FF6B35;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
}

/* ========================================================================
   SCROLLBAR STYLING
   ======================================================================== */
.vm-dropdown-menu::-webkit-scrollbar,
.vm-sub-dropdown::-webkit-scrollbar {
    width: 6px;
}

.vm-dropdown-menu::-webkit-scrollbar-track,
.vm-sub-dropdown::-webkit-scrollbar-track {
    background: #f0f0f0;
}

.vm-dropdown-menu::-webkit-scrollbar-thumb,
.vm-sub-dropdown::-webkit-scrollbar-thumb {
    background: #00B050;
    border-radius: 3px;
}

.vm-dropdown-menu::-webkit-scrollbar-thumb:hover,
.vm-sub-dropdown::-webkit-scrollbar-thumb:hover {
    background: #008030;
}

/* ========================================================================
   RESPONSIVE DESIGN
   ======================================================================== */
@media (max-width: 768px) {
    .vm-button-container {
        top: 75px;
        right: 12px;
    }
    
    .vm-btn {
        padding: 10px 16px;
        font-size: 13px;
    }
    
    .vm-dropdown-menu {
        min-width: 280px;
        max-width: 90vw;
    }
    
    .vm-sub-dropdown {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 280px;
        max-width: 90vw;
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .vm-btn {
        padding: 8px 12px;
        font-size: 12px;
    }
    
    .vm-dropdown-menu {
        min-width: 260px;
    }
    
    .vm-product-item {
        padding: 10px 12px;
    }
    
    .vm-product-item-text .product-desc {
        display: none;
    }
}

/* ========================================================================
   LOADING STATE
   ======================================================================== */
.vm-action-btn.loading {
    opacity: 0.7;
    pointer-events: none;
}

.vm-action-btn.loading::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.vm-loader {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #00B050;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    box-shadow: 0 0 15px rgba(0, 176, 80, 0.2);
}

/* ========================================================================
   DARK MODE SUPPORT (Optional)
   ======================================================================== */
@media (prefers-color-scheme: dark) {}
    .vm-dropdown-menu {
        background: #2a2a2a;
        border-color: #00B050;
    }
    
    .vm-dropdown-header,
    .vm-dropdown-footer {
        background: #1f1f1f;
        color: #fff;
    }
    
    .vm-product-item {
        color: #e0e0e0;
    }
    
    .vm-product-item:hover {
        background: #333;
    }
    
    .vm-product-item-text {
        color: #e0e0e0;
    }
    
    .vm-product-item-text .product-name {
        color: #fff;
    }
    
    .vm-product-item-text .product-desc {
        color: #999;
    }
        /* --- THEME COLORS --- */
        :root {
            --primary-color: #6a994e; /* Light Green */
            --primary-dark: #4a7738;
            --background-light: #f7fff5;
            --chat-bubble-user: #e6f7df; /* Lighter Green for chat */
        }
        
        /* --- CORE LAYOUT & FULL SCREEN --- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-light);   
        }
       .container {
            display: flex; /* Use flexbox for horizontal layout */
            width: 100vw;
            height: 100vh;
            background-color: #fff;
            overflow: hidden;
        }
        
        /* Add basic sizing for the main panels */
        .product-display-panel {
            /* Takes 2/3 of the space, adjust as needed */
            flex: 2; 
            overflow: hidden; 
            display: flex; /* Make sure its children (like the image) align well */
            flex-direction: column;
        }
        
        .chat-panel {
            /* Takes 1/3 of the space, adjust as needed */
            flex: 1; 
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0; /* Optional separator */
        }
        



       /* üåø GREEN CHAT HISTORY PANEL - ENHANCED */
.history-panel {
    height: 100%;
    flex: 0 0 280px;
    background: linear-gradient(180deg, #e7f6e1 0%, #cfe8c0 100%);
    border-right: 2px solid #a7cba2;
    box-shadow: 3px 0 10px rgba(0, 0, 0, 0.05);
    padding: 18px 15px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    transition: all 0.4s ease-in-out;
    position: relative;
}

/* üîò Sidebar collapse animation */
.history-panel.collapsed {
    flex: 0 0 70px;
    overflow: hidden;
}

/* üå± Header Button (Chat History Toggle) */
.history-toggle-header {
    background: var(--primary-color, #6a994e);
    color: white;
    padding: 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    transition: background 0.3s ease;
}
.history-toggle-header:hover {
    background: var(--primary-dark, #4a7738);
}
.history-toggle-header i {
    transition: transform 0.3s ease;
}
.history-toggle-header.active i {
    transform: rotate(180deg);
}

.container {
  display: flex;
  width: calc(100vw - 70px);
  height: 100vh;
  background-color: #fff;
  overflow: hidden;
  margin-left: 70px; /* ‚¨ÖÔ∏è space for collapsed sidebar */
  transition: margin-left 0.3s ease;
}

.smart-sidebar:hover ~ .container {
  margin-left: 240px; /* ‚¨ÖÔ∏è matches expanded width */
}


/* üîÑ Chat Item */
.history-item {
    background: #f6fff4;
    border: 1px solid #cde5c1;
    border-radius: 8px;
    margin-bottom: 8px;
    padding: 8px 10px;
    font-size: 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.25s ease;
    cursor: pointer;
}
.history-item:hover {
    background: #e7f7e3;
    transform: translateX(4px);
}
.history-item.selected {
    background: #def5d6;
    border-color: var(--primary-color, #6a994e);
}

/* üóÇÔ∏è Chat Image Preview */
.history-item img {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #b4d2a3;
    margin-right: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* üß© Icons (Delete / Edit) */
.history-item .icons {
    display: flex;
    gap: 6px;
}
.history-item .icons i {
    color: #558a46;
    font-size: 14px;
    cursor: pointer;
    transition: color 0.2s ease;
}
.history-item .icons i:hover {
    color: #2f5d26;
}

/* ‚ûï New Chat Button */
.new-chat-btn {
    background: #6a994e;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 15px;
    margin-top: 15px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}
.new-chat-btn:hover {
    background: #588f3e;
    transform: scale(1.03);
}

/* üìÇ Folder (Downloaded Images Section) */
.download-folder {
    margin-top: 15px;
    background: #e7f4e0;
    border: 1px solid #c4dfb8;
    border-radius: 10px;
    padding: 12px;
}
.download-folder h4 {
    font-size: 14px;
    margin: 0 0 8px 0;
    color: #4a7738;
}
.download-folder img {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    object-fit: cover;
    margin: 5px;
    border: 1px solid #c6dec0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* üé® Theme Options */
.theme-section {
    margin-top: 15px;
    padding: 12px;
    background: #f5fbf3;
    border-radius: 8px;
    border: 1px solid #d8ead3;
}
.theme-section h4 {
    margin: 0 0 10px;
    font-size: 14px;
    color: #4a7738;
}
.theme-color {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
    cursor: pointer;
    border: 2px solid #c7dfbc;
    transition: transform 0.2s;
}
.theme-color:hover {
    transform: scale(1.2);
}
.theme-color.green { background: #6a994e; }
.theme-color.brown { background: #8b5e34; }
.theme-color.pink { background: #e79bb7; }
.theme-color.blue { background: #4b8bd4; }

/* üë§ Login Button */
.login-btn {
    margin-top: auto;
    background: linear-gradient(90deg, #558a46, #78b36b);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 12px 18px;
    font-weight: 600;
    font-size: 15px;
    text-align: center;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.1s ease;
}
.login-btn:hover {
    background: linear-gradient(90deg, #4a7738, #659c59);
    transform: scale(1.04);
}

/* üß≠ Scrollbar (soft green) */
.chat-history-container::-webkit-scrollbar {
    width: 6px;
}
.chat-history-container::-webkit-scrollbar-thumb {
    background-color: #a7ca9c;
    border-radius: 10px;
}
.chat-history-container::-webkit-scrollbar-thumb:hover {
    background-color: #7aa66e;
}

/* ------------------------------------------------------------------------- */
/* NEW MOBILE SIDEBAR STYLES */
/* ------------------------------------------------------------------------- */
.mobile-header {
    display: none; /* Hidden by default, only visible on mobile */
    align-items: center;
    padding: 10px 0;
    background-color: #fff;
    border-bottom: 1px solid #e0e0e0;
    position: fixed; /* Fixed to stay at the top */
    top: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    padding: 10px 15px;
    z-index: 10;
}

.mobile-menu-toggle {
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 12px;
    font-size: 1.2em;
    cursor: pointer;
    margin-right: 10px;
    transition: background 0.3s;
}

.mobile-menu-toggle:hover {
    background: var(--primary-dark);
}

.mobile-title {
    margin: 0;
    font-size: 1.2em;
    color: var(--primary-dark);
}

#mobile-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 99;
    display: none;
    transition: opacity 0.3s;
    opacity: 0;
}

#mobile-backdrop.visible {
    display: block;
    opacity: 1;
}



.chat-history-container::-webkit-scrollbar {
    width: 6px;
}
.chat-history-container::-webkit-scrollbar-thumb {
    background-color: #a7ca9c;
    border-radius: 10px;
}
.chat-history-container::-webkit-scrollbar-thumb:hover {
    background-color: #7aa66e;
}



        
        /* 2. DESIGNER PANEL (CENTER) */
        .designer-panel {
            height: 100%;
            flex: 0 0 400px; /* Fixed width */
            padding: 25px 30px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            background-color: #fff;
            padding-bottom: 20px; 
        }


        /* 3. CHAT PANEL (RIGHT MAIN AREA) */
        /* 3. CHAT PANEL (RIGHT MAIN AREA) */
.chat-panel {
    height: 100%;
    flex-grow: 1; /* Takes up main remaining space */
    display: flex !important; /* ‚úÖ FIX: Force the chat panel to display */
    flex-direction: column;
    padding: 30px;
    box-sizing: border-box;
    background-color: var(--background-light); 
}
        
        /* --- SECTION STYLES (No Change) --- */
        h2 {
            color: var(--primary-dark);
            margin-top: 0;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 4px;
            font-size: 1.5em;
        }
        .section {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 8px;
            background-color: #ffffff; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        

        .section-title {
  font-size: 1.4em;
  font-weight: 700;
  color: #2e8b21;
  position: relative;
  margin-bottom: 18px;
  font-family: 'Poppins', sans-serif;
  letter-spacing: 0.5px;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeSlideIn 1s ease forwards;
}

/* --- Underline --- */
.section-title::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -5px;
  height: 3px;
  width: 0;
  background: linear-gradient(90deg, #a3d79f, #8ffb91);
  border-radius: 2px;
  animation: underlineGrow 1s 0.5s ease forwards;
}

/* --- Keyframes --- */
@keyframes fadeSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes underlineGrow {
  from { width: 0; }
  to { width: 60px; }
}

        
        /* Sub-option container */
        .sub-option-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            overflow-x: auto; 
            padding: 5px 0;
        }
        .sub-option-selector::-webkit-scrollbar { height: 8px; }
        .sub-option-selector .product-item {
            flex-shrink: 0; 
            width: 120px; 
        }

       

    

 
        /* --- PRODUCT GRID CONTAINER (2-ROW SCROLL) --- */
        .product-selector-wrapper {
            height: 240px; 
            overflow-y: hidden; 
            overflow-x: auto; 
            padding-bottom: 10px;
            border: 1px solid #e9ecef; 
            border-radius: 8px;
            padding: 10px;
        }
        .product-selector-wrapper::-webkit-scrollbar { height: 8px; }
        .product-selector-wrapper::-webkit-scrollbar-thumb {
            background-color: #ced4da;
            border-radius: 10px;
        }
        .product-selector {
            display: grid;
            grid-template-rows: repeat(2, 1fr); 
            grid-auto-flow: column; 
            gap: 10px;
            width: fit-content; 
            padding-bottom: 15px; 
        }

        /* 1. KEYFRAMES ANIMATION: ‡§∏‡•ç‡§≤‡§æ‡§á‡§° ‡§ï‡•Ä ‡§ó‡§§‡§ø ‡§î‡§∞ ‡§¶‡•Ç‡§∞‡•Ä ‡§∏‡•á‡§ü ‡§ï‡§∞‡§§‡§æ ‡§π‡•à */
@keyframes slide-loop {
    /* ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§Æ‡•Ç‡§µ‡§Æ‡•á‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç */
    0% { transform: translateX(0); }
    /* ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•Ä 50% ‡§ö‡•å‡§°‡§º‡§æ‡§à ‡§§‡§ï ‡§Æ‡•Ç‡§µ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à (‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§§‡§ï) */
    /* ‡§Ø‡§π ‡§¶‡•Ç‡§∞‡•Ä, ‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•Ä ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§Æ‡•á‡§Ç ‡§∏‡•Ä‡§Æ‡§≤‡•á‡§∏ ‡§≤‡•Ç‡§™ ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à */
    100% { transform: translateX(-75%); } 
}

/* --- WRAPPER / VIEWPORT: (‡§™‡§π‡§≤‡•á .product-selector-wrapper ‡§•‡§æ) --- */
.product-selector-wrapper {
    /* ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§π‡§ü‡§æ ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à */
    /* overflow-x: auto; ‡§ï‡•Ä ‡§ú‡§ó‡§π ‡§Ö‡§¨ overflow: hidden; ‡§ï‡§æ ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§π‡•ã‡§ó‡§æ */
    
    height: 240px; 
    overflow-y: hidden; 
    overflow-x: hidden; /* ‚¨ÖÔ∏è CRITICAL: ‡§π‡•â‡§∞‡§ø‡§ú‡•â‡§®‡•ç‡§ü‡§≤ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§π‡§ø‡§°‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ */
    position: relative; /* ‡§è‡§®‡§ø‡§Æ‡•á‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä */
    
    padding-bottom: 10px;
    border: 1px solid #e9ecef; 
    border-radius: 8px;
    padding: 10px;
}
/* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤‡§¨‡§æ‡§∞ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§è ‡§ó‡§è ‡§ï‡•ç‡§Ø‡•ã‡§Ç‡§ï‡§ø ‡§Ö‡§¨ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã‡§ó‡§æ */
.product-selector-wrapper::-webkit-scrollbar { height: 0; }
.product-selector-wrapper::-webkit-scrollbar-thumb { background-color: transparent; }

/* --- SLIDER CONTAINER: (‡§™‡§π‡§≤‡•á .product-selector ‡§•‡§æ) --- */
.product-selector {
    /* ‡§ó‡•ç‡§∞‡§ø‡§° ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏: 2 ‡§™‡§Ç‡§ï‡•ç‡§§‡§ø‡§Ø‡§æ‡§Å ‡§î‡§∞ ‡§π‡•â‡§∞‡§ø‡§ú‡•â‡§®‡•ç‡§ü‡§≤ ‡§´‡•ç‡§≤‡•ã (‡§ï‡•ã‡§à ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§®‡§π‡•Ä‡§Ç) */
    display: grid;
    grid-template-rows: repeat(2, 1fr); 
    grid-auto-flow: column; 
    gap: 10px;
    
    /* ‚ö†Ô∏è CRITICAL: ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•Ä ‡§ö‡•å‡§°‡§º‡§æ‡§à ‡§ï‡•ã ‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü‡•á‡§° ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è 200% ‡§ï‡§∞‡•á‡§Ç */
    width: 200%; 
    height: 100%;
    
    /* ‚úÖ AUTO-SLIDE APPLIED: 30 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§ö‡§ï‡•ç‡§∞ ‡§™‡•Ç‡§∞‡§æ ‡§π‡•ã‡§ó‡§æ, ‡§ú‡•ã ‡§Ö‡§®‡§Ç‡§§ ‡§§‡§ï ‡§ö‡§≤‡•á‡§ó‡§æ */
    /* animation: slide-loop 20s linear infinite; 
     */
    /* ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ width: fit-content; ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à */
    padding-bottom: 15px; 
}

/* üí° OPTIONAL: ‡§Æ‡§æ‡§â‡§∏ ‡§≤‡•á ‡§ú‡§æ‡§®‡•á ‡§™‡§∞ ‡§è‡§®‡§ø‡§Æ‡•á‡§∂‡§® ‡§∞‡•Å‡§ï ‡§ú‡§æ‡§è */
.product-selector:hover {
    animation-play-state: running;
}


/* --- PRODUCT ITEM STYLES (‡§ï‡•ã‡§à ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§®‡§π‡•Ä‡§Ç) --- */
.product-item {
    display: flex;
    flex-direction: column; 
    align-items: center;
    justify-content: flex-start; 
    cursor: pointer;
    padding: 0; 
    border: 2px solid #e6e6e6;
    border-radius: 12px;
    transition: all 0.2s ease-in-out;
    background-color: #f0f0f0; 
    font-size: 0.85em;
    width: 120px; 
    height: 125px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    text-align: center;
    overflow: hidden; 
}
.product-item.selected {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(106, 153, 78, 0.4);
    background-color: var(--chat-bubble-user); 
}
/* Common Image Styles (‡§ï‡•ã‡§à ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§®‡§π‡•Ä‡§Ç) */
.product-item img {
    width: 100%; 
    object-fit: cover; 
    margin-bottom: 0;
    border-radius: 0; 
}
.product-selector .product-item {
    height: 100px; 
    justify-content: center;
}
.product-selector .product-item img {
    height: 100%; 
}
.product-selector .product-item span {
    display: block !important;
}
 


/* Pause animation on hover */
.product-selector-wrapper:hover .product-selector {
  animation-play-state: paused;
}
/* üåü Zoom on Hover */
.product-item:hover {
  transform: scale(1.15);
  z-index: 10;
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
        
.product-slider-container {
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
}

.slider-btn {
  background-color: #6a994e;
  color: white;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  font-size: 1.3em;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.slider-btn:hover {
  background-color: #4a7738;
  transform: scale(1.1);
}

.product-slider-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  position: relative;
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 16px;
  padding: 10px 0;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.slider-btn {
  background: linear-gradient(145deg, #6a994e, #4a7738);
  color: white;
  border: none;
  border-radius: 12px;
  width: 40px;
  height: 90px;
  font-size: 1.4em;
  cursor: pointer;
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.slider-btn:hover {
  background: linear-gradient(145deg, #5d8845, #3c6b2b);
  transform: scale(1.08);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.slider-btn i {
  pointer-events: none;
}
.message-image:hover {
  transform: scale(1.03);
}


.product-selector-wrapper {
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  border-radius: 12px;
  flex-grow: 1;
  padding: 8px;
}

.product-selector {
  display: grid;
  grid-template-rows: repeat(2, 1fr);
  grid-auto-flow: column;
  gap: 10px;
}

/* üåø PRODUCT SLIDER CONTAINER */
.product-slider-container {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
}

/* üåø SLIDER BUTTONS (floating over images) */
.slider-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: #6a994e;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.25s ease;
  z-index: 2;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
}

/* Left & Right positioning */
.slider-btn.left {
  left: 6px;
}
.slider-btn.right {
  right: 6px;
}

/* Hover effect */
.slider-btn:hover {
  background: #5d8845;
  transform: translateY(-50%) scale(1.15);
}

/* üåø PRODUCT SLIDER CONTAINER */
.product-slider-container {
  position: relative;
  width: 100%;
  display: flex;
  align-items: center;
}

/* üåø SLIDER BUTTONS (floating over images) */
.slider-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: #6a994e;
  color: white;
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.25s ease;
  z-index: 2;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
  opacity: 0.9;
}

/* Left & Right positioning */
.slider-btn.left { left: 6px; }
.slider-btn.right { right: 6px; }

/* Hover effect */
.slider-btn:hover {
  background: #5d8845;
  transform: translateY(-50%) scale(1.15);
}

/* üåø WRAPPER + SMOOTH SCROLL */
.product-selector-wrapper {
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth; /* smooth magic */
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 10px;
  width: 100%;
}

/* Optional scrollbar style */
.product-selector-wrapper::-webkit-scrollbar {
  height: 6px;
}
.product-selector-wrapper::-webkit-scrollbar-thumb {
  background: #cfcfcf;
  border-radius: 10px;
}

/* üåø PRODUCT GRID */
.product-selector {
  display: grid;
  grid-template-rows: repeat(2, 1fr);
  grid-auto-flow: column;
  gap: 10px;
}








        


        /* 1. Make the sub-option card wider and allow height to grow */
.sub-option-item {
    width: 160px !important;       /* Increased width (was likely 120px) */
    height: auto !important;       /* Allow height to adjust for text */
    min-height: 160px;             /* Ensure a consistent minimum height */
    align-items: flex-start !important; /* Align content to top */
    padding-bottom: 10px !important;
}

/* 2. Fix the Image height */
.sub-option-item img {
    width: 100% !important;
    height: 110px !important;      /* Fixed height for image */
    object-fit: contain !important;
    margin-bottom: 5px;
}

/* 3. Allow the text to wrap to the next line */
.sub-option-item span {
    display: block !important;     
    white-space: normal !important; /* CRITICAL: Allows text to wrap */
    overflow: visible !important;   /* Shows text that overflows */
    text-overflow: clip !important; /* Removes the "..." ellipsis */
    
    font-size: 13px !important;     /* Slightly smaller font to fit more */
    line-height: 1.3 !important;    /* Better spacing between lines */
    text-align: center;
    width: 100%;
    padding: 0 5px;
}

        .message-image {
    display: block;
    max-width: 250px;
    border-radius: 10px;
    margin-top: 8px;
}



        /* üé® COLOR PALETTE STYLES (No Change) üé® */
        
        /* The container for the main button and AI button */
        .color-palette-header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        /* The button that opens the color palette */
        .select-color-btn {
            background-color: #f0f0f0;
            color: #344563;
            padding: 10px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.2s;
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .select-color-btn:hover {
            border-color: var(--primary-color);
            background-color: #e6f6e0;
        }

        /* The small indicator circle */
        .color-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #555;
            transition: background-color 0.2s;
        }
        
        /* Color Swatches Row (Hidden by default, will be toggled) */
        .color-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 10px;
            transition: all 0.3s ease-out;
            /* Shuru mein hidden rahega - JS isko 'display: flex' karega */
            display: none; 
        }

        .color-swatch {
  width: 50px;
  height: 35px;
  background: var(--color);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  border: 2px solid transparent;
}

/* Hover animation */
.color-swatch:hover {
  transform: scale(1.15) rotate(2deg);
  box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
}

        .color-swatch.selected {
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 4px var(--chat-bubble-user); 
            transform: scale(1.05);
        }
        


        
        /* --- LOGO UPLOAD STYLES (Updated for balance) --- */
.logo-preview-container {
    display: flex;
    flex-direction: column; /* stacked layout for balance */
    align-items: flex-start;
    width: 100%;
    gap: 10px;
    margin-top: 7px;
}

.logo-preview {
    width: 100%; /* same as input width */
    height: 70px; /* balanced height for preview area */
    border: 2px dashed #ced4da;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: #fff;
    transition: all 0.3s ease;
}

.logo-preview:hover {
    border-color: var(--primary-color);
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    
}

.logo-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

.logo-label {
    width: 90%;
    margin: 10px auto 15px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;

    background-color: #6a994e; /* same as generate-btn */
    color: #fff;
    border: none;
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;

    padding: 12px 25px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
}

.logo-label:hover {
    background-color: #5d8845; /* darker shade */
    transform: translateY(-2px); /* slight lift effect */
    box-shadow: 0 8px 14px rgba(0, 0, 0, 0.25); /* hover shadow */
}

.logo-label:active {
    transform: translateY(0);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
}


.logo-label:hover {
    background-color: var(--primary-dark);
}

#logoUpload {
    display: none; 
}


        .generate-btn {
    display: flex;
    align-items: center;
    justify-content: center;

    width: 100%;
    max-width: 500px; /* optional limit */
    margin: 5px auto 20px auto; /*TOP margin increased for spacing */
    padding: 14px 24px;

    background-color: #6a994e;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.generate-btn:hover {
    background-color: #5d8845;
    transform: translateY(-2px);
    box-shadow: 0 8px 14px rgba(0, 0, 0, 0.25);
}

.generate-btn:active {
    transform: translateY(0);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
}


        /* ------------------------------------------------ */
        /* 4. CHAT PANEL (RIGHT MAIN AREA) */
        /* ------------------------------------------------ */
        .chat-panel {
            height: 100%;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 30px;
            box-sizing: border-box;
            background-color: var(--background-light);
            /* Removed history panel, so chat panel takes care of right border */
            border-right: none; 
        }
        
       
        
        /*  --- CHAT PANEL STYLES ---*/
        .chat-header {
            /* display: flex; 
            align-items: center; 
            justify-content: flex-start; /* Aligned to the left */
             /*margin-bottom: 15px;
            gap: 15px;  */

            background-color: #eef3ee; /* Your Green */
            color: white;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
        } 
         .chat-header h3 {
            flex-grow: 1; 
            margin: 0;
            font-size: 1.1em;
            color: #344563;
        }  
        
        /* New Chat Button Style (USED IN HISTORY PANEL) - Removed old style to use the new one */

         .chat-input-area {
            /* display: flex;
            padding-top: 15px;
            width: 100%; 
            box-sizing: border-box; */

            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            background-color: #fff;
            margin-bottom: 0;
    padding-bottom: 10px; /* exact fit */
        }
        .chat-input {
            flex-grow: 1;
            padding: 12px 20px;
            border: 1px solid #ced4da;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 1em;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            min-width: 0;
        }
        .chat-send-btn {
            /* flex-shrink: 0;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            line-height: 1;
            box-shadow: 0 2px 4px rgba(106, 153, 78, 0.3); */

            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 18px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s ease-out; /* Smooth transition */
        }

        .send-btn:hover {
            background-color: #43A047; /* Slightly darker on hover */
        }

        .send-btn:active {
            transform: scale(0.9); /* Squash/Shrink immediately on click */
        
        }

        .chat-messages {
         
  /* background-color: rgba(255, 255, 255, 0.5); /* Semi-transparent white */
  /* backdrop-filter: blur(5px); /* The magic blur effect */
  /* border: 1px solid rgba(255, 255, 255, 0.2); /* Light, subtle border */
  /* box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Soft shadow */
  /* border-radius: 12px 12px 12px 4px; /* Asymmetrical radius */
  /* padding: 15px;  */ 

             flex-grow: 1; 
             background-color: rgba(255, 255, 255, 0.5);
             backdrop-filter: blur(5px);
            overflow-y: auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
            border: 1px solid #eee;
            min-width: 300px; 
        }
        .message-bubble {
             padding: 12px 18px; 
            max-width: 80%; 
            border-radius: 18px;
            line-height: 1.4;
            color: #333;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
            align-self: flex-start;
            background-color: #e6e6e6;
            word-wrap: break-word; 
            display: flex;
            flex-direction: column; 
            box-sizing: border-box;  

            /* max-width: 80%;
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.4; */

        }
        .message-bubble.user {
            /* background-color: var(--chat-bubble-user);
            align-self: flex-end; */
            align-self: flex-end;
            background-color: #4CAF50; /* Green background */
            color: white;
            border-bottom-right-radius: 4px; /* Asymmetrical */
        }

        /* --- IMAGE DISPLAY STYLES (No Change) --- */
        .message-bubble .message-content:not(:empty) + .image-container {
            margin-top: 10px;
        }
        
        .message-bubble .image-container {
            text-align: center; 
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background-color: #fdfdfd;
            margin-top: 0; 
            max-width: calc(100% - 20px); 
            box-sizing: border-box; 
            margin: 0 auto; 
        }
        .message-bubble .message-image {
            max-width: 100%; 
            max-height: 550px; 
            width: auto; 
            height: auto; 
            object-fit: contain; 
            border-radius: 6px;
            margin-bottom: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: auto;

        }

        .message-bubble .message-download-btn {
            display: inline-block; 
            background-color: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            cursor: pointer;
            border: none;
        }
        .message-bubble .message-download-btn:hover {
            background-color: var(--primary-dark);
        }

        /* Download Modal Styles (No Change) */
        .download-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
        }
        .download-modal.active {
            display: flex;
        }
        .download-modal-content {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            padding: 30px;
        }
        .download-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .download-modal-header h3 {
            margin: 0;
            color: var(--primary-dark);
            font-size: 1.5em;
        }
        .download-modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 5px;
            line-height: 1;
        }
        .download-modal-body p {
            color: #666;
            margin-bottom: 20px;
        }
        .download-form-group {
            margin-bottom: 20px;
        }
        .download-form-group label {
            display: block;
            font-weight: 600;
            color: #344563;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .download-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        .download-form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .download-form-group.error input {
            border-color: #dc3545;
        }
        .download-error-message {
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }
        .download-form-group.error .download-error-message {
            display: block;
        }
        .download-submit-btn {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .download-submit-btn:hover {
            background-color: var(--primary-dark);
        }
        .download-submit-btn:active {
            transform: scale(0.98);
        }
        .download-submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .download-disclaimer {
            font-size: 0.8em;
            color: #999;
            text-align: center;
            margin-top: 15px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }

        }

       






        /* üñºÔ∏è IMAGE PREVIEW MODAL */
#imagePreviewModal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}
#imagePreviewModal .preview-img {
    max-width: 85vw;
    max-height: 85vh;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    cursor: zoom-in;
    transition: transform 0.3s ease;
}
#imagePreviewModal .preview-img:hover {
    transform: scale(1.05);
}
@keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
}


.disclaimer-note {
    text-align: center;
    font-size: 12px;
    color: #4a4a4a;
    padding: 8px 10px;
    margin-top: 0;  
    margin-bottom: 0;           /* REMOVE BIG SPACE */
    background: #f3f7f1;
    border: 1px solid #d8e6d2;
    border-radius: 8px;
    font-weight: 500;
    font-style: italic;
    letter-spacing: 0.3px;
}











/* üåø COLLAPSIBLE SIDEBAR */
.smart-sidebar {
  width: 70px;
  height: 100vh;
  background-color: #ffffff;
  border-right: 1px solid #e0e0e0;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: flex-start;
  padding: 10px 0;
  overflow: hidden;
  position: fixed;
  left: 0;
  top: 0;
  transition: width 0.3s ease, background-color 0.3s;
  z-index: 999;
}

/* ‚úÖ Sidebar expands on hover */
.smart-sidebar:hover {
  width: 240px;
}

/* LOGO */
.sidebar-logo {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 12px 0;
  border-bottom: 1px solid #e5e5e5;
}
.sidebar-logo img {
  width: 36px;
  height: auto;
  transition: transform 0.3s ease;
}
.smart-sidebar:hover .sidebar-logo img {
  transform: scale(1.1);
}


/* NAVIGATION ITEMS */
.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 5px;
  width: 100%;
  padding: 10px 8px;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 15px;
  background: none;
  border: none;
  color: #333;
  font-weight: 500;
  font-size: 0.95em;
  padding: 10px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
}
.nav-item i {
  color: #6a994e;
  font-size: 1.3em;
  min-width: 30px;
  text-align: center;
}
.nav-item span {
  opacity: 0;
  transition: opacity 0.3s;
  white-space: nowrap;
}
.smart-sidebar:hover .nav-item span {
  opacity: 1;
}
.nav-item:hover {
  background-color: #f3f9f2;
  transform: translateX(3px);
}

/* CHAT HISTORY */
.chat-history-section {
  width: 100%;
  border-top: 1px solid #e5e5e5;
}
.chat-history-container {
  display: none;
  flex-direction: column;
  padding: 8px 14px;
  max-height: 200px;
  overflow-y: auto;
}
.chat-history-container.open {
  display: flex;
}
.chat-item {
  background: #f8fff7;
  border: 1px solid #e3e8e1;
  border-radius: 6px;
  padding: 8px;
  margin-bottom: 5px;
  font-size: 0.9em;
  cursor: pointer;
}
.chat-item:hover {
  background: #eaf5e8;
}

/* USER LOGIN */
.sidebar-user {
  width: 100%;
  border-top: 1px solid #e0e0e0;
  padding: 12px 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  background-color: #f9fff8;
  cursor: pointer;
}
.sidebar-user i {
  color: #6a994e;
  font-size: 1.5em;
}
#userName {
  opacity: 0;
  transition: opacity 0.3s;
  font-weight: 600;
  color: #333;
}
.smart-sidebar:hover #userName {
  opacity: 1;
}

/* Scrollbar for chat list */
.chat-history-container::-webkit-scrollbar {
  width: 6px;
}
.chat-history-container::-webkit-scrollbar-thumb {
  background: #bcd6b2;
  border-radius: 6px;
}




/* üåø Sidebar Base */
.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding: 20px 10px;
}

/* üåø Each Nav Item */
.nav-item {
  background: none;
  border: none;
  color: #025802; /* Default text color */
  font-size: 15px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 15px;
  border-radius: 8px;
  transition: all 0.25s ease;
  cursor: pointer;
}

/* üåø Icon Styling */
.nav-item i.bi {
  font-size: 1.3rem;
  color: #025802; /* Primary Green */
  transition: color 0.25s ease, transform 0.25s ease;
}

/* üåø Hover Effect */
.nav-item:hover {
  background-color: rgba(106, 153, 78, 0.1);
  transform: translateX(5px);
}

.nav-item:hover i.bi {
  color: #6a994e; /* Lighter green on hover */
  transform: scale(1.2);
}

/* üåø Active (Selected) State */
.nav-item.active {
  background-color: #e6f6e0; /* Soft green background */
  border-left: 4px solid #025802;
}

.nav-item.active i.bi {
  color: #025802;
}

/* üí¨ Chat History Section */
.chat-history-section {
  margin-top: 20px;
  border-top: 1px solid #e0e0e0;
  padding-top: 15px;
}

#chatHistoryToggle {
  width: 100%;
  justify-content: space-between;
}

/* üë§ User Section */
.sidebar-user {
  margin-top: auto;
  padding: 15px;
  background-color: #f4faf0;
  border-top: 1px solid #d8e8d0;
  display: flex;
  align-items: center;
  gap: 8px;
  border-radius: 0 0 10px 10px;
}

.sidebar-user i.bi {
  font-size: 1.4rem;
  color: #025802;
}

.sidebar-user span {
  font-weight: 600;
  color: #025802;
}

/* üåø Optional: Sidebar Hover Glow (when expanded) */
.smart-sidebar:hover {
  box-shadow: 0 0 10px rgba(21, 56, 1, 0.2);
  transition: box-shadow 0.3s ease;
}






/* üìÅ Library dropdown container */
/* üñºÔ∏è Library Overlay Styles */
#libraryOverlay {
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.library-card {
  background: #f9fff8;
  border: 2px solid #d0e8d0;
  border-radius: 12px;
  padding: 15px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.library-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(106, 153, 78, 0.2);
  border-color: #6a994e;
}

.library-card img {
  width: 100%;
  height: 220px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 12px;
  cursor: pointer;
}

.library-card-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}

.library-card-title {
  font-weight: 600;
  color: #2e5c2e;
  font-size: 0.95em;
}

.library-card-date {
  font-size: 0.8em;
  color: #777;
}

.library-download-btn {
  width: 100%;
  background: #6a994e;
  color: white;
  border: none;
  padding: 10px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  margin-top: 10px;
  transition: background 0.3s;
}

.library-download-btn:hover {
  background: #5d8845;
}






/* Chat layout restore */
.chat-main-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 20px;
}

/* Chat messages area scroll fix */
#chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    border-radius: 12px;
}

/* Align messages cleanly */
.message-bubble {
    max-width: 80%;
    margin: 8px 0;
}

.message-bubble.user {
    margin-left: auto;
}

.message-bubble.ai {
    margin-right: auto;
}

/* Welcome texts spacing */
.chat-welcome {
    margin-bottom: 15px;
    font-size: 15px;
}

/* Chat container container width fix */
#chatContainer {
    display: flex;
    flex-direction: column;
     height: 100vh !important;
}


        








.chat-history-container {
    flex-grow: 1;
    overflow-y: auto;
}

.chat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border-radius: 8px;
    background: #f6fff4;
    border: 1px solid #cde5c1;
    margin-bottom: 8px;
    cursor: pointer;
}

.chat-item:hover {
    background: #e7f7e3;
}

.chat-item .chat-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-thumb {
    width: 38px;
    height: 38px;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #c4dfb8;
}

.chat-title {
    font-size: 14px;
    font-weight: 600;
    color: #344563;
}

.chat-menu {
    position: relative;
}

.menu-btn {
    font-size: 16px;
    cursor: pointer;
}

.menu-popup {
    display: none;
    position: absolute;
    right: 0;
    top: 22px;
    width: 140px;
    background: white;
    border: 1px solid #d9e6d3;
    border-radius: 8px;
    z-index: 10;
}

.menu-popup.open {
    display: block;
}

.menu-item {
    padding: 10px;
    cursor: pointer;
}

.menu-item:hover {
    background: #e6f4e3;
}

/* Ensure the country dropdown appears ABOVE the modal */
.iti__country-list {
    z-index: 10001 !important; 
}
.iti {
    width: 100%; /* Ensure input takes full width */
}



/* üåü AI Suggest Button ‚Äì Always Green */
.ai-color-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 2px solid #27ae60;
    background: #047332 !important;   /* Always green */
    color: white !important;
    font-weight: 700;
    cursor: pointer;
    margin: 6px;
    transition: 0.2s ease;
    font-size: 13px;
    letter-spacing: 0.3px;

    display: flex;
    align-items: center;
    justify-content: center;

    /* Remove default browser tooltip (we won't add "title") */
}

/* Hover effect */
.ai-color-btn:hover {
    background: #1c964d !important;
    border-color: #1fae56 !important;
    box-shadow: 0 3px 8px rgba(46,204,113,0.35);
    transform: translateY(-1px);
}

/* Selected state ‚Äî deeper glow */
.ai-color-btn.selected {
    background: #067936 !important;
    border-color: #096330 !important;
    box-shadow: 0 4px 12px rgba(46,204,113,0.55);
}




/* ====================================================================
   √∞≈∏"¬± COMPLETE MOBILE RESPONSIVE DESIGN - BEAUTIFUL UI
   ==================================================================== */
   /* ====================================================================
   üì± COMPLETE MOBILE RESPONSIVE DESIGN - BEAUTIFUL UI
   ==================================================================== */

@media (max-width: 768px) {
    
    /* ==================== RESET & BASE ==================== */
    html, body {
        overflow-x: hidden;
        width: 100vw;
        height: 100vh;
    }
    
    * {
        box-sizing: border-box;
    }

    /* ==================== HIDE DESKTOP SIDEBAR ==================== */
    .smart-sidebar {
        display: none !important;
    }

    /* ==================== MAIN CONTAINER ==================== */
    .container {
        margin-left: 0 !important;
        width: 100vw !important;
        height: 100vh;
        flex-direction: column;
        overflow: hidden;
    }

    /* ==================== MOBILE HEADER (TOP BAR) ==================== */
    .mobile-header {
        display: flex !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: linear-gradient(135deg, #6a994e 0%, #5d8845 100%);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 100;
        padding: 0 15px;
        align-items: center;
        justify-content: space-between;
        animation: slideDown 0.5s ease;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .mobile-menu-toggle {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 10px 14px;
        font-size: 1.4em;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mobile-menu-toggle:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.3);
    }

    .mobile-title {
        margin: 0;
        font-size: 1.1em;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        letter-spacing: 0.5px;
        flex-grow: 1;
        text-align: center;
        padding: 0 10px;
    }

    /* ==================== MOBILE HEADER ICONS ==================== */
    .mobile-header-icons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .mobile-icon-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
    }

    .mobile-icon-btn:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.3);
    }

    /* ==================== MOBILE HISTORY DROPDOWN ==================== */
    .mobile-history-dropdown {
        position: fixed;
        top: 65px;
        right: 10px;
        width: 85vw;
        max-width: 320px;
        max-height: 400px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 999;
        overflow-y: auto;
        padding: 15px;
        display: none;
        animation: slideDown 0.3s ease;
        display: none;
    }

    .mobile-history-dropdown.open {
        display: block;
    }

    .mobile-history-dropdown h4 {
        margin: 0 0 15px 0;
        color: #2e5c2e;
        font-size: 1.1em;
        border-bottom: 2px solid #6a994e;
        padding-bottom: 8px;
    }

    /* ==================== DESIGNER PANEL (SIDEBAR) ==================== */
    .designer-panel {
        position: fixed;
        top: 0;
        left: -100%;
        width: 90vw;
        max-width: 380px;
        height: 100vh;
        background: linear-gradient(180deg, #ffffff 0%, #f8fff5 100%);
        box-shadow: 5px 0 25px rgba(0, 0, 0, 0.3);
        z-index: 1001;
        overflow-y: auto;
        overflow-x: hidden;
        transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 20px 15px;
        padding-top: 70px; /* Space for close button */
    }

    .designer-panel.open {
        left: 0;
        animation: slideInLeft 0.4s ease;
    }

    @keyframes slideInLeft {
        from {
            left: -100%;
            opacity: 0.5;
        }
        to {
            left: 0;
            opacity: 1;
        }
    }

    /* Custom Scrollbar for Designer Panel */
    .designer-panel::-webkit-scrollbar {
        width: 6px;
    }

    .designer-panel::-webkit-scrollbar-track {
        background: rgba(106, 153, 78, 0.1);
        border-radius: 10px;
    }

    .designer-panel::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #6a994e, #5d8845);
        border-radius: 10px;
    }

    /* ==================== CLOSE BUTTON (ONLY ON DESIGNER PANEL) ==================== */
    .mobile-close-btn {
        display: none; /* Hidden by default */
        position: fixed;
        top: 15px;
        right: 15px;
        background: linear-gradient(135deg, #ff5757, #ff3838);
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        font-size: 1.3em;
        cursor: pointer;
        z-index: 1002;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(255, 56, 56, 0.4);
        transition: all 0.3s ease;
    }

    /* ‚úÖ Only show when designer panel is open */
    .designer-panel.open .mobile-close-btn {
        display: flex !important;
    }

    .mobile-close-btn:active {
        transform: scale(0.9) rotate(90deg);
        box-shadow: 0 2px 8px rgba(255, 56, 56, 0.6);
    }

    /* ==================== BACKDROP (OVERLAY) ==================== */
    #mobile-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #mobile-backdrop.visible {
        display: block;
        opacity: 1;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* ==================== CHAT PANEL (MAIN CONTENT) ==================== */
    .chat-panel {
        width: 100% !important;
        height: calc(100vh - 60px);
        margin-top: 60px;
        padding: 15px !important;
        display: flex;
        flex-direction: column;
        background: linear-gradient(180deg, #f7fff5 0%, #ffffff 100%);
    }

    .chat-header {
        display: none; /* Hide desktop chat header */
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px 10px;
        background: white;
        border-radius: 16px;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 15px;
    }

    /* Better Message Bubbles */
    .message-bubble {
        max-width: 85% !important;
        padding: 12px 16px;
        margin: 10px 0;
        border-radius: 18px;
        font-size: 0.95em;
        line-height: 1.5;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        animation: messageSlideIn 0.3s ease;
    }

    @keyframes messageSlideIn {
        from {
            transform: translateY(10px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .message-bubble.user {
        background: linear-gradient(135deg, #6a994e, #5d8845);
        color: white;
        border-bottom-right-radius: 6px;
        margin-left: auto;
    }

    .message-bubble.ai {
        background: linear-gradient(135deg, #f0f0f0, #e8e8e8);
        color: #333;
        border-bottom-left-radius: 6px;
    }

    /* Message Images */
    .message-image {
        max-width: 100% !important;
        border-radius: 12px;
        margin-top: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* ==================== CHAT INPUT AREA ==================== */
    .chat-input-area {
        display: flex;
        gap: 10px;
        padding: 12px;
        background: white;
        border-radius: 25px;
        box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.1);
        align-items: center;
    }

    .chat-input {
        flex: 1;
        padding: 12px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        font-size: 0.95em;
        background: #f9f9f9;
        transition: all 0.3s ease;
    }

    .chat-input:focus {
        border-color: #6a994e;
        background: white;
        outline: none;
        box-shadow: 0 0 0 3px rgba(106, 153, 78, 0.1);
    }

    .chat-send-btn {
        background: linear-gradient(135deg, #6a994e, #5d8845);
        color: white;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        font-size: 1.2em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(106, 153, 78, 0.4);
        transition: all 0.3s ease;
        flex-shrink: 0;
    }

    .chat-send-btn:active {
        transform: scale(0.9);
        box-shadow: 0 2px 8px rgba(106, 153, 78, 0.6);
    }

    /* ==================== DESIGNER PANEL ELEMENTS ==================== */
    .designer-panel h2 {
        font-size: 1.5em;
        color: #2e5c2e;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 3px solid #6a994e;
        text-align: center;
    }

    .section {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-title {
        font-size: 1.1em !important;
        color: #2e8b21;
        margin-bottom: 12px;
        font-weight: 600;
    }

    /* Product Slider */
    .product-slider-container {
        position: relative;
        padding: 10px 0;
    }

    .slider-btn {
        width: 35px !important;
        height: 35px !important;
        font-size: 1.1em !important;
        background: linear-gradient(135deg, #6a994e, #5d8845) !important;
    }

    .product-selector-wrapper {
        height: 200px !important;
        overflow-x: auto;
        scroll-behavior: smooth;
        padding: 5px;
    }

    .product-item {
        width: 100px !important;
        height: 90px !important;
        font-size: 0.8em;
    }

    .product-item img {
        height: 70% !important;
    }

    /* Color Palette */
    .color-swatch {
        width: 42px !important;
        height: 42px !important;
        margin: 5px;
    }

    .ai-color-btn {
        padding: 10px 14px !important;
        font-size: 0.85em !important;
        margin: 5px;
    }

    /* Logo Upload */
    .logo-preview-container {
        margin-top: 10px;
    }

    .logo-preview {
        height: 80px !important;
        border-radius: 10px;
    }

    .logo-label {
        width: 100% !important;
        padding: 14px 20px !important;
        font-size: 0.95em;
        margin-top: 12px;
    }

    /* Brand Name Input */
    #brandNameInput {
        width: 100% !important;
        padding: 12px !important;
        font-size: 0.95em !important;
    }

    /* Generate Button */
    .generate-btn {
        width: 100% !important;
        padding: 16px !important;
        font-size: 1.05em !important;
        margin: 20px 0 15px 0 !important;
        border-radius: 12px;
    }

    /* Disclaimer */
    .disclaimer-note {
        font-size: 0.85em !important;
        padding: 10px !important;
        margin-top: 10px;
    }

    /* ==================== DOWNLOAD MODAL ==================== */
    .download-modal-content {
        max-width: 90% !important;
        margin: 20px;
        padding: 25px 20px !important;
    }

    .download-modal-header h3 {
        font-size: 1.3em;
    }

    .download-form-group input {
        font-size: 0.95em;
        padding: 14px;
    }

    .download-submit-btn {
        font-size: 1em;
        padding: 16px;
    }

    /* ==================== LIBRARY OVERLAY ==================== */
    #libraryOverlay {
        padding: 15px !important;
        padding-top: 70px !important; /* Space for mobile header */
    }

    #libraryGrid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)) !important;
        gap: 15px !important;
    }

    .library-card {
        padding: 10px !important;
    }

    .library-card img {
        height: 150px !important;
    }

    /* Close Library Button */
    #closeLibraryBtn {
        position: fixed !important;
        top: 10px;
        right: 10px;
        z-index: 10000;
        padding: 10px 18px !important;
        font-size: 0.9em !important;
    }

    /* ==================== UTILITY CLASSES ==================== */
    .mobile-only {
        display: block !important;
    }

    .desktop-only {
        display: none !important;
    }

    /* Prevent text selection during animations */
    .designer-panel.open,
    .chat-panel {
        -webkit-user-select: none;
        user-select: none;
    }

    /* Smooth scroll for all containers */
    * {
        -webkit-overflow-scrolling: touch;
    }

}

/* ==================== TABLET VIEW (768px - 1024px) ==================== */
@media (min-width: 769px) and (max-width: 1024px) {
    .designer-panel {
        flex: 0 0 350px !important;
    }

    .chat-panel {
        padding: 20px !important;
    }

    .product-item {
        width: 110px !important;
        height: 95px !important;
    }
}
 



/* ========================================= */
/* üöÄ FINAL FIX: Chat Panel Visibility (Desktop) */
/* ========================================= */
/* Yeh code 1001px ya usse bade screens par Chat Panel ko zabardasti dikhaega aur sahi jagah par laega. */
@media (min-width: 1001px) {
    
    /* 1. Chat Panel ko Visible aur Sahi Position par laana */
    .chat-panel {
        display: flex !important; /* Hamesha dikhao */
        position: relative !important; /* Mobile fixed/absolute position ko hatao */
        width: auto !important; /* Mobile ki 100vw width ko hatao */
        flex-grow: 1 !important; /* Bachi hui jagah lo (Product Panel ke bagal mein) */
        
        /* Mobile-specific scrollbar ko hatao */
        overflow-y: hidden !important;
        overflow-x: hidden !important; 
        
        /* Background aur padding ko wapas set karein */
        padding: 30px !important;
        background-color: var(--background-light) !important; 
    }

    /* 2. Designer Panel (Product Panel) ko bhi theek karna */
    .designer-panel {
        position: relative !important; /* Agar mobile pe absolute/fixed tha toh hatao */
        transform: none !important; /* Agar mobile pe slide hua tha toh reset karo */
        flex: 0 0 400px !important; /* Apni purani width wapas lo */
    }
    
    /* 3. Mobile History Dropdown ko hamesha chhupana (agar galati se dikh raha ho) */
    #mobileHistoryDropdown {
        display: none !important;
    }
}
.history-dropdown {
    position: absolute;
    top: 50px;
    right: 0;
    /* ... baaki styles ... */
    display: none;
}
.history-dropdown.open {
    display: block;
}

.quick-generate-wrapper {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 10px 0 5px 0;
}

.quick-generate-btn {
    background: #6a994e;
    color: #fff;
    padding: 10px 22px;
    font-size: 15px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    transition: 0.2s ease;
}

.quick-generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.35);
}

.quick-generate-btn i {
    font-size: 18px;
}



/* ====================================================================
   üé® COMPLETE COLOR PICKER SYSTEM
   ==================================================================== */

/* Main Button */
.select-color-btn {
    width: 100%;
    background-color: #f0f0f0;
    color: #344563;
    padding: 12px 18px;
    border: 2px solid #ccc;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.select-color-btn:hover {
    border-color: #6a994e;
    background-color: #e6f6e0;
}

.select-color-btn.active {
    border-color: #6a994e;
    background-color: #e6f6e0;
}

/* Dropdown Menu */
.color-dropdown-menu {
    margin-top: 15px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Search Input */
#colorSearchInput:focus {
    border-color: #6a994e !important;
    outline: none;
    box-shadow: 0 0 0 3px rgba(106, 153, 78, 0.1);
}

/* Color Swatches */
.color-swatch {
    aspect-ratio: 1;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.25s ease;
    border: 3px solid transparent;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
}

.color-swatch:hover {
    transform: scale(1.15) rotate(3deg);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
}

.color-swatch.selected {
    border-color: #2e5c2e;
    box-shadow: 0 0 0 4px rgba(46, 92, 46, 0.3);
    transform: scale(1.1);
}

.color-swatch.hidden {
    display: none !important;
}

/* Square Color Cells */
.square-color-cell {
    aspect-ratio: 1;
    cursor: pointer;
    transition: all 0.15s ease;
    border: none;
}

.square-color-cell:hover {
    transform: scale(1.4);
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
    z-index: 10;
    border: 2px solid white;
}

.square-color-cell.selected {
    transform: scale(1.3);
    box-shadow: 0 0 0 3px #2e5c2e;
    z-index: 10;
    border: 2px solid white;
}

.square-color-cell.hidden {
    display: none !important;
}

/* Mobile */
@media (max-width: 768px) {
    #squareColorPalette {
        grid-template-columns: repeat(12, 1fr) !important;
    }
    
    #colorSwatchGrid {
        grid-template-columns: repeat(5, 1fr) !important;
    }
}

















/* Add to your style block (keeps results clean) */
.product-search-item {
    display: inline-block !important;
    vertical-align: top;
    width: 120px;
    padding: 10px;
    margin-right: 14px;
    border-radius: 12px;
    background: #fff;
    border: 1px solid #eee;
    text-align: center;
    cursor: pointer;
}

.product-search-item img {
    width: 90px;
    height: 90px;
    object-fit: cover;
    border-radius: 10px;
    border: 1px solid #ddd;
}

.product-search-item:hover { background:#f3faf1; }
.product-search-item img { width:56px; height:42px; object-fit:cover; border-radius:6px; border:1px solid #eee; }
.product-search-sub { font-size:13px; color:#556; padding-left:66px; margin-top:6px; }
.no-results { padding:12px; color:#888; text-align:center; }
.search-hit { font-weight:600; color:#234e20; }



/* ===== FINAL: Force horizontal ribbon for search results ===== */
#productSearchResults {
  display: flex !important;
  flex-direction: row !important;
  flex-wrap: nowrap !important;
  overflow-x: auto !important;
  overflow-y: hidden !important;
  gap: 14px !important;
  padding: 12px !important;
  box-sizing: border-box !important;
  white-space: normal !important;
}

/* Ensure any wrapper inside becomes a horizontal row too */
#productSearchResults > * {
  flex: 0 0 auto !important;
  display: inline-flex !important;
  flex-direction: column !important; /* image above, name below */
  align-items: center !important;
  justify-content: flex-start !important;
  width: 140px !important;
  min-width: 120px !important;
  padding: 8px !important;
  margin: 0 !important;
  border-radius: 12px !important;
  background: #fff !important;
  border: 1px solid #eee !important;
  box-shadow: none !important;
  text-align: center !important;
}

/* Images inside cards */
#productSearchResults img {
  width: 90px !important;
  height: 90px !important;
  object-fit: cover !important;
  border-radius: 10px !important;
  border: 1px solid #ddd !important;
  display: block !important;
  margin: 0 0 8px 0 !important;
}

/* Card text (product / subproduct name) */
#productSearchResults > * > div,
#productSearchResults .product-search-item > div,
#productSearchResults .product-search-sub > div {
  font-weight: 600 !important;
  font-size: 14px !important;
  color: #333 !important;
  text-align: center !important;
  white-space: normal !important;
  overflow: visible !important;
}

/* Thin horizontal scrollbar styling (optional) */
#productSearchResults::-webkit-scrollbar { height: 10px; }
#productSearchResults::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius: 6px; }

/* Safety: prevent parent flex rules from breaking this row */
#productSearchResults, #productSearchResults * { -webkit-box-sizing: border-box !important; box-sizing: border-box !important; }

/* ================= SEARCH IMAGE SIZE ‚Äì CHOOSE PRODUCT STYLE ================= */

/* Card size thoda compact */
#productSearchResults > * {
  width: 120px !important;
  min-width: 120px !important;
  padding: 6px !important;
}

/* üî• SMALL & CLEAN IMAGE (like choose product) */
#productSearchResults img {
  width: 100% !important;
  height: 65px !important;      /* ‚¨ÖÔ∏è choti image */
  object-fit: contain !important;
  border-radius: 6px !important;
  border: 1px solid #ddd !important;
  margin-bottom: 6px !important;
  background: #f9f9f9;
}

/* Text thoda compact */
#productSearchResults > * > div {
  font-size: 12px !important;
  line-height: 1.2 !important;
}









/* üå´Ô∏è Blur overlay */
.onboarding-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(4px);
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.onboarding-overlay.hidden {
  display: none;
}

/* üéØ Highlight active area */
.onboarding-active {
  position: relative;
  z-index: 10000;
  box-shadow: 0 0 0 4px #6a994e, 0 0 25px rgba(106,153,78,0.7);
  border-radius: 12px;
}

/* üí¨ Tooltip box */
.onboarding-tooltip {
  position: absolute;
  background: #fff;
  color: #333;
  padding: 12px 18px;
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  animation: float 1.5s infinite ease-in-out;
}

/* ‚û°Ô∏è Arrow */
.onboarding-tooltip .arrow {
  width: 14px;
  height: 14px;
  background: white;
  position: absolute;
  transform: rotate(45deg);
}

/* üîÅ Animation */
@keyframes float {
  0% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
  100% { transform: translateY(0); }
}
#tourOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  backdrop-filter:blur(4px);
  z-index:9998;
}

#tourBox{
  position:fixed;
  background:#fff;
  padding:14px 18px;
  border-radius:12px;
  font-weight:600;
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
  z-index:9999;
  animation:float 1.4s ease-in-out infinite;
}

#tourArrow{
  width:14px;
  height:14px;
  background:#fff;
  position:absolute;
  transform:rotate(45deg);
  top:-7px;
  left:20px;
}

@keyframes float{
  0%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
  100%{transform:translateY(0)}
}

.tour-highlight{
  position:relative;
  z-index:10000;
  box-shadow:0 0 0 4px #6a994e,0 0 30px rgba(106,153,78,0.9);
  border-radius:12px;
}





/* ===== FULL PAGE LOADER ===== */
#pageLoader {
  position: fixed;
  inset: 0;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}

#pageLoader.hide {
  opacity: 0;
  visibility: hidden;
}

.loader-content {
  text-align: center;
  animation: fadeIn 1s ease;
}

/* Logo */
.loader-logo {
  width: 120px;          /* thoda chota = clean look */
  display: block;
  margin: 0 auto 6px;   /* üëà yahin se space kam hua */
  animation: floatLogo 2.5s ease-in-out infinite;
}

/* AI text */
.ai-text {
  margin-top: 0;        /* üëà extra gap remove */
  line-height: 1.2;     /* üëà tight spacing */
  font-size: 15px;
}
.loader-logo {
  margin-bottom: 2px;
}




/* AI text */
.ai-text {
  font-size: 16px;
  font-weight: 600;
  color: #285b09;
  letter-spacing: 0.4px;
}

.ai-text span {
  font-weight: 800;
  color: #337007;
}

/* AI dots animation */
.ai-dots {
  margin-top: 15px;
}

.ai-dots span {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: #448615;
  border-radius: 50%;
  margin: 0 3px;
  animation: dots 1.4s infinite ease-in-out;
}

.ai-dots span:nth-child(2) { animation-delay: 0.2s; }
.ai-dots span:nth-child(3) { animation-delay: 0.4s; }

/* Animations */
@keyframes floatLogo {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

@keyframes dots {
  0%, 80%, 100% { opacity: 0.3; }
  40% { opacity: 1; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}



/* üì¶ MOBILE PRODUCT FAB */
.mobile-product-fab {
  display: none;
}

/* üì± Mobile only */
@media (max-width: 768px) {
  .mobile-product-fab {
    display: flex;
    position: fixed;
    bottom: 180px; /* ‚úÖ generate + input dono se upar */
    right: 20px;

    width: 56px;
    height: 56px;
    border-radius: 50%;

    background: linear-gradient(135deg, #6a994e, #5d8845);
    color: #fff;
    border: none;

    align-items: center;
    justify-content: center;

    font-size: 24px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    z-index: 10050; /* ‚úÖ sabse upar */

    cursor: pointer;
    pointer-events: auto;
  }

  .mobile-product-fab:active {
    transform: scale(0.9);
  }
}
@media (max-width: 768px) {
  .designer-panel.open ~ .mobile-product-fab {
    transform: rotate(180deg);
  }
}


/* =====================================================
   üîí CHAT HISTORY VISIBILITY ‚Äì HOVER ONLY (FINAL FIX)
   ===================================================== */

/* Default: history kabhi bhi visible nahi */
.chat-history-container {
  display: none !important;
}

/* ‚úÖ Sirf sidebar hover par hi dikhe */
.smart-sidebar:hover .chat-history-container {
  display: flex !important;
}

/* ‚ùå Sidebar collapse hone par force hide */
.smart-sidebar:not(:hover) .chat-history-container {
  display: none !important;
}
/* Default: chats hidden */
.chat-history-container {
  display: none;
}

/* Sidebar OPEN + hover = show chats */
.smart-sidebar.open:hover .chat-history-container {
  display: block;
}

/* Sidebar CLOSED = force hide */
.smart-sidebar:not(.open) .chat-history-container {
  display: none;
}
/* =====================================================
   CHAT HISTORY ‚Äì FINAL GUARANTEED FIX
   ===================================================== */

/* Default: history bilkul hide */
#chatHistoryList {
  display: none;
}

/* Toggle OPEN ‚Üí show */
#chatHistoryList.open {
  display: block;
}

/* Toggle CLOSED ‚Üí force hide (override everything) */
#chatHistoryList:not(.open) {
  display: none !important;
}



.action-btn-row{
  display: flex;
  gap: 12px;
}

.action-btn-row button{
  flex: 1;
}

.add-to-cart-btn{
  background:#ff9800;
  color:#fff;
  border:none;
  border-radius:8px;
  font-size:1.1em;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
}

.add-to-cart-btn:hover{
  background:#e68900;
}

/* üî• REMOVE EXTRA TOP SPACE ABOVE HEADER */
.chat-panel {
    padding-top: 0 !important;
}

.chat-header {
    margin-top: 0 !important;
    padding-top: 6px !important;
    padding-bottom: 6px !important;
    min-height: unset !important;
}

/* Header text tight */
.chat-header h3 {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1.3;
}

/* ‚úÖ FIX PRODUCT NAME ISSUE (FINAL) */
.product-selector .product-item {
    height: 125px !important;        /* thodi extra height */
    justify-content: flex-start !important;
}

/* image ko limit karo */
.product-selector .product-item img {
    height: 80px !important;         /* image ko cap */
    object-fit: contain;
}

/* product name clearly neeche aaye */
.product-selector .product-item span {
    margin-top: 4px;
    padding: 0 6px;
    font-size: 13px;
    line-height: 1.2;
    text-align: center;

    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* üî• REMOVE EXTRA SPACE BELOW PRODUCT NAME */
.product-selector .product-item {
    justify-content: flex-start !important; /* ‚ùå center hatao */
}

/* üî• Product name tight */
.product-selector .product-item span {
    margin: 0 !important;          /* ‚ùå default gap */
    padding: 2px 6px 0 !important; /* neeche ka space remove */
    line-height: 1.1 !important;   /* compact text */
    display: block;
}
/* üî¥ REMOVE TOP EMPTY SPACE ABOVE "Mockup Designer" */

/* Designer panel ka extra top padding hatao */
.designer-panel {
    padding-top: 10px !important;   /* pehle zyada tha */
}

/* Heading ka default top margin hatao */
.designer-panel h2,
.designer-panel .section-title {
    margin-top: 0 !important;
}

/* Agar koi extra spacer / hr / empty div ho */
.designer-panel > :first-child {
    margin-top: 0 !important;
    padding-top: 0 !important;
}
/* üî¥ REMOVE SPACE ABOVE "Generate Final Mockup" BUTTON */

/* Disclaimer text ke niche ka gap hatao */
.disclaimer-note {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
}

/* Brand name input ke baad ka extra gap */
.logo-preview-container,
.section input,
.section {
    margin-bottom: 6px !important;
}

/* Generate button ke upar ka space control */
.generate-btn {
    margin-top: 8px !important;   /* pehle zyada tha */
}

/* Agar koi empty spacer div aa raha ho */
.section > br,
.section > .spacer {
    display: none !important;
}
/* ========================================
   EXPANDABLE DESCRIPTION SECTION
   ======================================== */

.description-expander {
    width: 100%;
    background: #ffffff;
    border-top: 2px solid #e0e0e0;
}

/* Toggle Button */
.description-toggle {
    width: 100%;
    background: linear-gradient(135deg, #f8fff5, #e8f5e3);
    border: none;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    color: #2e5c2e;
    transition: all 0.3s ease;
    border-bottom: 1px solid #d8e6d2;
}

.description-toggle:hover {
    background: linear-gradient(135deg, #e8f5e3, #d8ecd0);
}

.description-toggle i {
    font-size: 18px;
    transition: transform 0.3s ease;
}

.description-toggle.active i {
    transform: rotate(180deg);
}

/* Content Area (Hidden by default) */
.description-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease;
    background: #fafffe;
}

.description-content.expanded {
    max-height: 2000px; /* Large enough to show all content */
}

.description-inner {
    padding: 40px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.description-inner h3 {
    text-align: center;
    font-size: 26px;
    color: #2e5c2e;
    margin: 0 0 20px 0;
    font-weight: 700;
}

.description-inner > p {
    text-align: center;
    font-size: 15px;
    line-height: 1.8;
    color: #555;
    margin: 0 0 40px 0;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
}

/* Feature Grid */
.description-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin: 40px 0;
}

.desc-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    border: 2px solid #e6f4e0;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.desc-card:hover {
    transform: translateY(-5px);
    border-color: #6a994e;
    box-shadow: 0 6px 20px rgba(106, 153, 78, 0.15);
}

.desc-card i {
    font-size: 36px;
    color: #6a994e;
    margin-bottom: 15px;
}

.desc-card h4 {
    font-size: 16px;
    color: #2e5c2e;
    margin: 0 0 10px 0;
    font-weight: 700;
}

.desc-card p {
    font-size: 13px;
    color: #666;
    margin: 0;
    line-height: 1.6;
}

/* Features List */
.description-features {
    background: #f8fff5;
    padding: 25px;
    border-radius: 12px;
    border: 2px solid #d8e6d2;
    margin: 30px 0;
}

.description-features h4 {
    font-size: 18px;
    color: #2e5c2e;
    margin: 0 0 15px 0;
    font-weight: 700;
}

.description-features ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
}

.description-features li {
    font-size: 14px;
    color: #555;
    padding: 8px 0;
}

/* CTA Section */
.description-cta {
    text-align: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #e0e0e0;
}

.description-cta p {
    font-size: 16px;
    color: #2e5c2e;
    margin: 0 0 20px 0;
    font-weight: 600;
}

.cta-button {
    display: inline-block;
    background: linear-gradient(135deg, #6a994e, #5d8845);
    color: white;
    padding: 12px 30px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(106, 153, 78, 0.3);
}

.cta-button:hover {
    background: linear-gradient(135deg, #5d8845, #4a7738);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(106, 153, 78, 0.4);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .description-toggle {
        font-size: 13px;
        padding: 12px 15px;
    }
    
    .description-inner {
        padding: 25px 15px;
    }
    
    .description-inner h3 {
        font-size: 20px;
    }
    
    .description-inner > p {
        font-size: 14px;
    }
    
    .description-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .desc-card {
        padding: 15px;
    }
    
    .desc-card i {
        font-size: 28px;
    }
    
    .desc-card h4 {
        font-size: 14px;
    }
    
    .desc-card p {
        font-size: 12px;
    }
    
    .description-features ul {
        grid-template-columns: 1fr;
    }
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>


</head>
<body>

 <!-- üåø PAGE LOADER -->
<div id="pageLoader">
  <div class="loader-content">
    <!-- <img src="images/default_logo.png" class="loader-logo"> -->
    <img src="{{ url_for('static', filename='default_logo.png') }}"
     class="loader-logo">
    <div class="ai-text">
     Greenwich Packaging <span>AI</span> Mockup Studio

    </div>

    <div class="ai-dots">
      <span></span><span></span><span></span>
    </div>
  </div>
</div>



    
     <aside class="smart-sidebar">
  <!-- üü¢ Logo Section -->
  <div class="sidebar-logo">
    <img src="{{ url_for('static', filename='gp-logo.png') }}" alt="Logo">
  </div>

  <!-- üå± Navigation Section -->
<nav class="sidebar-nav">
  <button id="newChatBtn" class="nav-item">
    <i class="bi bi-pencil-square"></i> <span>New Chat</span>
  </button>


<!-- <button id="newChatBtn" class="new-chat-btn">
  <i class="bi bi-plus-circle"></i> New Chat
</button> -->


  <!-- <button id="searchChatsBtn" class="nav-item">
    <i class="bi bi-search"></i> <span>Search Chats</span>
  </button> -->

  <!-- <button id="libraryBtn" class="nav-item">
    <i class="bi bi-image"></i> <span>Library</span>
  </button>
  <div id="librarySection" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:10px;"></div> -->

  <!-- üìÅ Library Section (Collapsible) -->
<!-- üìÅ Library Button (Opens Full Page) -->
<button id="libraryBtn" class="nav-item">
  <i class="bi bi-image"></i> <span>Library</span>
</button>

</nav>

<!-- üí¨ Chat History Dropdown
<div class="chat-history-section">
  <button id="chatHistoryToggle" class="nav-item">
    <i class="bi bi-chat-dots"></i> <span>Chats</span>
    <i class="bi bi-chevron-down"></i>
  <div id="chatHistoryList" class="chat-history-container"></div> -->

  <!-- Chat History Dropdown -->
<div class="chat-history-section">
  <button id="chatHistoryToggle" class="nav-item">
    <i class="bi bi-chat-dots"></i> <span>Chats</span>
    <i class="bi bi-chevron-down"></i>
  </button>

  <div id="chatHistoryList" class="chat-history-container"></div>
</div>

<!-- üë§ User Section -->
<div class="sidebar-user" id="userSection">
  <div id="userInfo">
    <i class="bi bi-person-circle"></i>
    <span id="userName">Login</span>
  </div>
</div>
</aside>

<!-- üñºÔ∏è FULL PAGE LIBRARY OVERLAY -->
<div id="libraryOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#fff; z-index:9999; overflow-y:auto;">
  <div style="max-width:1400px; margin:0 auto; padding:30px;">
    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:3px solid #6a994e; padding-bottom:15px;">
      <h1 style="color:#2e5c2e; margin:0; font-size:2em;">
        <i class="bi bi-image" style="margin-right:10px;"></i>Your Photo Library
      </h1>
      <button id="closeLibraryBtn" style="background:#6a994e; color:white; border:none; padding:12px 24px; border-radius:8px; font-size:1em; cursor:pointer; font-weight:600; transition:background 0.3s;">
        <i class="bi bi-x-circle" style="margin-right:6px;"></i>Close
      </button>
    </div>
    
    <!-- Library Grid -->
    <div id="libraryGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:25px;">
      <p style="color:#777; text-align:center; padding:50px; font-size:1.1em;">Loading your designs...</p>
    </div>
  </div>
</div>

  <!-- üåø MAIN CONTAINER (UNCHANGED) -->
  <div class="container">
    <div class="designer-panel" id="designer-sidebar">
      <h2>Mockup Designer</h2>

      <!-- ‚ùå NEW: Close Button (Mobile Only) -->
      <button id="closeSidebarBtn" class="mobile-close-btn" style="display:none;">
        <i class="bi bi-x-lg"></i>
      </button>

      <div class="designer-content">
        <!-- <div class="section">
          <div class="section-title">1. Choose Product (50+ Items):</div>
          <div class="product-selector-wrapper">
            <div class="product-selector" id="productSelector"></div>
          </div>
        </div> -->

        <div class="section">
  <div class="section-title">1. Choose Product (50+ Items):</div>
  <!-- <h3>1. Choose Product (50+ Items):</h3> -->













<!-- 

FIXED PRODUCT SEARCH BAR ABOVE SLIDER
<div class="product-search-wrapper" style="margin: 10px 0 18px 0; width: 100%;">
  <input id="productSearchInput" type="search" placeholder="Search products or sub-products..." 
         style="width:100%; padding:10px 14px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box; font-size:14px;">
  
  <div id="productSearchResults" 
       style="display:none; margin-top:8px; max-height:320px; overflow:auto; border:1px solid #eee; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); padding:8px;">
  </div>
</div> -->
<!-- FIXED PRODUCT SEARCH BAR ABOVE SLIDER -->
<div class="product-search-wrapper" 
     style="margin:10px 0 18px 0; width:100%; position:relative;">

  <input
    id="productSearchInput"
    type="search"
    placeholder="Search products or sub-products..."
    oninput="handleProductSearch(this.value)"
    style="
      width:100%;
      padding:10px 42px 10px 14px; /* right space for X */
      border-radius:12px;
      border:2px solid #111;
      box-sizing:border-box;
      font-size:14px;
      outline:none;
    "
  />

  <!-- ‚ùå CLEAR BUTTON (inside input, right side) -->
  <span
    id="clearSearchBtn"
    onclick="clearProductSearch()"
    style="
      position:absolute;
      right:14px;
      top:50%;
      transform:translateY(-50%);
      font-size:20px;
      font-weight:600;
      color:#0c6817;
      cursor:pointer;
      display:none;
      user-select:none;
    "
  >√ó</span>

  <div
    id="productSearchResults"
    style="
      display:none;
      margin-top:8px;
      max-height:320px;
      overflow:auto;
      border:1px solid #eee;
      border-radius:10px;
      background:#fff;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
      padding:8px;
    ">
  </div>
</div>

















  <div class="product-slider-container">
    <button class="slider-btn left" id="slideLeft"><i class="bi bi-chevron-left"></i></button>


    <!-- PRODUCT SEARCH (Paste this above .product-selector-wrapper)
<div class="product-search-wrapper" style="margin-bottom:12px;">
  <input id="productSearchInput" type="search" placeholder="Search products or sub-products..." 
         style="width:100%; padding:10px 14px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box; font-size:14px;">
  <div id="productSearchResults" style="display:none; margin-top:8px; max-height:320px; overflow:auto; border:1px solid #eee; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); padding:8px;">
     JS will inject results here 
  </div>
</div> -->


    <div class="product-selector-wrapper">
      <div class="product-selector" id="productSelector">
        <!-- your product items load here -->
      </div>
    </div>

    <button class="slider-btn right" id="slideRight"><i class="bi bi-chevron-right"></i></button>
  </div>
</div>


        <div class="section" id="subOptionSection" style="display: none;">
          <div class="section-title">1.2. Choose Product Type:</div>
          <div class="sub-option-selector" id="subOptionSelector"></div>
        </div>

        <!-- <div class="section">
          <div class="section-title">1.5. Choose Base Color:</div>

          <div class="color-palette-header">
            <button class="select-color-btn" id="openColorPaletteBtn">
              <div
                class="color-indicator"
                id="selectedColorIndicator"
                name="AI"
                style="background-color: none"
              ></div>
              Select Color
            </button>
          </div>

          <div class="color-row" id="colorPalette"></div>
        </div> -->

        <div class="section">
    <div class="section-title">1.5. Choose Base Color:</div>

    <!-- Main Select Button -->
    <button class="select-color-btn" id="openColorPaletteBtn" type="button">
        <div class="color-indicator" id="selectedColorIndicator" 
             style="background-color: #f0f0f0; border: 2px dashed #ccc; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #999; font-weight: 700; font-size: 0.9em;">
            
        </div>
        <span style="flex-grow: 1;">Select Color</span>
        <i class="bi bi-chevron-down" id="colorDropdownIcon" 
           style="transition: transform 0.3s;"></i>
    </button>

    <!-- Dropdown Menu -->
    <div class="color-dropdown-menu" id="colorDropdownMenu" style="display: none;">
        
        <!-- Search Bar -->
        <div style="padding: 15px; background: #f8f8f8; border-bottom: 1px solid #e0e0e0;">
            <div style="position: relative;">
                <input 
                    type="text" 
                    id="colorSearchInput" 
                    placeholder="üîç Search (e.g., 'red' or '#FF0000')"
                    style="width: 100%; padding: 10px 35px 10px 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                />
                <button 
                    id="clearSearchBtn" 
                    type="button"
                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; display: none; padding: 4px;"
                >
                    <i class="bi bi-x-circle-fill" style="font-size: 18px; color: #999;"></i>
                </button>
            </div>
            <div id="searchResultCount" style="margin-top: 8px; font-size: 12px; color: #666; display: none;"></div>
        </div>

        <!-- Quick Colors -->
        <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
            <h4 style="margin: 0 0 12px 0; color: #2e5c2e; font-size: 14px;">
                <i class="bi bi-palette-fill"></i> Quick Colors
            </h4>
            <div id="colorSwatchGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                <!-- Swatches will be generated here -->
            </div>
        </div>

        <!-- Square Grid Palette -->
        <div style="padding: 15px;">
            <h4 style="margin: 0 0 12px 0; color: #2e5c2e; font-size: 14px;">
                <i class="bi bi-grid-3x3"></i> Full Color Palette
            </h4>
            <div style="background: linear-gradient(135deg, #fff, #f0f8ff); border-radius: 8px; padding: 10px; max-height: 300px; overflow-y: auto;">
                <div id="squareColorPalette" style="display: grid; grid-template-columns: repeat(20, 1fr); gap: 2px; background: #000; padding: 2px;">
                    <!-- Grid will be generated here -->
                </div>
            </div>
        </div>

    </div>
</div>

        <div class="section">
          <div class="section-title">2. Upload Your Logo (Optional):</div>
          <input type="file" id="logoUpload" accept="image/*,.pdf,.svg,.gif,.webp" />
          <div class="logo-preview-container">
            <div class="logo-preview" id="logoPreview">
              <span>No Logo</span>
            </div>
            <label for="logoUpload" class="logo-label" id="uploadButtonText"
              >Upload Logo</label
            >
          </div>
          <div style="margin-top: 15px;">
    <div class="section-title">Or Enter Brand Name:</div>
    <input type="text" id="brandNameInput" placeholder="Enter your brand name"
           style="width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 6px; font-size: 1em;">
</div>

          <!-- <small
            style="display: block; margin-top: 10px; color: #6c757d"
            >Upload a *transparent PNG* for best overlay results. Max 8MB.</small
          > -->
        </div>
      </div>

      <button id="generateMockupBtn" class="generate-btn">

        Generate Final Mockup
        <div class="loading-spinner" id="mockupLoadingSpinner"></div>
      </button>
    </div>

    <!-- üí¨ CHAT PANEL -->
    <div class="chat-panel">
    <!-- MOBILE HEADER (Visible only on mobile) -->
<div class="mobile-header">
    <button id="mobile-menu-toggle" class="mobile-menu-toggle">
        <i class="bi bi-list"></i>
    </button>
    <h3 class="mobile-title">AI Packaging Chatbot</h3>
    
    <!-- üÜï Mobile Icons: Library & History -->
    <div class="mobile-header-icons">
        <button id="mobileLibraryBtn" class="mobile-icon-btn" title="Library">
            <i class="bi bi-image"></i>
        </button>
        <button id="mobileHistoryBtn" class="mobile-icon-btn" title="Chat History">
            <i class="bi bi-clock-history"></i>
        </button>
    </div>
</div>

<!-- üÜï Mobile History Dropdown -->
<div id="mobileHistoryDropdown" class="mobile-history-dropdown">
    <!-- <h4><i class="bi bi-chat-dots"></i> Recent Chats</h4> -->
    <div id="mobileHistoryList"></div>
</div>
      <div class="chat-header">
        <h3>
          Greenwich Packaging AI Assistant: Let's design! 
        </h3>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message-bubble">
          <!-- <span class="message-content" -->
           <span class="message-content" id="welcomeMessage">

            Hello! welcome to Greenwich AI Packaging Designer. Start by selecting a product
            and a color on the left..</span
          >
        </div>
      </div>
      <!-- ‚≠ê NEW GENERATE BUTTON ABOVE TYPING AREA -->
<div class="quick-generate-wrapper">
    <button id="quickGenerateBtn" class="quick-generate-btn">
        <i class="bi bi-stars"></i> Generate
    </button>
</div>
      <div class="chat-input-area">
        <input
          type="text"
          id="chatInput"
          class="chat-input"
          placeholder="Type your design instructions or questions (e.g., 'Make the box shiny')... (Max 250 characters)"
          maxlength="250"
        />
        <button class="chat-send-btn" id="sendChatBtn">Send</button>
      </div>

      <!-- ‚≠ê Add this EXACTLY HERE -->
<div class="disclaimer-note">
    Note: Greenwich Packaging AI can make mistakes. Please check your design.
</div>

    </div>
  </div>
</div> <!-- Close chat-panel -->

<!-- Disclaimer -->
<div class="disclaimer-note">
    Note: Greenwich Packaging AI can make mistakes. Please check your design.
</div>

<!-- ‚≠ê EXPANDABLE DESCRIPTION (Add This) -->
<div class="description-expander">
    <button class="description-toggle" id="descToggleBtn">
        <span>Learn More About Our AI Designer</span>
        <i class="bi bi-chevron-down"></i>
    </button>
    
    <div class="description-content" id="descContent">
        <div class="description-inner">
            <h3>üé® Greenwich Packaging AI Designer</h3>
            <p>
                Transform your packaging ideas into stunning visual mockups instantly! 
                Our AI-powered design tool helps you create professional packaging designs 
                for cups, bags, boxes, and more.
            </p>
            
            <div class="description-grid">
                <div class="desc-card">
                    <i class="bi bi-lightning-charge-fill"></i>
                    <h4>Instant Generation</h4>
                    <p>Create mockups in seconds with AI technology</p>
                </div>
                <div class="desc-card">
                    <i class="bi bi-palette-fill"></i>
                    <h4>50+ Templates</h4>
                    <p>Wide range of packaging products available</p>
                </div>
                <div class="desc-card">
                    <i class="bi bi-shield-check"></i>
                    <h4>High Quality</h4>
                    <p>Professional print-ready designs</p>
                </div>
                <div class="desc-card">
                    <i class="bi bi-download"></i>
                    <h4>Easy Download</h4>
                    <p>Get your files instantly after generation</p>
                </div>
            </div>
            
            <div class="description-features">
                <h4>Perfect For:</h4>
                <ul>
                    <li>üçΩÔ∏è Restaurants & Cafes</li>
                    <li>üè™ Food Businesses</li>
                    <li>üì¶ Packaging Suppliers</li>
                    <li>üé® Brand Designers</li>
                </ul>
            </div>
            
            <div class="description-cta">
                <p>Start designing your custom packaging today!</p>
                <a href="https://www.greenwichpackaging.co.uk" target="_blank" class="cta-button">
                    Visit Our Website
                </a>
            </div>
        </div>
    </div>
</div> <!-- Close container -->

  <!-- üß© DOWNLOAD MODAL (UNCHANGED) -->
  <div class="download-modal" id="downloadModal">
    <div class="download-modal-content">
      <div class="download-modal-header">
        <h3>Verify to Download</h3>
        <button class="download-modal-close" id="closeModalBtn">&times;</button>
      </div>
      <div class="download-modal-body">
        <p>
          We require a valid contact to provide the high-resolution,
          unwatermarked image, as this is a high-cost AI generation.
        </p>

        <div class="download-form-group" id="emailGroup">
          <label>Email Address</label>
          <input
            type="email"
            id="downloadEmail"
            placeholder="your.email@example.com"
          />
          <div class="download-error-message">
            Please enter a valid email address
          </div>
        </div>

        <div class="download-form-group" id="phoneGroup">
          <label> Phone Number</label>
          <input id="phone" type="tel" placeholder="Phone Number" />

          <div class="download-error-message">
            Please enter a valid  phone number
          </div>
        </div>

        <!-- <button class="download-submit-btn" id="downloadSubmitBtn" onclick="downloadPDF()">
          Download Mockup
        </button> -->
        <!-- BUTTON ROW -->
<div class="action-btn-row">

  <button class="download-submit-btn" id="downloadSubmitBtn" onclick="downloadPDF()">
    Download Mockup
  </button>

  <button class="add-to-cart-btn" onclick="addToCart()">
    <i class="bi bi-cart"></i> Add to Cart
  </button>

</div>


        <p class="download-disclaimer">
          Your information will be used for verification and contact purposes
          only.
        </p>
      </div>
    </div>
  </div>

    <canvas id="watermarkCanvas" style="display: none;"></canvas>
    
    <script>
      
    // =========================================================================
    // 1. GLOBAL STATE AND MOCK DATA
    // =========================================================================
     let selectedProduct = '';
     let selectedSubProduct = ''; 
     let selectedColor = ''; // Default color: White
     let uploadedLogoBase64 = null;
     let uploadedLogoMimeType = null;
     // ... existing global variables ...
    let currentMockupId = null; 
    let currentChatId = null;
    const mockupStorage = {}; // Ensure this is defined globally

    // üë§ USER IDENTITY MANAGEMENT
    // Check if user has an ID, if not, generate one
    let appUserId = localStorage.getItem('app_user_id');
    if (!appUserId) {
        appUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('app_user_id', appUserId);
    }
    console.log("Logged in as:", appUserId);
    
    
    // UI Elements
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const generateMockupBtn = document.getElementById('generateMockupBtn');
    const mockupLoadingSpinner = document.getElementById('mockupLoadingSpinner');
    const productSelector = document.getElementById('productSelector');
    const subOptionSection = document.getElementById('subOptionSection');
    const subOptionSelector = document.getElementById('subOptionSelector');
    const logoUpload = document.getElementById('logoUpload');
    const logoPreview = document.getElementById('logoPreview');
    const uploadButtonText = document.getElementById('uploadButtonText');
    const downloadModal = document.getElementById('downloadModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const downloadSubmitBtn = document.getElementById('downloadSubmitBtn');
    const downloadEmail = document.getElementById('downloadEmail');
    const downloadPhone = document.getElementById('downloadPhone');
    
    // Color Elements 
    const openColorPaletteBtn = document.getElementById('openColorPaletteBtn'); 
    const colorPalette = document.getElementById('colorPalette'); // Swatches container
    const selectedColorIndicator = document.getElementById('selectedColorIndicator');

    // New Chat Element
    const newChatBtn = document.getElementById('newChatBtn');
    
    

    const chatHistory = []; 

    // =========================
// CHAT HISTORY MANAGEMENT
// =========================
// currentChatId already declared above

// // Updated loadChatHistory
// async function loadChatHistory() {
//     try {
//         const res = await fetch('/chats', {
//             headers: { 'X-User-ID': appUserId } // üëà Send User ID
//         });
//         if (!res.ok) throw new Error("Failed to fetch chats");

//         const chats = await res.json();
//         const list = document.getElementById('chatHistoryList');
        
//         // Clear current list
//         list.innerHTML = '';

//         if (chats.length === 0) {
//             list.innerHTML = '<div style="padding:10px; color:#777; font-size:0.85em; text-align:center;">No history yet</div>';
//             return;
//         }

//         chats.forEach(chat => {
//             const item = document.createElement('div');
//             item.className = 'chat-item';
            
//             // Highlight if this is the active chat
//             if (typeof currentChatId !== 'undefined' && chat.id === currentChatId) {
//                 item.classList.add('selected');
//             }

//             // Simple Date Formatting
//             const date = new Date(chat.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });

//             item.innerHTML = `
//                 <div class="chat-left" style="width:100%">
//                    <div style="display:flex; justify-content:space-between; align-items:center;">
//                         <span class="chat-title" style="font-weight:500; color:#2e5c2e;">${chat.title || 'Untitled Chat'}</span>
//                         <small style="color:#888; font-size:0.7em;">${date}</small>
//                    </div>
//                 </div>
//             `;

//             // Load chat on click
//             item.onclick = () => loadChat(chat.id);

//             list.appendChild(item);
//         });
        
//         // Optional: Automatically open the list if there are chats
//         // list.classList.add('open'); 

//     } catch (error) {
//         console.error("Error loading history:", error);
//     }
// }

async function loadChatHistory() {
    try {
        const res = await fetch('/chats', {
            headers: { 'X-User-ID': appUserId } // üëà Send User ID
        });
        if (!res.ok) throw new Error("Failed to fetch chats");

        const chats = await res.json();
        
        // Target both Desktop and Mobile lists
        const list = document.getElementById('chatHistoryList');
        const mobileList = document.getElementById('mobileHistoryList');
        
        // Clear current lists
        list.innerHTML = '';
        if(mobileList) mobileList.innerHTML = '';

        if (chats.length === 0) {
            const emptyMsg = '<div style="padding:10px; color:#777; font-size:0.85em; text-align:center;">No history yet</div>';
            list.innerHTML = emptyMsg;
            if(mobileList) mobileList.innerHTML = emptyMsg;
            return;
        }

        chats.forEach(chat => {
            // Create Desktop Item
            const item = document.createElement('div');
            item.className = 'chat-item';
            
            if (typeof currentChatId !== 'undefined' && chat.id === currentChatId) {
                item.classList.add('selected');
            }

            const date = new Date(chat.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });

            item.innerHTML = `
                <div class="chat-left" style="width:100%">
                   <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="chat-title" style="font-weight:500; color:#2e5c2e;">${chat.title || 'Untitled Chat'}</span>
                        <small style="color:#888; font-size:0.7em;">${date}</small>
                   </div>
                </div>
            `;

            item.onclick = () => loadChat(chat.id);
            list.appendChild(item);

            // Create Mobile Item (Clone logic)
            if (mobileList) {
                const mobileItem = item.cloneNode(true);
                // Re-attach click event for mobile specifically
                mobileItem.onclick = () => {
                    loadChat(chat.id);
                    // Close the dropdown after selection
                    document.getElementById('mobileHistoryDropdown').classList.remove('open');
                };
                mobileList.appendChild(mobileItem);
            }
        });
        
    } catch (error) {
        console.error("Error loading history:", error);
    }
}

document.getElementById('newChatBtn').addEventListener('click', async () => {
    // 1. Clear UI
    document.getElementById('chatMessages').innerHTML = '';
    currentChatId = null;
    chatHistory.length = 0; // Clear local history array
    
    // 2. Add Welcome Message
    addMessage('ai', "Hello! I'm your AI Packaging Designer. Start by selecting a product...");

    // 3. Create the new session in DB immediately
    await createNewChatSession();
});
// async function loadChat(id) {
//     currentChatId = id;
//     const res = await fetch(`/chats/${id}`);
//     const messages = await res.json();
//     const container = document.getElementById('chatMessages');
//     container.innerHTML = '';
//     messages.forEach(msg => addMessageToUI(msg.content, msg.role));
// }

// async function loadChat(id) {
//     currentChatId = id;

//     // Highlight the selected chat
//     document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('selected'));
//     const items = document.querySelectorAll('.chat-item');
// let selectedItem = null;

// items.forEach(item => {
//     if (item.onclick && item.onclick.toString().includes(id)) {
//         selectedItem = item;
//     }
// });

// if (selectedItem) selectedItem.classList.add('selected');

   

//     // Load messages
//     const res = await fetch(`/chats/${id}`);
//     const messages = await res.json();
//     const container = document.getElementById('chatMessages');
//     container.innerHTML = '';

//     messages.forEach(msg => {
//         addMessageToUI(msg.content, msg.role, msg.image);
//     });
// }


async function loadChat(id) {
    currentChatId = id;

    // Highlight selected chat
    document.querySelectorAll('.chat-item').forEach(i => i.classList.remove('selected'));
    const items = document.querySelectorAll('.chat-item');
    let selectedItem = null;

    items.forEach(item => {
        if (item.onclick && item.onclick.toString().includes(id)) {
            selectedItem = item;
        }
    });

    if (selectedItem) selectedItem.classList.add('selected');

    // ===============================
    // üîÑ ADD THIS PART (CONTEXT RESTORE)
    // ===============================
    try {
        const contextRes = await fetch(`/chats/${id}/context`);
        const contextData = await contextRes.json();

        if (contextData.status === 'ok') {
            selectedProduct = contextData.product;
            selectedColor = contextData.color;

            // Restore generated image
            if (contextData.generated_image) {
                const img = document.getElementById('productDisplay');
                img.src = contextData.generated_image;
                img.style.display = 'block';
                img.style.opacity = 1;
            }

            // Update UI
            if (typeof renderProducts === 'function') renderProducts();
            if (typeof updateSubOptions === 'function') updateSubOptions();
            if (typeof updateColorDisplay === 'function') updateColorDisplay();

            console.log("‚úÖ Chat context restored");
        }
    } catch (err) {
        console.error("‚ùå Context restore failed", err);
    }

    // ===============================
    // üì© LOAD CHAT MESSAGES (OLD CODE)
    // ===============================
    const res = await fetch(`/chats/${id}`);
    const messages = await res.json();
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    messages.forEach(msg => {
        addMessageToUI(msg.content, msg.role, msg.image);
    });
}


async function sendMessage(content, role='user') {
    // 1. Create a chat if it doesn't exist
    if (!currentChatId) {
        await createNewChatSession(); // Call helper function
    }

    // 2. Save message
    await fetch(`/chats/${currentChatId}/message`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}, // No User ID needed here, Chat ID handles it
        body: JSON.stringify({ content, role })
    });

    // üß† Smart title update: if this is the first user message, set it as title
    if (role === 'user') {
        const titleSnippet = content.length > 40 ? content.substring(0, 40) + "..." : content;
        await fetch(`/chats/${currentChatId}/title`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title: titleSnippet })
        });
        loadChatHistory(); // refresh sidebar with new title
    }
}
// üÜï Helper function to ensure consistent chat creation
async function createNewChatSession() {
    const res = await fetch('/chats', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-User-ID': appUserId // üëà Associate new chat with this user
        },
        body: JSON.stringify({ title: 'New Design Chat' })
    });
    const data = await res.json();
    currentChatId = data.id;
    
    // Refresh the history list so the new chat appears in the sidebar immediately
    loadChatHistory(); 
    return currentChatId;
}

// sendChatBtn.addEventListener('click', async () => {
//     const text = chatInput.value.trim();
//     if (!text) return;
//     addMessageToUI(text, 'user');
//     await sendMessage(text, 'user');
//     chatInput.value = '';
// });

sendChatBtn.addEventListener('click', async () => {
    const text = chatInput.value.trim();
    if (!text) return;

    // 1Ô∏è‚É£ Show and save the user's message
    
    await sendMessage(text, 'user');
    chatInput.value = '';

    // 2Ô∏è‚É£ Call Gemini API (your existing code)
    const response = await fetch(GEMINI_IMAGE_API_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "x-goog-api-key": API_KEY,
        },
        body: JSON.stringify({
            contents: [{ role: "user", parts: [{ text }] }],
        }),
    });

    const data = await response.json();
    

    // Extract Gemini‚Äôs text and image response
    const aiTextResponse = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Here‚Äôs your mockup:";
    const generatedImageUrl = data?.candidates?.[0]?.content?.parts?.[1]?.inline_data?.data
        ? "data:image/png;base64," + data.candidates[0].content.parts[1].inline_data.data
        : null;

    // 3Ô∏è‚É£ Show Gemini‚Äôs reply in chat
    addMessageToUI(botReplyText,aiTextResponse, 'assistant', generatedImageUrl);

    // üíæ Save assistant reply and image to DB
await fetch(`/chats/${currentChatId}/message`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
        role: "assistant",
        content: botReplyText || "Here's your generated mockup:",
        image: generatedImage || null
    })
});




    // 4Ô∏è‚É£ Save Gemini‚Äôs reply to DB (this is the new part)
    await fetch(`/chats/${currentChatId}/message`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            role: 'assistant',
            content: aiTextResponse,
            image: generatedImageUrl
        })
    });
});



// function addMessageToUI(content, role) {
//     const div = document.createElement('div');
//     div.className = `message-bubble ${role}`;

//     // Check if content includes image marker
//     if (content.includes('[IMAGE]')) {
//         const [textPart, imagePart] = content.split('[IMAGE]');
//         div.innerHTML = `<span class="message-content">${textPart}</span>`;
//         if (imagePart) {
//             const img = document.createElement('img');
//             img.src = imagePart.trim();
//             img.className = 'message-image';
//             div.appendChild(img);
//         }
//     } else {
//         div.innerHTML = `<span class="message-content">${content}</span>`;
//     }

//     document.getElementById('chatMessages').appendChild(div);
// }

function addMessageToUI(content, role, image = null) {
    const div = document.createElement('div');
    div.className = `message-bubble ${role}`;

    // Add text content
    if (content) {
        const textSpan = document.createElement('span');
        textSpan.className = 'message-content';
        textSpan.textContent = content;
        div.appendChild(textSpan);
    }

    // Add image (if exists)
    if (image) {
        const img = document.createElement('img');
        img.src = image;
        img.className = 'message-image';
        div.appendChild(img);
    }

    document.getElementById('chatMessages').appendChild(div);
}



// Load previous chats when page loads
window.addEventListener('load', loadChatHistory);

    
    // The core color list (swatches)
    
    // The core color list (swatches)
   // ====================================================================
// üé® COLOR PALETTE - SAFE INTEGRATION (No Conflicts)
// ====================================================================

(function() {
    'use strict';
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initColorPalette);
    } else {
        initColorPalette();
    }
    
    function initColorPalette() {
        console.log("üé® Initializing color palette...");
        
        // Elements
        const openBtn = document.getElementById('openColorPaletteBtn');
        const dropdown = document.getElementById('colorDropdownMenu');
        const icon = document.getElementById('colorDropdownIcon');
        const indicator = document.getElementById('selectedColorIndicator');
        const swatchGrid = document.getElementById('colorSwatchGrid');
        const squarePalette = document.getElementById('squareColorPalette');
        const searchInput = document.getElementById('colorSearchInput');
        const clearBtn = document.getElementById('clearSearchBtn');
        const resultCount = document.getElementById('searchResultCount');
        
        // Check if elements exist
        if (!openBtn || !dropdown) {
            console.error("‚ùå Color palette elements not found!");
            return;
        }
        
        console.log("‚úÖ All elements found");
        
        // Colors data
        const quickColors = [
            { hex: '#FFFFFF', name: 'White' },
            { hex: '#000000', name: 'Black' },
            { hex: '#FF0000', name: 'Red' },
            { hex: '#00FF00', name: 'Lime' },
            { hex: '#0000FF', name: 'Blue' },
            { hex: '#FFFF00', name: 'Yellow' },
            { hex: '#FF00FF', name: 'Magenta' },
            { hex: '#00FFFF', name: 'Cyan' },
            { hex: '#FFA500', name: 'Orange' },
            { hex: '#800080', name: 'Purple' },
            { hex: '#FFC0CB', name: 'Pink' },
            { hex: '#A52A2A', name: 'Brown' },
            { hex: '#808080', name: 'Gray' },
            { hex: '#FFD700', name: 'Gold' },
            { hex: '#C0C0C0', name: 'Silver' },
            { hex: '#8B4513', name: 'Saddle Brown' },
            { hex: '#006400', name: 'Dark Green' },
            { hex: '#00008B', name: 'Dark Blue' },
            { hex: '#8B0000', name: 'Dark Red' },
            { hex: '#FF6347', name: 'Tomato' },
            { hex: '#4682B4', name: 'Steel Blue' },
            { hex: '#D2691E', name: 'Chocolate' },
            { hex: '#FF1493', name: 'Deep Pink' },
            { hex: '#00CED1', name: 'Dark Turquoise' },
            { hex: '#9370DB', name: 'Medium Purple' },
            { hex: '#20B2AA', name: 'Light Sea Green' },
            { hex: '#FF4500', name: 'Orange Red' },
            { hex: '#2E8B57', name: 'Sea Green' },
            { hex: '#CD853F', name: 'Peru' },
            { hex: '#BC8F8F', name: 'Rosy Brown' }
        ];
        
        // HSL to Hex
        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
        }
        
        // Update indicator
        function updateIndicator(hex) {
            if (!indicator) return;
            
            if (hex === 'None') {
                indicator.style.backgroundColor = '#f0f0f0';
                indicator.innerText = "?";
                indicator.style.color = "#999";
                indicator.style.border = "2px dashed #ccc";
            } else {
                indicator.innerText = "";
                indicator.style.backgroundColor = hex;
                indicator.style.border = "2px solid #555";
                selectedColor = hex; // Update global variable
            }
        }
        
        // Close dropdown
        function closeDropdown() {
            dropdown.style.display = 'none';
            openBtn.classList.remove('active');
            if (icon) icon.style.transform = 'rotate(0deg)';
        }
        
        // Render swatches
        function renderSwatches() {
            if (!swatchGrid) return;
            
            swatchGrid.innerHTML = '';
            
            quickColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color.hex;
                swatch.setAttribute('data-color', color.hex);
                swatch.setAttribute('data-name', color.name);
                swatch.title = `${color.name} - ${color.hex}`;
                
                if (selectedColor === color.hex) {
                    swatch.classList.add('selected');
                }
                
                swatch.addEventListener('click', function() {
                    updateIndicator(color.hex);
                    document.querySelectorAll('.color-swatch, .square-color-cell').forEach(s => {
                        s.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    closeDropdown();
                });
                
                swatchGrid.appendChild(swatch);
            });
            
            console.log("‚úÖ Swatches rendered:", quickColors.length);
        }
        
        // Generate square palette
        function generateSquarePalette() {
            if (!squarePalette) return;
            
            squarePalette.innerHTML = '';
            
            const hueSteps = 20;
            const lightnessSteps = 10;
            
            for (let l = 0; l < lightnessSteps; l++) {
                const lightness = 95 - (l * 9);
                
                for (let h = 0; h < hueSteps; h++) {
                    const hue = (h * 360) / hueSteps;
                    let saturation = l === 0 ? 20 : l < 3 ? 60 : 100;
                    
                    const hex = hslToHex(hue, saturation, lightness);
                    createCell(hex);
                }
            }
            
            // Grayscale
            for (let g = 0; g < 20; g++) {
                const gray = Math.round((g / 19) * 255);
                const hex = `#${gray.toString(16).padStart(2, '0').repeat(3)}`.toUpperCase();
                createCell(hex);
            }
            
            console.log("‚úÖ Square palette generated");
        }
        
        function createCell(hex) {
            const cell = document.createElement('div');
            cell.className = 'square-color-cell';
            cell.style.backgroundColor = hex;
            cell.setAttribute('data-color', hex);
            cell.title = hex;
            
            if (selectedColor === hex) {
                cell.classList.add('selected');
            }
            
            cell.addEventListener('click', function() {
                updateIndicator(hex);
                document.querySelectorAll('.square-color-cell, .color-swatch').forEach(c => {
                    c.classList.remove('selected');
                });
                this.classList.add('selected');
                closeDropdown();
            });
            
            squarePalette.appendChild(cell);
        }
        
        // Toggle dropdown
        openBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isOpen = dropdown.style.display === 'block';
            
            console.log("Button clicked! Opening:", !isOpen);
            
            if (isOpen) {
                closeDropdown();
            } else {
                dropdown.style.display = 'block';
                openBtn.classList.add('active');
                if (icon) icon.style.transform = 'rotate(180deg)';
                
                setTimeout(() => {
                    renderSwatches();
                    generateSquarePalette();
                }, 50);
            }
        });
        
        // Close on outside click
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target) && !openBtn.contains(e.target)) {
                closeDropdown();
            }
        });
        
        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (clearBtn) {
                    clearBtn.style.display = query ? 'block' : 'none';
                }
                
                if (!query) {
                    document.querySelectorAll('.square-color-cell, .color-swatch').forEach(el => {
                        el.classList.remove('hidden');
                    });
                    if (resultCount) resultCount.style.display = 'none';
                    return;
                }
                
                let matches = 0;
                
                document.querySelectorAll('.square-color-cell').forEach(cell => {
                    const hex = cell.getAttribute('data-color').toLowerCase();
                    if (hex.includes(query)) {
                        cell.classList.remove('hidden');
                        matches++;
                    } else {
                        cell.classList.add('hidden');
                    }
                });
                
                document.querySelectorAll('.color-swatch').forEach(swatch => {
                    const hex = swatch.getAttribute('data-color').toLowerCase();
                    const name = swatch.getAttribute('data-name').toLowerCase();
                    if (hex.includes(query) || name.includes(query)) {
                        swatch.classList.remove('hidden');
                        matches++;
                    } else {
                        swatch.classList.add('hidden');
                    }
                });
                
                if (resultCount) {
                    resultCount.style.display = 'block';
                    resultCount.textContent = `Found: ${matches} color${matches !== 1 ? 's' : ''}`;
                }
            });
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input'));
                    searchInput.focus();
                }
            });
        }
        
        console.log("‚úÖ Color palette system ready!");
    }
    
})()




    

    // NOTE: allProducts data remains unchanged
    const allProducts = [
        { 
            id: 'paper_cup', 
            name: 'Paper Cup', 
            img: "{{ url_for('static', filename='Paper_Cup.jpeg') }}", 
            product_url: 'https://your_website.com/cups/paper-cup-single-double-wall', 
            default_sub_id: 'single_wall',
            subOptions: [
                { id: 'single_wall', name: 'Single Wall', img: "{{ url_for('static', filename='Single_wall_cup.jpeg') }}" }, 
                { id: 'double_wall', name: 'Double Wall', img: "{{ url_for('static', filename='double_wall_cup.jpeg') }}" }
            ] 
        },
        { 
            id: 'paper_bag', 
            name: 'Paper Bag', 
            img: "{{ url_for('static', filename='Paper_Bag.webp') }}", 
            product_url: 'https://your-website.com/bags/twisted-flat-handle', 
            default_sub_id: 'flat',
            subOptions: [
                {id: 'flat', name: 'Flat Handle', img: "{{ url_for('static', filename='White_Paper_Bag_Flat.png') }}"}, 
                 {id: 'k_paper_bag_twisted', name: 'Craft color bag with twisted Handle', img: "{{ url_for('static', filename='k_paper_bag_twisted.png') }}"},
                {id: 'white_twisted', name: 'Twisted Handle', img: "{{ url_for('static', filename='White_Paper_Bag_Twisted.png') }}"},
                {id: 'k_paper_bag_flat', name: 'Craft color bag with flat Handle', img: "{{ url_for('static', filename='k_paper_bag_flat.png') }}"},
                
            ] 
        },
        { 
            id: 'paper_bowl', 
            name: 'Paper Bowl', 
            img: "{{ url_for('static', filename='Paper_Bowl.jpg') }}", 
            product_url: 'https://your-website.com/bowls/with-without-lid', 
            // default_sub_id: 'with_lid',
            // subOptions: [
            //     {id: 'with_lid', name: 'With Lid', img: "{{ url_for('static', filename='Paper_Bowl_Lid.jpg') }}"}, 
            //     {id: 'without_lid', name: 'Without Lid', img: "{{ url_for('static', filename='Paper_Bowl_NoLid.jpg') }}"}
            // ] 
        },
        { id: 'wrapping_paper', name: 'Wrapping Paper', img: "{{ url_for('static', filename='wrapping_paper.jpg') }}", product_url: 'https://your-website.com/wraps/food-packaging', default_sub_id: null, subOptions: [] },
        { id: 'paper_napkin', name: 'Paper Napkin', img: "{{ url_for('static', filename='paper_napkin.jpg') }}", product_url: 'https://your-website.com/napkins/custom-printed', default_sub_id: null, subOptions: [] },
        { 
            id: 'Meal_Box', 
            name: 'Meal Box', 
            img: "{{ url_for('static', filename='Meal_Box.png') }}", 
            product_url: 'https://your-website.com/mealboxes/meal-box', 
            //default_sub_id: 'one_compartment',
            //subOptions: [
              //  {id: 'one_compartment', name: '1 Compartment', img: "{{ url_for('static', filename='Meal_Box_1C.png') }}"}, 
              //  {id: 'two_compartments', name: '2 Compartments', img: "{{ url_for('static', filename='Meal_Box_2C.png') }}"}
            //] 
        },

    

    // { 
    //         id: 'Pizza_Box', 
    //         name: 'Pizza Box', 
    //         img: "{{ url_for('static', filename='pizza_box.jpeg') }}", 
    //         product_url: 'https://your_website.com/pizza/pizza-box-white-triangular-box', 
    //         default_sub_id: 'pizza_box',
    //         subOptions: [
    //             { id: 'white_pizza_box', name: 'white pizza box', img: "{{ url_for('static', filename='white_pizza_box.jpeg') }}" }, 
    //             { id: 'triangular_pizza_box', name: 'Triangular pizza box', img: "{{ url_for('static', filename='triangular_pizza_box.jpeg') }}" }
    //         ] 
    //     },

    { 
            id: 'pizza_box', 
            name: 'Pizza Box', 
            img: "{{ url_for('static', filename='pizza_box.jpeg') }}", 
            product_url: 'https://your_website.com/whitepizzabox/pizza-box', 
            default_sub_id: 'pizza_box',
              subOptions: [
                { id: 'triangular_pizza_box', name: 'Triangular Pizza Box', img: "{{ url_for('static', filename='triangular_pizza_box.jpeg') }}" }, 
                { id: 'white_pizza_box', name: 'White Pizza Box', img: "{{ url_for('static', filename='white_pizza_box.jpeg') }}" }
                
              ] 
        },



        { 
            id: 'roll_box', 
            name: 'Roll Box', 
            img: "{{ url_for('static', filename='roll_box.png') }}", 
            product_url: 'https://your_website.com/rollbox/roll-box', 
            default_sub_id: 'roll_locking_box',
              subOptions: [
                { id: 'roll_locking_box', name: 'Roll Locking Box', img: "{{ url_for('static', filename='roll_locking_box.png') }}" }, 
                { id: 'roll_sliding_box', name: 'Roll Sliding Box', img: "{{ url_for('static', filename='roll_sliding_box.png') }}" },
                { id: 'roll_box', name: 'Roll Box', img: "{{ url_for('static', filename='roll_box.png') }}" }
              ] 
        },

         { 
            id: 'noodle_pasta_box', 
            name: 'noodle pasta Box', 
            img: "{{ url_for('static', filename='noodle_pasta_box.png') }}", 
            product_url: 'https://your_website.com/pasta-box/noodle-box', 
            // default_sub_id: 'sandwich_box2',
            //  subOptions: [
            //    { id: 'sandwich_box2', name: 'Sandwich Box 2', img: "{{ url_for('static', filename='sandwich_box2.png') }}" }, 
            // //     { id: 'double_wall', name: 'Double Wall', img: "{{ url_for('static', filename='Double_wall_cup.jpeg') }}" }
            //   ] 
        },


        { 
            id: 'sandwich_box', 
            name: 'sandwich Box', 
            img: "{{ url_for('static', filename='sandwich_box.png') }}", 
            product_url: 'https://your_website.com/sandwichbox/sandwich-box', 
            default_sub_id: 'sandwich_box2',
             subOptions: [
               { id: 'sandwich_box2', name: 'Sandwich Box 2', img: "{{ url_for('static', filename='sandwich_box2.png') }}" }, 
               { id: 'sandwich_box', name: 'sandwich box', img: "{{ url_for('static', filename='sandwich_box.png') }}" }
              ] 
        },

        { 
            id: 'burger_box', 
            name: 'Burger Box', 
            img: "{{ url_for('static', filename='burger_box.jpeg') }}", 
            product_url: 'https://your_website.com/cups/burger-box', 
            default_sub_id: 'burger_box',
            // subOptions: [
            //     { id: 'single_wall', name: 'Single Wall', img: "{{ url_for('static', filename='Single_wall_cup.jpeg') }}" }, 
            //     { id: 'double_wall', name: 'Double Wall', img: "{{ url_for('static', filename='Double_wall_cup.jpeg') }}" }
            // ] 
        },

        { 
            id: 'popcorn_holder', 
            name: 'Popcorn holder', 
            img: "{{ url_for('static', filename='popcorn_holder.jpeg') }}", 
            product_url: 'https://your_website.com/popcorn/popcorn_holder', 
            default_sub_id: 'popcorn_holder',
             subOptions: [
              { id: 'popcorn_holder2', name: 'Popcorn holder 2', img: "{{ url_for('static', filename='popcorn_holder2.png') }}" },
              {id: 'fries_holder', 
            name: 'Fries Holder', 
            img: "{{ url_for('static', filename='fries_holder.jpeg') }}", } 
            //     { id: 'double_wall', name: 'Double Wall', img: "{{ url_for('static', filename='Double_wall_cup.jpeg') }}" }
             ] 
        },

        { 
            id: 'white_paper_stand_up_bag', 
            name: 'white paper stand up bag', 
            img: "{{ url_for('static', filename='white_paper_stand_up_bag.png') }}", 
            product_url: 'https://your_website.com/standupbag/paper-standup-bag', 
            default_sub_id: 'paper_stand_up_bag',
             subOptions: [
             { id: 'paper_stand_up_bag', name: 'Paper Stand-up Bag', img: "{{ url_for('static', filename='paper_stand_up_bag.png') }}" }, 
             { id: 'white_paper_stand_up_bag', name: 'white paper stand up bag', img: "{{ url_for('static', filename='white_paper_stand_up_bag.png') }}" }
             ] 
        },


         
        { 
            id: 'paper_tray', 
            name: 'paper_tray', 
            img: "{{ url_for('static', filename='paper_tray.png') }}", 
            product_url: 'https://your_website.com/papertray/paper-tray', 
            default_sub_id: 'paper_tray',
            //  subOptions: [
            //   { id: 'popcorn_holder2', name: 'Popcorn holder 2', img: "{{ url_for('static', filename='popcorn_holder2.png') }}" }, 
            // //     { id: 'double_wall', name: 'Double Wall', img: "{{ url_for('static', filename='Double_wall_cup.jpeg') }}" }
            //  ] 
        },


        { 
            id: 'k pastry box', 
            name: 'k pastry box ', 
            img: "{{ url_for('static', filename='k pastry box.png') }}", 
            product_url: 'https://your_website.com/pstrybox/pastry-holder', 
            default_sub_id: 'k pastry box',
            subOptions: [
            { id: 'pastry_box_with_handle', name: 'Pastry Box', img: "{{ url_for('static', filename='pastry_box_with_handle.jpeg') }}" },
            { id: 'k pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='k pastry holder.png') }}" },
            { id: 'pastry holder 2', name: 'Pastry holder 2', img: "{{ url_for('static', filename='pastry holder 2.jpeg') }}" }, 
            { id: 'pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='pastry holder.jpeg') }}" }

            ] 
        },

         { 
            id: 'flat_box', 
            name: 'Flat box ', 
            img: "{{ url_for('static', filename='flat_box.png') }}", 
            product_url: 'https://your_website.com/flatebox/flatbox', 
            default_sub_id: 'flat_box',
             subOptions: [
             { id: 'flat_box2', name: 'Flat Box 2', img: "{{ url_for('static', filename='flat_box2.png') }}" },
            // { id: 'k pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='k pastry holder.png') }}" },
            // { id: 'pastry holder 2', name: 'Pastry holder 2', img: "{{ url_for('static', filename='pastry holder 2.jpeg') }}" }, 
            // { id: 'pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='pastry holder.jpeg') }}" }

            ] 
        },
         
        { 
            // id: 'cake_box', 
            // name: 'Cake Box', 
            // img: "{{ url_for('static', filename='cake_box.jpeg') }}", 
            // product_url: 'https://your_website.com/subcakebox/cakeboxs', 
            // default_sub_id: 'cake_box',
            id: 'handle_cake_box', 
            name: ' Handle Cake Box', 
            img: "{{ url_for('static', filename='handle_cake_box.jpeg') }}", 
            product_url: 'https://your_website.com/subcakebox/cakeboxs', 
            default_sub_id: 'handle_cake_box',
             subOptions: [
            //  { id: 'cake_box_window', name: 'Cake Box With Window', img: "{{ url_for('static', filename='cake_box_window.jpeg') }}" }, 
             { id: 'cake_box', name: 'Cake Box', img: "{{ url_for('static', filename='cake_box.jpeg') }}" },
              { id: 'cake_box2', name: 'Cake Box 2', img: "{{ url_for('static', filename='cake_box2.png') }}" }
             ] 
        },

        { 
            id: 'Biryani_box2', 
            name: 'Briyani box 2 ', 
            img: "{{ url_for('static', filename='biryani_box2.png') }}", 
            product_url: 'https://your_website.com/box/biryanibox', 
            default_sub_id: 'biryani_box2',
             subOptions: [
             { id: 'biryani_box', name: 'biryani Box ', img: "{{ url_for('static', filename='biryani_box.jpeg') }}" },
            // { id: 'k pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='k pastry holder.png') }}" },
            // { id: 'pastry holder 2', name: 'Pastry holder 2', img: "{{ url_for('static', filename='pastry holder 2.jpeg') }}" }, 
            // { id: 'pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='pastry holder.jpeg') }}" }

            ] 
        },

        {
            id: 'ice cream box 2', 
            name: 'ice cream box 2 ', 
            img: "{{ url_for('static', filename='ice cream box 2.png') }}", 
            product_url: 'https://your_website.com/icecream/icecreambox', 
            default_sub_id: 'ice cream box 2',
             subOptions: [
             { id: 'ice cream box', name: 'Ice-cream Box ', img: "{{ url_for('static', filename='ice cream box.jpeg') }}" },
            // { id: 'k pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='k pastry holder.png') }}" },
            // { id: 'pastry holder 2', name: 'Pastry holder 2', img: "{{ url_for('static', filename='pastry holder 2.jpeg') }}" }, 
            // { id: 'pastry holder', name: 'Pastry Holder', img: "{{ url_for('static', filename='pastry holder.jpeg') }}" }

            ] 
        },

        { 
    id: 'chocolate_box', 
    name: 'Chocolate Box', 
    img: "{{ url_for('static', filename='chocolate_box.jpeg') }}", 
    default_sub_id: 'chocolate_box', // ‚úÖ Use an ID that exists in PRODUCT_MAP
    subOptions: [
        { id: 'chocolate_box2', name: 'Chocolate Box 2', img: "{{ url_for('static', filename='chocolate_box2.jpeg') }}" }, 
         //{ id: 'chocolate_box2', name: 'Chocolate Box 2', img: "{{ url_for('static', filename='chocolate_box2.jpeg') }}" }, 
        
        // ...
    ] 
},

//          { 
//             id: 'k pastry holder with handle', 
//             name: 'Pastry box With Handle 2', 
//             img: "{{ url_for('static', filename='k pastry holder with handle.png') }}", 
//             product_url: 'https://your_website.com/pastrybox/pastryboxs', 
//              default_sub_id: 'pastry_box_with_handle',
//              subOptions: [
//              { id: 'pastry holder', name: 'Singal Pastry Tray', img: "{{ url_for('static', filename='pastry holder.jpeg') }}" }, 
//              { id: 'pastry holder 2', name: 'Cake Box With Handle', img: "{{ url_for('static', filename='pastry holder 2.jpeg') }}" },
//              { id: 'k pastry holder', name: ' pastry holder', img: "{{ url_for('static', filename='k pastry holder.png') }}" },
//              { id: ' pastry box with handle', name: 'Pastry Box With Handle', img: "{{ url_for('static', filename='pastry_box_with_handle.jpeg') }}" }

//               ] 
//         },

        
    ];

    // =========================================================================
    // 2. RENDERING FUNCTIONS
    // =========================================================================

    function renderProducts() {
        productSelector.innerHTML = '';
        allProducts.forEach((product, index) => {
            const item = document.createElement('div');
            item.classList.add('product-item');
            if (product.id === selectedProduct) {
                item.classList.add('selected');
                selectedSubProduct = product.default_sub_id; 
            }
            item.setAttribute('data-id', product.id);
            item.setAttribute('data-name', product.name);
            item.innerHTML = `<img src="${product.img}" alt="${product.name}"><span style="display: none;">${product.name}</span>`;
            productSelector.appendChild(item);
        });
        updateSubOptions();
        attachProductListeners();
    }

    function updateSubOptions() {
        const product = allProducts.find(p => p.id === selectedProduct);
        subOptionSelector.innerHTML = '';

        if (!product || product.subOptions.length === 0) {
            subOptionSection.style.display = 'none';
            selectedSubProduct = null;
            return;
        }

        subOptionSection.style.display = 'block';
        
        product.subOptions.forEach(sub => {
            const item = document.createElement('div');
            item.classList.add('product-item', 'sub-option-item');
            if (sub.id === selectedSubProduct) {
                item.classList.add('selected');
            }
            item.setAttribute('data-id', sub.id);
            item.setAttribute('data-name', sub.name);
            item.innerHTML = `<img src="${sub.img}" alt="${sub.name}"><span>${sub.name}</span>`;
            subOptionSelector.appendChild(item);
        });
        attachSubOptionListeners();
    }

    // function renderColorSwatches() {
    //     colorPalette.innerHTML = ''; // Clear previous swatches
    //     availableColors.forEach(color => {
    //         const swatch = document.createElement('div');
    //         swatch.classList.add('color-swatch');
    //         swatch.style.backgroundColor = color.hex;
    //         swatch.setAttribute('data-color-hex', color.hex);
    //         swatch.setAttribute('title', color.name);

    //         if (color.hex === selectedColor) {
    //             swatch.classList.add('selected');
    //         }

    //         // For white and yellow colors, add an extra border to show it clearly
    //         if (color.hex === '#FFFFFF' || color.hex === '#FFFF00') {
    //             swatch.style.border = '2px solid #ccc';
    //         }
            
    //         swatch.onclick = function() {
    //             selectColor(color.hex);
    //         };

    //         colorPalette.appendChild(swatch);
    //     });
    // }

    // function selectColor(hex) {
    //     selectedColor = hex;
    //     selectedColorIndicator.style.backgroundColor = hex;
        
    //     // Update the selected state on the swatches
    //     document.querySelectorAll('.color-swatch').forEach(swatch => {
    //         swatch.classList.remove('selected');
    //     });
    //     const selectedSwatch = document.querySelector(`.color-swatch[data-color-hex="${hex}"]`);
    //     if (selectedSwatch) {
    //         selectedSwatch.classList.add('selected');
    //     }
        
    //     // Hide the palette after selection
    //     colorPalette.style.display = 'none';
    //     console.log("New selected color:", selectedColor);
    // }

    function renderColorSwatches() {
    colorPalette.innerHTML = ''; // Clear previous swatches

    availableColors.forEach(color => {
        let swatch;

        // üåü AI BUTTON instead of color circle
        if (color.hex === 'None') {
            swatch = document.createElement('button');
            swatch.classList.add('ai-color-btn');
            swatch.innerText = "AI Suggest";
            swatch.setAttribute('data-color-hex', 'None');
            // swatch.setAttribute('title', 'AI will suggest the best matching color');

            if (selectedColor === 'None') {
                swatch.classList.add('selected');
            }

            swatch.onclick = function () {
                selectColor('None');
            };

        } else {
            // üé® Normal color circle swatches
            swatch = document.createElement('div');
            swatch.classList.add('color-swatch');
            swatch.style.backgroundColor = color.hex;
            swatch.setAttribute('data-color-hex', color.hex);
            swatch.setAttribute('title', color.name);

            if (color.hex === selectedColor) {
                swatch.classList.add('selected');
            }

            // White & yellow visibility border
            if (color.hex === '#FFFFFF' || color.hex === '#FFFF00') {
                swatch.style.border = '2px solid #ccc';
            }

            swatch.onclick = function () {
                selectColor(color.hex);
            };
        }

        colorPalette.appendChild(swatch);
    });
}


function selectColor(hex) {
    selectedColor = hex;

    // Update color preview indicator
    if (hex === 'None') {
        selectedColorIndicator.style.backgroundColor = 'transparent';
        selectedColorIndicator.innerText = "AI";
        selectedColorIndicator.style.color = "#2ecc71";
        selectedColorIndicator.style.fontWeight = "700";
    } else {
        selectedColorIndicator.innerText = "";
        selectedColorIndicator.style.backgroundColor = hex;
    }

    // Remove all selected classes
    document.querySelectorAll('.color-swatch, .ai-color-btn')
        .forEach(s => s.classList.remove('selected'));

    // Highlight selected element
    const selectedSwatch =
        document.querySelector(`.color-swatch[data-color-hex="${hex}"]`) ||
        document.querySelector('.ai-color-btn[data-color-hex="None"]');

    if (selectedSwatch) {
        selectedSwatch.classList.add('selected');
    }

    // Close palette after choosing
    colorPalette.style.display = 'none';
    console.log("New selected color:", selectedColor);
}

    
    // Includes mockupId parameter to handle the generated image's identifier
    function addMessage(sender, content, imageUrl = null, mockupId = null) {
        if (sender === 'user') {
            chatHistory.push({ role: 'user', content: content });
        } else if (sender === 'ai') {
            if (content.trim()) {
                chatHistory.push({ role: 'model', content: content });
            }
        }

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message-bubble', sender);

        const contentSpan = document.createElement('span');
        contentSpan.classList.add('message-content');
        contentSpan.innerHTML = content.replace(/\n/g, '<br>'); 
        messageDiv.appendChild(contentSpan);

        if (imageUrl) {
            currentMockupId = mockupId; 
            
            const imgContainer = document.createElement('div');
            imgContainer.classList.add('image-container');
            
            const img = document.createElement('img');
            img.src = imageUrl;
            CURRENT_GENERATED_IMAGE = imageUrl;
            img.classList.add('message-image');
            img.alt = 'Generated Mockup Preview';
            
            imgContainer.appendChild(img);
            
            const downloadBtn = document.createElement('button');
            downloadBtn.classList.add('message-download-btn');
            downloadBtn.textContent = 'Download / Verification (High-Res)'; 
            
            downloadBtn.onclick = () => showDownloadModal(mockupId);
            
            imgContainer.appendChild(downloadBtn);
            
            messageDiv.appendChild(imgContainer); 
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight; 
    }

    function showLoading(element, text, spinnerElement) {
        element.disabled = true;
        element.innerHTML = `${text || 'Processing...'} <div class="loading-spinner" style="display: inline-block;"></div>`;
        if (spinnerElement) spinnerElement.style.display = 'inline-block';
    }

    function hideLoading(element, originalText, spinnerElement) {
        element.disabled = false;
        element.innerHTML = originalText;
        if (spinnerElement) spinnerElement.style.display = 'none';
    }

    
    // =========================================================================
    // 3. EVENT HANDLERS AND LISTENERS
    // =========================================================================
    
    function attachProductListeners() {
        productSelector.querySelectorAll('.product-item').forEach(item => {
            item.onclick = function() {
                productSelector.querySelector('.product-item.selected')?.classList.remove('selected');
                this.classList.add('selected');
                selectedProduct = this.getAttribute('data-id');
                
                const product = allProducts.find(p => p.id === selectedProduct);
                selectedSubProduct = product.default_sub_id;
                
                updateSubOptions();
            };
        });
    }

    function attachSubOptionListeners() {
        subOptionSelector.querySelectorAll('.product-item').forEach(item => {
            item.onclick = function() {
                subOptionSelector.querySelector('.product-item.selected')?.classList.remove('selected');
                this.classList.add('selected');
                selectedSubProduct = this.getAttribute('data-id');
            };
        });
    }
    
    // Select Color Button (Toggle Palette) Handler
    openColorPaletteBtn.onclick = function() {
        // Toggle the visibility of the color palette
        if (colorPalette.style.display === 'flex') {
            colorPalette.style.display = 'none';
        } else {
            colorPalette.style.display = 'flex';
        }
    };
    
    // Logo Upload Handler
    logoUpload.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (file.size > 8 * 1024 * 1024) {
            alert("File size exceeds 8MB limit.");
            logoUpload.value = "";
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            uploadedLogoBase64 = e.target.result.split(',')[1];
            uploadedLogoMimeType = file.type;
            
            if (file.type.includes('image') || file.type === 'application/pdf') {
                logoPreview.innerHTML = `<img src="${e.target.result}" alt="Logo Preview">`;
            } else {
                 logoPreview.innerHTML = `<span>File uploaded: ${file.name}</span>`;
            }

            uploadButtonText.textContent = 'Change Logo';
        };
        reader.readAsDataURL(file);
    };

    // // Chat Logic (Standard)
    // sendChatBtn.onclick = function() {
    //     const userMessage = chatInput.value.trim();
    //     if (!userMessage) return;

    //     addMessage('user', userMessage);
    //     chatInput.value = '';
        
    //     const currentProduct = allProducts.find(p => p.id === selectedProduct) || {name: 'packaging item'};
        
    //     sendChatBtn.disabled = true;
    //     chatInput.disabled = true;

    //     fetch('/send_chat', {
    //         method: 'POST',
    //         headers: { 'Content-Type': 'application/json' },
    //         body: JSON.stringify({
    //             history: chatHistory.slice(-10), 
    //             product_name: currentProduct.name,
    //             color: selectedColor 
    //         })
    //     })
    //     .then(response => response.json())
    //     .then(data => {
    //         if (data.error) {
    //             addMessage('ai', `[Chat Error] ${data.error}`);
    //         } else {
    //             addMessage('ai', data.message);
    //         }
    //     })
    //     .catch(error => {
    //         console.error('Chat API Error:', error);
    //         addMessage('ai', 'Sorry, I ran into a technical error. Please try again.');
    //     })
    //     .finally(() => {
    //         sendChatBtn.disabled = false;
    //         chatInput.disabled = false;
    //     });
    // };


    // =========================================================================
// REPLACE THE CHAT-RELATED JAVASCRIPT IN YOUR index.html WITH THIS CODE
// =========================================================================

// Chat Logic - Enhanced with proper error handling and history management
sendChatBtn.onclick = function() {
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;

    // Add user message to display
    addMessage('user', userMessage);
    chatInput.value = '';
    
    const currentProduct = allProducts.find(p => p.id === selectedProduct) || {name: 'packaging item'};
    
    // Disable input while processing
    sendChatBtn.disabled = true;
    chatInput.disabled = true;
    
    // Show typing indicator
    const typingIndicator = document.createElement('div');
    typingIndicator.classList.add('message-bubble');
    typingIndicator.innerHTML = '<span class="message-content">Typing...</span>';
    typingIndicator.id = 'typing-indicator';
    chatMessages.appendChild(typingIndicator);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    console.log('üì§ Sending chat request:', {
        product: currentProduct.name,
        color: selectedColor,
        historyLength: chatHistory.length,
        message: userMessage.substring(0, 50) + '...'
    });

    fetch('/send_chat', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            history: chatHistory,  // Send full chat history
            product_name: currentProduct.name,
            color: selectedColor 
        })
    })
    .then(response => {
        console.log('üì• Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Response data:', data);
        
        // Remove typing indicator
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
        
        if (data.error) {
            // Show error message if present
            addMessage('ai', `‚ö†Ô∏è ${data.message || data.error}`);
        } else if (data.message) {
            // Show AI response
            addMessage('ai', data.message);
        }
        else {
            // Unexpected response format
            addMessage('ai', 'Sorry, I received an unexpected response. Please try again.');

        }  
    })


    .catch(error => {
        console.error('‚ùå Chat API Error:', error);
        
        // Remove typing indicator
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
        
        addMessage('ai', '‚ùå Sorry, I ran into a technical error. Please check your internet connection and try again.');
    })
    .finally(() => {
        // Re-enable input
        sendChatBtn.disabled = false;
        chatInput.disabled = false;
        chatInput.focus();
    });
};

// Allow Enter key to send message
chatInput.onkeydown = function(e) {
    if (e.key === 'Enter' && !sendChatBtn.disabled) {
        e.preventDefault();
        sendChatBtn.click();
    }
};

// ======================================================
// üì± MOBILE SIDEBAR LOGIC (UPDATED WITH CLOSE BUTTON)
// ======================================================
const designerSidebar = document.getElementById('designer-sidebar');
const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
const mobileBackdrop = document.getElementById('mobile-backdrop');
const closeSidebarBtn = document.getElementById('closeSidebarBtn'); // ‚ùå NEW

function toggleMobileSidebar(forceOpen) {
    const isOpen = designerSidebar.classList.contains('open');
    const shouldOpen = (typeof forceOpen === 'boolean') ? forceOpen : !isOpen;

    if (shouldOpen) {
        designerSidebar.classList.add('open');
        mobileBackdrop.classList.add('visible');
        document.body.style.overflow = 'hidden';
    } else {
        designerSidebar.classList.remove('open');
        mobileBackdrop.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

// Hamburger button (already exists)
if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener('click', () => toggleMobileSidebar());
}

// Backdrop click (already exists)
if (mobileBackdrop) {
    mobileBackdrop.addEventListener('click', () => toggleMobileSidebar(false));
}

// ‚ùå NEW: Close button click
if (closeSidebarBtn) {
    closeSidebarBtn.addEventListener('click', () => toggleMobileSidebar(false));
}

// END MOBILE SIDEBAR LOGIC
// ======================================================

// Enhanced addMessage function with better history tracking
function addMessage(sender, content, imageUrl = null, mockupId = null) {
    // Add to chat history (for context in API calls)
    if (sender === 'user') {
        chatHistory.push({ role: 'user', content: content });
        console.log('üìù Added user message to history. Total:', chatHistory.length);
    } else if (sender === 'ai') {
        if (content.trim()) {
            chatHistory.push({ role: 'model', content: content });
            console.log('üìù Added AI response to history. Total:', chatHistory.length);
        }
    }

    


    // Create visual message bubble
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message-bubble', sender);

    const contentSpan = document.createElement('span');
    contentSpan.classList.add('message-content');
    contentSpan.innerHTML = content.replace(/\n/g, '<br>'); 
    messageDiv.appendChild(contentSpan);

    // Handle mockup images
    if (imageUrl) {
        currentMockupId = mockupId; 
        
        const imgContainer = document.createElement('div');
        imgContainer.classList.add('image-container');
        
        const img = document.createElement('img');
        img.src = imageUrl;
        CURRENT_GENERATED_IMAGE = imageUrl;
        img.classList.add('message-image');
        img.alt = 'Generated Mockup Preview';
        
        imgContainer.appendChild(img);
        
        const downloadBtn = document.createElement('button');
        downloadBtn.classList.add('message-download-btn');
        downloadBtn.textContent = 'Download / Verification (High-Res)'; 
        
        downloadBtn.onclick = () => showDownloadModal(mockupId);

        
//         imgContainer.appendChild(img);

// imgContainer.appendChild(downloadBtn);

// ADD CLICKABLE WEBSITE LINK
const link = document.createElement('div');
link.innerHTML = `
    <a href="https://www.greenwichpackaging.co.uk"
       target="_blank"
       style="
           display:block;
           text-align:center;
           margin-top:12px;
           margin-bottom:8px;
           font-weight:600;
           font-size:15px;
           color:#1a8f3f;
           text-decoration:none;
           transition:0.3s;
       "
       onmouseover="this.style.textDecoration='underline'; this.style.color='#0a6d2d';"
       onmouseout="this.style.textDecoration='none'; this.style.color='#1a8f3f';"
    >
        Visit Website: www.greenwichpackaging.co.uk
    </a>
`;
imgContainer.appendChild(link);
        
        imgContainer.appendChild(downloadBtn);
        
        messageDiv.appendChild(imgContainer); 
    }

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight; 
}

// Enhanced New Chat function with better history reset
function startNewChat() {
    console.log('üÜï Starting new chat. Clearing history...');
    
    // 1. Reset the chat history array
    chatHistory.length = 0; 
    
    // 2. Clear the message bubbles from the display
    chatMessages.innerHTML = ''; 
    
    // 3. Re-add the initial welcome message
    const initialMessageContent = "Hello! I'm your AI Packaging Designer. Start by selecting a product and a color on the left. Then tell me what design you'd like (e.g., \"Add a minimalist black pattern and the words 'Best Coffee'\").";
    addMessage('ai', initialMessageContent);
    
    // 4. Reset the current mockup ID
    currentMockupId = null; 
    
    // 5. Update history panel to reflect the new empty chat
    document.querySelectorAll('.history-item').forEach(item => {
        item.classList.remove('selected');
    });
    const currentChat = document.querySelector('.history-item');
    if (currentChat) {
        currentChat.classList.add('selected');
        currentChat.querySelector('p').textContent = 'Current Design Chat';
    }
    
    // 6. Provide user feedback
    console.log('‚úÖ Chat history cleared. Ready for new conversation.');
    
    // Focus on input
    chatInput.focus();
}

// Optional: Add chat history export function (useful for debugging)
function exportChatHistory() {
    const historyText = chatHistory.map(msg => 
        `${msg.role.toUpperCase()}: ${msg.content}`
    ).join('\n\n');
    
    console.log('üìã Current Chat History:\n', historyText);
    return historyText;
}

// Optional: Add function to check chat health
function checkChatHealth() {
    fetch('/health')
        .then(response => response.json())
        .then(data => {
            console.log('üè• Chat Health Check:', data);
            if (data.status !== 'healthy') {
                console.warn('‚ö†Ô∏è Some services are not working properly:', data.services);
            }
        })
        .catch(error => {
            console.error('‚ùå Health check failed:', error);
        });
}


// Initialize chat on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Chat system initialized');
    console.log('üìä Initial history length:', chatHistory.length);
    
    // Optional: Check backend health
    // checkChatHealth();
    
    // Focus on chat input
    chatInput.focus();


    
});



    // Example of the code we need to see from your index.html or chat.js file
async function sendChat(message) {
    // ...
    const response = await fetch('/send_chat', { /* ... */ });
    
    // ERROR IS LIKELY HERE:
    const data = await response.json(); 
    
    if (response.ok) {
        // This part is likely not running correctly
        displayMessage(data.reply, 'model');
    } else {
        // YOUR FRONTEND IS LIKELY HITTING THIS 'ELSE' BLOCK.
        displayError("Sorry, I ran into a technical error. Please try again.");
    }
}

    // chatInput.onkeydown = function(e) {
    //     if (e.key === 'Enter' && !sendChatBtn.disabled) {
    //         sendChatBtn.click();
    //     }
    // };
    
    // New Function: Clear chat history and reset chat state
    function startNewChat() {
        // 1. Reset the chat history array
        chatHistory.length = 0; 
        
        // 2. Clear the message bubbles from the display
        chatMessages.innerHTML = ''; 
        
        // 3. Re-add the initial welcome message (same content as the HTML initial message)
        const initialMessageContent = "Hello! I'm your AI Packaging Designer. Start by selecting a product and a color on the left. Then tell me what design you'd like (e.g., \"Add a minimalist black pattern and the words 'Best Coffee'\").";
        addMessage('ai', initialMessageContent);
        
        // 4. Reset the current mockup ID, as the old mockup is not part of this new chat
        currentMockupId = null; 
        
        // 5. Update history panel to reflect the new empty chat
        document.querySelectorAll('.history-item').forEach(item => {
            item.classList.remove('selected');
        });
        const currentChat = document.querySelector('.history-item');
        if (currentChat) {
             // For this mock, we just select the 'Current Design Chat' placeholder again.
             currentChat.classList.add('selected');
             currentChat.querySelector('p').textContent = 'Current Design Chat';
        }
        
        // 6. Provide user feedback in the chat
        
    }
    




    // üïí Restore previous chat history if available
const savedChat = localStorage.getItem("chatHistory");
if (savedChat) {
    const messages = JSON.parse(savedChat);
    messages.forEach(msg => addMessage(msg.role === 'user' ? 'user' : 'ai', msg.content));
    console.log(`üíæ Restored ${messages.length} messages from previous chat.`);
}

//     // =========================================================================
//     // 4. MOCKUP GENERATION (No Change)
//     // =========================================================================

//     generateMockupBtn.onclick = function() {
//         const designPrompt = chatHistory
//             .filter(msg => msg.role === 'user')
//             .map(msg => msg.content)
//             .join(' | ');

//         if (!selectedProduct) {
//             alert("Please select a product first.");
//             return;
//         }

//         const originalBtnText = generateMockupBtn.textContent;
//         showLoading(generateMockupBtn, 'Generating Image...', mockupLoadingSpinner);

//         const payload = {
//             product_name: selectedProduct,
//             sub_product_id: selectedSubProduct,
//             logo_b64: uploadedLogoBase64,
//             logo_mime_type: uploadedLogoMimeType,
//             design_prompt: designPrompt,
//             color: selectedColor 
//         };

//         // ‚úÖ Always store the prompt being used for this generation
//     window.currentGenerationPrompt = designPrompt && designPrompt.trim() !== ""
//         ? designPrompt.trim()
//         : "Default prompt";


//         fetch('/generate_image', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify(payload)
//         })
//         .then(response => response.json())
//         .then(async data => {
//             if (data.error) {
//                 addMessage('ai', `‚ùå Mockup Generation Failed: ${data.error}`);
//             } else if (data.image_b64) {
//                 const base64Image = `data:image/png;base64,${data.image_b64}`;
//                 const currentProduct = allProducts.find(p => p.id === selectedProduct) || {name: 'Your Product'};
//                 addMessage('ai', `üéâ Design is ready for your **${currentProduct.name}**! Review the preview below and click **'Download' to proceed** with verification.`, base64Image, 'MOCK_ID_' + Date.now() );
//                 // üß† Save generated prompt and logo URL for later download verification
// window.generatedMockup = {
//   prompt_used: designPrompt && designPrompt.trim() !== "" 
//     ? designPrompt 
//     : (chatHistory.length > 0 
//         ? chatHistory[chatHistory.length - 1].content 
//         : "Default prompt"),
//   logo_url: data.logo_drive_url || "",
//   product_name: selectedProduct || "N/A"
// };

// console.log("üß† Latest prompt saved for this mockup:", window.generatedPrompt);




//                 // üíæ Save assistant's image reply to backend chat history
// if (currentChatId) {
//     await fetch(`/chats/${currentChatId}/message`, {
//         method: "POST",
//         headers: { "Content-Type": "application/json" },
//         body: JSON.stringify({
//             role: "assistant",
//             content: `üéâ Design is ready for your ${currentProduct.name}!`,
//             image: base64Image
//         })
//     });
//     console.log("‚úÖ Saved mockup image to chat history");
// }
//             } else {
//                 addMessage('ai', 'Received an unexpected response from the mockup service.');
//             }
//             window.generatedPrompt = window.currentGenerationPrompt; // ‚úÖ Always latest


//         })
//         .catch(error => {
//             console.error('Mockup API Error:', error);
//             addMessage('ai', 'A network error occurred while generating the mockup. Check server logs.');
//         })
//         .finally(() => {
//             hideLoading(generateMockupBtn, originalBtnText, mockupLoadingSpinner);
//         });
//     };
// =========================================================================
// 4. MOCKUP GENERATION (Final Fixed Version)
// =========================================================================

generateMockupBtn.onclick = function() {
    // 1. Get the latest prompt
    const lastUserMsg = [...chatHistory]
        .reverse()
        .find(msg => msg.role === 'user' && msg.content.trim());
    const designPrompt = lastUserMsg ? lastUserMsg.content.trim() : "";

    // 2. Validation
    if (!selectedProduct) {
        alert("Please select a product first.");
        return;
    }

    // 3. UI Loading State
    const originalBtnText = generateMockupBtn.textContent;
    
    // üÜï MOBILE: Close designer panel & show "Generating..." message in chat
    if (window.innerWidth <= 768) {
        // Close the designer panel
        document.querySelector(".designer-panel").classList.remove("open");
        document.getElementById("mobile-backdrop").classList.remove("visible");
        document.body.style.overflow = '';
        
        // Scroll to chat panel smoothly
        setTimeout(() => {
            document.querySelector(".chat-panel").scrollIntoView({ 
                behavior: "smooth" 
            });
        }, 300);
    }
    
    // 1. Add "Generating" message to chat panel
    addMessage('ai', 'üé® Generating your mockup... Please wait.');
    // 2. Show loading state on button
    showLoading(generateMockupBtn, 'Generating Image...', mockupLoadingSpinner);
    // 1. Add "Generating" message to chat panel
    addMessage('ai', 'Generating your mockup... Please wait.');
    // 2. Show loading state on button
    showLoading(generateMockupBtn, 'Generating Image...', mockupLoadingSpinner);

    // ‚úÖ Always store the prompt being used for this generation
    window.currentGenerationPrompt = designPrompt && designPrompt.trim() !== ""
        ? designPrompt.trim()
        : "Default prompt";

    const payload = {
        product_name: selectedProduct,
        sub_product_id: selectedSubProduct,
        logo_b64: uploadedLogoBase64,
        logo_mime_type: uploadedLogoMimeType,
        design_prompt: window.currentGenerationPrompt,
        color: selectedColor,
        brand_name: document.getElementById("brandNameInput") ? document.getElementById("brandNameInput").value : "" // Added brand_name
    };

    fetch('/generate_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(async data => {
        if (data.error) {
            addMessage('ai', `‚ùå Mockup Generation Failed: ${data.error}`);
        } else if (data.image_b64) {
            const base64Image = `data:image/png;base64,${data.image_b64}`;
            const currentProduct = allProducts.find(p => p.id === selectedProduct) || { name: 'Your Product' };
            
            // üÜî Generate a Unique ID for THIS specific mockup
            const thisMockupId = 'MOCK_ID_' + Date.now();

            // üíæ SAVE specific details for this mockup to the storage object
            mockupStorage[thisMockupId] = {
                image: base64Image,
                productName: currentProduct.name,
                prompt: window.currentGenerationPrompt,
                logoUrl: data.logo_drive_url || ""
            };

            // üõ†Ô∏è Ensure Chat ID exists (from previous fix)
            if (!currentChatId) {
                await createNewChatSession();
            }

            // üí¨ Add message with the SPECIFIC ID
            addMessage(
                'ai',
                `üéâ Design is ready for your **${currentProduct.name}**! Review the preview below...`,
                base64Image,
                thisMockupId // üëà Passing the unique ID here
            );

            // ‚úÖ Always save latest prompt, not accumulated prompts
            window.generatedPrompt = window.currentGenerationPrompt;
            window.generatedMockup = {
                prompt_used: window.generatedPrompt,
                logo_url: data.logo_drive_url || "",
                product_name: selectedProduct || "N/A"
            };

            console.log("üß† Latest prompt saved for this mockup:", window.generatedPrompt);

            // üíæ Save assistant‚Äôs reply with mockup preview to chat history
            // Now that we ensured currentChatId exists above, this block will always run.
            if (currentChatId) {
                await fetch(`/chats/${currentChatId}/message`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        role: "assistant",
                        content: `üéâ Design is ready for your ${currentProduct.name}!`,
                        image: base64Image
                    })
                });
                console.log("‚úÖ Saved mockup image to chat history");
            }
        } else {
            addMessage('ai', 'Received an unexpected response from the mockup service.');
        }
    })
    .catch(error => {
        console.error('Mockup API Error:', error);
        addMessage('ai', 'A network error occurred while generating the mockup. Check server logs.');
    })
    .finally(() => {
        hideLoading(generateMockupBtn, originalBtnText, mockupLoadingSpinner);
    });
};
generateMockupBtn.onclick = function() {
    // 1. Get the latest prompt
    const lastUserMsg = [...chatHistory]
        .reverse()
        .find(msg => msg.role === 'user' && msg.content.trim());
    const designPrompt = lastUserMsg ? lastUserMsg.content.trim() : "";

    // 2. Validation
    if (!selectedProduct) {
        alert("Please select a product first.");
        return;
    }

    // 3. UI Loading State
    const originalBtnText = generateMockupBtn.textContent;
    // 1. Add "Generating" message to chat panel
    addMessage('ai', 'Generating your mockup... Please wait.');
    // 2. Show loading state on button
    showLoading(generateMockupBtn, 'Generating Image...', mockupLoadingSpinner);

    // 4. Store Prompt
    window.currentGenerationPrompt = designPrompt && designPrompt.trim() !== ""
        ? designPrompt.trim()
        : "Default prompt";

    // 5. Prepare Payload
    const payload = {
        product_name: selectedProduct,
        sub_product_id: selectedSubProduct,
        logo_b64: uploadedLogoBase64,
        logo_mime_type: uploadedLogoMimeType,
        design_prompt: window.currentGenerationPrompt,
        color: selectedColor,
        brand_name: document.getElementById("brandNameInput") ? document.getElementById("brandNameInput").value : "" // Added brand_name
    };

    // 6. Send API Request
    fetch('/generate_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(async data => {
        if (data.error) {
            addMessage('ai', `‚ùå Mockup Generation Failed: ${data.error}`);
        } else if (data.image_b64) {
            const base64Image = `data:image/png;base64,${data.image_b64}`;
            const currentProduct = allProducts.find(p => p.id === selectedProduct) || { name: 'Your Product' };
            
            // üÜî Generate a Unique ID for THIS specific mockup
            const thisMockupId = 'MOCK_ID_' + Date.now();

            // üíæ SAVE specific details for this mockup to the storage object
            mockupStorage[thisMockupId] = {
                image: base64Image,
                productName: currentProduct.name,
                prompt: window.currentGenerationPrompt,
                logoUrl: data.logo_drive_url || ""
            };

            // üõ†Ô∏è Ensure Chat ID exists
            if (!currentChatId) {
                await createNewChatSession();
            }

            // ‚úÖ Save mockup for session restoration
await fetch('/save-mockup-to-library', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-User-ID': appUserId || 'guest'
    },
    body: JSON.stringify({
        product: selectedProduct,
        brand_name: document.getElementById("brandNameInput").value,
        color: selectedColor,
        logo_url: data.logo_drive_url || "",
        image_b64: data.image_b64,
        chat_id: currentChatId
    })
});


            // ======================================================
            // üì∏ NEW: AUTO-SAVE TO LIBRARY LOGIC START
            // ======================================================
            try {
                const brandVal = document.getElementById("brandNameInput") ? document.getElementById("brandNameInput").value : "";
                
                const saveResponse = await fetch('/save-mockup-to-library', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-ID': appUserId || 'guest'
                    },
                    body: JSON.stringify({
                        product: selectedProduct,
                        brand_name: brandVal,
                        color: selectedColor,
                        logo_url: data.logo_drive_url || "",
                        image_b64: data.image_b64,
                        chat_id: currentChatId
                    })
                });
                if (saveResponse.ok) {
                    console.log("‚úÖ Mockup saved to library automatically.");
                    // If library is open, refresh it
                    const libSection = document.getElementById('librarySection');
                    if (libSection && libSection.classList.contains('open')) {
                        loadPhotoLibrary();
                    }
                }
            } catch (err) {
                console.error("‚ö† Library save error:", err);
            }
            // ======================================================
            // üì∏ NEW: AUTO-SAVE TO LIBRARY LOGIC END
            // ======================================================

            // üí¨ Add message with the SPECIFIC ID
            addMessage(
                'ai',
                `üéâ Design is ready for your **${currentProduct.name}**! Review the preview below...`,
                base64Image,
                thisMockupId 
            );

            // ‚úÖ Always save latest prompt
            window.generatedPrompt = window.currentGenerationPrompt;
            window.generatedMockup = {
                prompt_used: window.generatedPrompt,
                logo_url: data.logo_drive_url || "",
                product_name: selectedProduct || "N/A"
            };

            // üíæ Save assistant‚Äôs reply with mockup preview to chat history
            if (currentChatId) {
                await fetch(`/chats/${currentChatId}/message`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        role: "assistant",
                        content: `üéâ Design is ready for your ${currentProduct.name}!`,
                        image: base64Image
                    })
                });
            }
        } else {
            addMessage('ai', 'Received an unexpected response from the mockup service.');
        }
    })
    .catch(error => {
        console.error('Mockup API Error:', error);
        addMessage('ai', 'A network error occurred while generating the mockup. Check server logs.');
    })
    .finally(() => {
        hideLoading(generateMockupBtn, originalBtnText, mockupLoadingSpinner);
    });
};



    // =========================================================================
    // 5. DOWNLOAD GATE AND VERIFICATION LOGIC (No Change)
    // =========================================================================
    function showDownloadModal(mockupId) {
        currentMockupId = mockupId;
        downloadModal.classList.add('active');
        document.getElementById('emailGroup').classList.remove('error');
        document.getElementById('phoneGroup').classList.remove('error');
    }

    closeModalBtn.onclick = () => {
        downloadModal.classList.remove('active');
    };

    window.onclick = (event) => { 
        if (event.target === downloadModal) {
            downloadModal.classList.remove('active');
        }
    };

    // Main Download Button Handler
  // Main Download Button Handler
document.getElementById("downloadSubmitBtn").addEventListener("click", async () => {
    // 1. Get Email
    const emailInput = document.getElementById("downloadEmail");
    const email = emailInput.value.trim();

    // 2. Get Phone Number using the 'iti' instance
    const phone = iti.getNumber(); 
    const isPhoneValid = iti.isValidNumber(); 

    const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

    // --- Validation UI Logic ---
    if (!emailValid) {
        document.getElementById("emailGroup").classList.add("error");
        return;
    } else {
        document.getElementById("emailGroup").classList.remove("error");
    }

    if (!isPhoneValid) {
        document.getElementById("phoneGroup").classList.add("error");
        return;
    } else {
        document.getElementById("phoneGroup").classList.remove("error");
    }

    // Show loading state on button
    const submitBtn = document.getElementById("downloadSubmitBtn");
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Verifying...";
    submitBtn.disabled = true;

    // üîç Check if download is from Library or Chat
    let imageBase64, productName, logoURL, latestPrompt, brandName;
    
    if (window.currentLibraryMockup) {
        // üìö LIBRARY DOWNLOAD
        const mockup = window.currentLibraryMockup;
        productName = mockup.product || "N/A";
        brandName = mockup.brand_name || "";
        logoURL = uploadedLogoBase64;
        latestPrompt = `Library download: ${mockup.brand_name || productName}`;
        
        // Fetch the image and convert to base64
        try {
            const imgResponse = await fetch(mockup.generated_image);
            const imgBlob = await imgResponse.blob();
            imageBase64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(",")[1]); // ‚úÖ Get base64 without prefix
                reader.readAsDataURL(imgBlob);
            });
        } catch (err) {
            console.error("Failed to fetch library image:", err);
            alert("Failed to load image. Please try again.");
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
            return;
        }
        
    } else if (currentMockupId && mockupStorage[currentMockupId]) {
        // üí¨ CHAT DOWNLOAD (existing logic)
        const specificMockup = mockupStorage[currentMockupId];
        latestPrompt = specificMockup.prompt || "";
        productName = specificMockup.productName || "";
        brandName = document.getElementById("brandNameInput") ? document.getElementById("brandNameInput").value : "";
        logoURL = uploadedLogoBase64;
        
        // ‚úÖ Extract base64 from data URL if present
        if (specificMockup.image && specificMockup.image.includes("base64,")) {
            imageBase64 = specificMockup.image.split("base64,")[1];
        } else {
            imageBase64 = specificMockup.image || "";
        }
    } else {
        alert("Error: Could not find mockup data. Please try regenerating.");
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
    }

    console.log("Sending Data:", { email, phone, productName, brandName });

    // ========================================
    // SAVE TO GOOGLE SHEET (Apps Script)
    // ========================================
    try {
        await saveUserData(
            email,
            phone,
            productName,
            latestPrompt,
            uploadedLogoBase64,
            imageBase64
        );
        console.log("üìÑ Saved to Google Sheet (Apps Script)");
    } catch (err) {
        console.error("‚ùå Failed to save to Google Sheet:", err);
        alert("Error saving user details. Please try again.");
    }

    // Sanitize filename
    const safeName = (productName || "design").replace(/[^a-z0-9_\-]/gi, "_");
    const timestamp = Date.now();
    const filename = `${safeName}_${timestamp}.pdf`;

    if (!imageBase64) {
        alert("‚ö†Ô∏è No image found.");
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
    }

    try {
        // ‚úÖ Trigger Download (watermark backend creates PDF)
        const downloadResponse = await fetch("/download_mockup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                image_b64: imageBase64,  // ‚úÖ Now sending clean base64
                filename: filename,
                email: email,
                phone: phone,
                brand_name: brandName || productName
            }),
        });

        if (downloadResponse.ok) {
            const blob = await downloadResponse.blob();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
            
            // ‚úÖ Show success message
            alert("‚úÖ PDF mockup downloaded! Check your email for confirmation.");
        } else {
            const errorData = await downloadResponse.json();
            throw new Error(errorData.error || "Download failed");
        }
    } catch (error) {
        console.error("Download error:", error);
        alert(`‚ùå Download failed: ${error.message}`);
    }

    // Close Modal + Reset
    document.getElementById("downloadModal").classList.remove("active");
    window.currentLibraryMockup = null;

    submitBtn.textContent = originalText;
    submitBtn.disabled = false;
});




// ========================================
// üñºÔ∏è FULL PAGE LIBRARY SYSTEM
// ========================================

// Open Library Page
document.getElementById('libraryBtn')?.addEventListener('click', () => {
  document.getElementById('libraryOverlay').style.display = 'block';
  loadFullPageLibrary();
});

// Close Library Page
document.getElementById('closeLibraryBtn')?.addEventListener('click', () => {
  document.getElementById('libraryOverlay').style.display = 'none';
});

// Load Library with Full Page Grid
async function loadFullPageLibrary() {
  const grid = document.getElementById('libraryGrid');
  grid.innerHTML = '<p style="color:#777; text-align:center; padding:50px; font-size:1.1em;">Loading your designs...</p>';

  try {
    const response = await fetch('/get-library', {
      method: 'GET',
      headers: { 'X-User-ID': appUserId || 'guest' }
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const data = await response.json();

    if (data.status === 'ok' && data.mockups && data.mockups.length > 0) {
      grid.innerHTML = ''; // Clear loading message

      data.mockups.forEach(mockup => {
        const card = document.createElement('div');
        card.className = 'library-card';
        
        const productName = mockup.product.replace(/_/g, ' ').toUpperCase();
        const date = new Date(mockup.created_at).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        card.innerHTML = `
          <img src="${mockup.thumbnail_url || mockup.generated_image}" 
               alt="${productName}" 
               title="Click to download">
          
          <div class="library-card-info">
            <span class="library-card-title">${productName}</span>
            <span class="library-card-date">${date}</span>
          </div>
          
          ${mockup.brand_name ? `<p style="color:#666; font-size:0.85em; margin:5px 0;">Brand: ${mockup.brand_name}</p>` : ''}
          
          <button class="library-download-btn">
            <i class="bi bi-download"></i> Download High-Res
          </button>
        `;

        // ‚úÖ OPEN MODAL on image click
        const img = card.querySelector('img');
        img.onclick = () => showLibraryDownloadModal(mockup);

        // ‚úÖ DOWNLOAD button click
        const btn = card.querySelector('.library-download-btn');
        btn.onclick = () => showLibraryDownloadModal(mockup);

        grid.appendChild(card);
      });

    } else {
      grid.innerHTML = `
        <div style="grid-column:1/-1; text-align:center; padding:80px 20px;">
          <i class="bi bi-images" style="font-size:4em; color:#ccc;"></i>
          <h3 style="color:#777; margin-top:20px;">No designs yet</h3>
          <p style="color:#999;">Generate your first mockup to see it here!</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Library error:', error);
    grid.innerHTML = '<p style="color:red; text-align:center; padding:50px;">Failed to load library</p>';
  }
}



// ‚úÖ DOWNLOAD with Verification Modal (Keep existing function)
function showLibraryDownloadModal(mockup) {

  window.currentLibraryMockup = mockup;
  document.getElementById('downloadModal').classList.add('active');
  document.getElementById('downloadEmail').value = '';
  const phoneInput = document.getElementById('phone');
  if (phoneInput && window.iti) {
    window.iti.setNumber('');
  }
  document.getElementById('emailGroup').classList.remove('error');
  document.getElementById('phoneGroup').classList.remove('error');
}
   // =========================================================================
// 6. INITIALIZATION & EVENT LISTENERS (FIXED)
// =========================================================================
// ==========================================
// ‚úÖ INITIALIZATION (REPLACE WHOLE BLOCK)
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    console.log("üöÄ Initializing app...");
    
    // 1. Render Products & Colors
    renderProducts();
    // renderColorSwatches();
    
    // 2. Load Chat History
    loadChatHistory();

    // 3. Setup "New Chat" Button
    const newChatBtnElement = document.getElementById('newChatBtn');
    if (newChatBtnElement) {
        newChatBtnElement.onclick = startNewChat; 
    }
   
    
    // 4. Chat History Toggle Logic (FIXED)
const chatHistoryToggle = document.getElementById('chatHistoryToggle');
const chatHistoryList = document.getElementById('chatHistoryList');

if (chatHistoryToggle && chatHistoryList) {
    // üîí default state: hidden
    chatHistoryList.style.display = 'none';

    chatHistoryToggle.onclick = function () {
        const isOpen = chatHistoryList.classList.contains('open');

        if (isOpen) {
            // ‚ùå CLOSE
            chatHistoryList.classList.remove('open');
            chatHistoryList.style.display = 'none';
        } else {
            // ‚úÖ OPEN
            chatHistoryList.classList.add('open');
            chatHistoryList.style.display = 'block';
        }

        // icon rotation (same as before)
        const icon = chatHistoryToggle.querySelector('.bi-chevron-down');
        if (icon) {
            icon.style.transition = 'transform 0.3s ease';
            icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        }
    };
}


     else {
        console.warn("‚ö†Ô∏è Library toggle or section not found in HTML");
    }
});


// ======================
// ‚úÖ FIXED WELCOME FLOW (for your UI)
// ======================
document.addEventListener("DOMContentLoaded", () => {
    const chatContainer = document.querySelector(".chat-messages");
    if (!chatContainer) return;

    // Helper: Typing animation
    function typeMessage(text, delay = 30) {
        return new Promise((resolve) => {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("message-bubble", "ai");
            msgDiv.textContent = "";
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            let i = 0;
            const interval = setInterval(() => {
                msgDiv.textContent = text.substring(0, i);
                i++;
                if (i > text.length) {
                    clearInterval(interval);
                    resolve();
                }
            }, delay);
        });
    }

    // Step-by-step onboarding
    // async function startOnboarding() {
    //     await typeMessage("üëã Hi there! Welcome to the Greenwich Packaging Design Assistant.");
    
    // }

    // Start onboarding
    startOnboarding();
});

/* ===========================
   Smooth 3D tilt (requestAnimationFrame)
   Attach AFTER product items exist
   =========================== */
(function(){
  const cards = () => Array.from(document.querySelectorAll('.product-item'));
  function attach(){
    cards().forEach(card => {
      let frame = null;
      let resetTimeout = null;

      function onMove(e){
        const rect = card.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const dx = (e.clientX - cx) / (rect.width/2);
        const dy = (e.clientY - cy) / (rect.height/2);

        const rotateX = (-dy * 8).toFixed(2);
        const rotateY = (dx * 8).toFixed(2);

        cancelAnimationFrame(frame);
        frame = requestAnimationFrame(() => {
          card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.06)`;
          card.style.transition = 'transform 120ms linear';
        });

        clearTimeout(resetTimeout);
        resetTimeout = setTimeout(() => {
          card.style.transition = 'transform 400ms cubic-bezier(.2,.9,.3,1)';
          card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1.02)';
        }, 120);
      }

      function onLeave(){
        cancelAnimationFrame(frame);
        card.style.transition = 'transform 500ms cubic-bezier(.2,.9,.3,1)';
        card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1.02)';
      }

      card.addEventListener('mousemove', onMove);
      card.addEventListener('mouseleave', onLeave);
    });
  }

  // Try attach initially and also re-attach after any dynamic re-render (safe)
  document.addEventListener('DOMContentLoaded', attach);
  // If products are added later, re-run (non-intrusive)
  const observer = new MutationObserver((m)=> { attach(); });
  observer.observe(document.getElementById('productSelector') || document.body, { childList:true, subtree:true });
})();

// Phone input initialization - removed duplicate declaration



document.addEventListener("DOMContentLoaded", () => {
  const wrapper = document.querySelector(".product-selector-wrapper");
  const leftBtn = document.querySelector(".slider-btn.left");
  const rightBtn = document.querySelector(".slider-btn.right");

  // üí° Scroll speed and smoothness
  const scrollStep = 220; // pixels to move per click
  const scrollDuration = 300; // milliseconds

  // ‚úÖ Smooth scroll function (manual animation, works in all browsers)
  function smoothScrollBy(distance) {
    const start = wrapper.scrollLeft;
    const startTime = performance.now();

    function animateScroll(time) {
      const elapsed = time - startTime;
      const progress = Math.min(elapsed / scrollDuration, 1);
      wrapper.scrollLeft = start + distance * progress;

      if (progress < 1) requestAnimationFrame(animateScroll);
    }
    requestAnimationFrame(animateScroll);
  }

  // ‚úÖ Buttons
  leftBtn.addEventListener("click", () => smoothScrollBy(-scrollStep));
  rightBtn.addEventListener("click", () => smoothScrollBy(scrollStep));

  // ‚úÖ Keyboard Arrow Keys
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowRight") {
      smoothScrollBy(scrollStep);
    } else if (e.key === "ArrowLeft") {
      smoothScrollBy(-scrollStep);
    }
  });

  // ‚úÖ Mouse drag scrolling (natural feel)
  let isDown = false;
  let startX;
  let scrollLeft;
  wrapper.addEventListener("mousedown", (e) => {
    isDown = true;
    wrapper.classList.add("active");
    startX = e.pageX - wrapper.offsetLeft;
    scrollLeft = wrapper.scrollLeft;
    wrapper.style.cursor = "grabbing";
  });
  wrapper.addEventListener("mouseleave", () => {
    isDown = false;
    wrapper.classList.remove("active");
    wrapper.style.cursor = "default";
  });
  wrapper.addEventListener("mouseup", () => {
    isDown = false;
    wrapper.classList.remove("active");
    wrapper.style.cursor = "default";
  });
  wrapper.addEventListener("mousemove", (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - wrapper.offsetLeft;
    const walk = (x - startX) * 1.2; // adjust sensitivity
    wrapper.scrollLeft = scrollLeft - walk;
  });
});

const phoneInput = document.querySelector("#phone");

    // const iti = window.intlTelInput(phoneInput, {
    //     initialCountry: "auto",
    //     geoIpLookup: function(callback) {
    //         fetch("https://ipapi.co/json")
    //             .then(res => res.json())
    //             .then(data => callback(data.country_code))
    //             .catch(() => callback("IN"));  
    //     },
    //     separateDialCode: true,
    //     utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
    // });

    const iti = window.intlTelInput(phoneInput, {
    initialCountry: "GB",   // üá¨üáß UK Default
    separateDialCode: true,
    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
});


    function getFullPhoneNumber() {
        return iti.getNumber();  
    }



// MOBILE ‚Äì When Generate button is clicked ‚Üí Switch to Chat Panel
document.getElementById("generateMockupBtn")?.addEventListener("click", function () {
    if (window.innerWidth <= 768) {

        // 1. Close the designer panel (slide left)
        document.querySelector(".designer-panel").classList.remove("open");
        document.getElementById("mobile-backdrop").classList.remove("visible");

        // 2. Scroll to chat panel
        document.querySelector(".chat-panel").scrollIntoView({ 
            behavior: "smooth" 
        });
    }
});


// ==========================================
// üì± FIX: MOBILE ICON EVENT LISTENERS
// ==========================================

// 1. Mobile Library Button - Opens the existing Overlay
document.getElementById('mobileLibraryBtn')?.addEventListener('click', () => {
    // Reuse existing full page library function
    document.getElementById('libraryOverlay').style.display = 'block';
    loadFullPageLibrary();
});

// 2. Mobile History Button - Toggles the Dropdown
document.getElementById('mobileHistoryBtn')?.addEventListener('click', (e) => {
    e.stopPropagation(); // Prevent document click from closing it immediately
    const historyDropdown = document.getElementById('mobileHistoryDropdown');
    if (historyDropdown) {
        historyDropdown.classList.toggle('open');
    }
});

// 3. Close Mobile History when clicking outside
document.addEventListener('click', (e) => {
    const historyDropdown = document.getElementById('mobileHistoryDropdown');
    const historyBtn = document.getElementById('mobileHistoryBtn');
    
    if (historyDropdown && historyBtn) {
        if (!historyDropdown.contains(e.target) && !historyBtn.contains(e.target)) {
            historyDropdown.classList.remove('open');
        }
    }
});




document.addEventListener("DOMContentLoaded", () => {
    const quickBtn = document.getElementById("quickGenerateBtn");
    const mainGenerateBtn = document.getElementById("generateMockupBtn");

    if (quickBtn && mainGenerateBtn) {
        quickBtn.addEventListener("click", () => {
            // Trigger the real generate mockup button
            mainGenerateBtn.click();
        });
    }
});






















// --- Product Search feature ---
// Requires: allProducts array, selectedProduct var, updateSubOptions(), renderProducts() existing in script.

(function(){
  const searchInput = document.getElementById('productSearchInput');
  const resultsDiv = document.getElementById('productSearchResults');

  if(!searchInput || !resultsDiv) return;

  // Helper: normalize string
  const norm = s => (s||'').toString().toLowerCase().trim();

//   // Build DOM node for a product row
//   function buildProductRow(product, matchText){
//     const row = document.createElement('div');
//     row.className = 'product-search-item';
//     row.setAttribute('data-id', product.id);

//     const img = document.createElement('img');
//     img.src = product.img || 'static/placeholder.png';
//     img.onerror = function(){ this.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="120"><rect width="100%" height="100%" fill=%23f6fbf4 /><text x="50%" y="50%" font-size="14" fill=%236a994e dominant-baseline="middle" text-anchor="middle">'+encodeURIComponent(product.name)+'</text></svg>'; };

//     const meta = document.createElement('div');
//     meta.style.flex = '1';

//     const title = document.createElement('div');
//     title.innerHTML = `<span class="search-hit">${product.name}</span>`;
//     title.style.fontSize = '14px';
//     title.style.marginBottom = '4px';

//     const subtitle = document.createElement('div');
//     subtitle.style.fontSize = '12px';
//     subtitle.style.color = '#666';
//     subtitle.textContent = product.subOptions && product.subOptions.length ? `${product.subOptions.length} variant(s)` : 'No variants';

//     meta.appendChild(title);
//     meta.appendChild(subtitle);

//     row.appendChild(img);
//     row.appendChild(meta);

//     // click selects product in your UI
//     row.addEventListener('click', () => {
//       // set as selectedProduct (matches how your code uses it)
//       selectedProduct = product.id;
//       // optional: set default sub
//       selectedSubProduct = product.default_sub_id || (product.subOptions && product.subOptions[0] && product.subOptions[0].id) || null;
//       // re-render product grid + suboptions
//       renderProducts();      // your function already updates UI
//       updateSubOptions();    // ensure sub options visible
//       // hide results and clear input
//       resultsDiv.style.display = 'none';
//       searchInput.value = '';
//       searchInput.blur();
//       // scroll product-selector to show selected item (if present)
//       const elem = document.querySelector(`.product-item[data-id="${product.id}"]`);
//       if(elem && elem.scrollIntoView) elem.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
//     });

//     return row;
//   }




// PRODUCT CARD (IMAGE UP, NAME DOWN)
function buildProductRow(product, matchText) {
  const row = document.createElement("div");
  row.className = "product-search-item";
  row.style.display = "flex";
  row.style.flexDirection = "column";
  row.style.alignItems = "center";
  row.style.padding = "10px";
  row.style.borderRadius = "12px";
  row.style.marginBottom = "10px";
  row.style.cursor = "pointer";
  row.style.transition = "0.2s";
  row.style.border = "1px solid #eee";
  row.style.background = "#fff";

  row.onmouseover = () => (row.style.background = "#f4faef");
  row.onmouseout = () => (row.style.background = "#fff");

  // BIG PRODUCT IMAGE
  const img = document.createElement("img");
  img.src = product.img || "static/placeholder.png";
  img.style.width = "90px";
  img.style.height = "90px";
  img.style.objectFit = "cover";
  img.style.borderRadius = "10px";
  img.style.border = "1px solid #ddd";
  img.style.marginBottom = "8px";

  // PRODUCT NAME BELOW IMAGE
  const title = document.createElement("div");
  title.textContent = product.name;
  title.style.fontSize = "14px";
  title.style.fontWeight = "600";
  title.style.textAlign = "center";
  title.style.color = "#333";

  row.appendChild(img);
  row.appendChild(title);

  row.addEventListener("click", () => {
    selectedProduct = product.id;
    selectedSubProduct =
      product.default_sub_id ||
      (product.subOptions?.length ? product.subOptions[0].id : null);

    renderProducts();
    updateSubOptions();

    document.getElementById("productSearchResults").style.display = "none";
    document.getElementById("productSearchInput").value = "";
  });

  return row;
}




//   // Build sub-list under a product (shows matching sub-products)
//   function buildSubList(subs, parentDiv){
//     subs.forEach(sub => {
//       const subRow = document.createElement('div');
//       subRow.className = 'product-search-sub';
//       subRow.textContent = `‚Ä¢ ${sub.name}`;
//       subRow.style.cursor = 'pointer';
//       subRow.addEventListener('click', (ev) => {
//         ev.stopPropagation();
//         // set parent product and selected subproduct
//         selectedProduct = parentDiv.getAttribute('data-id') || selectedProduct;
//         selectedSubProduct = sub.id;
//         renderProducts();
//         updateSubOptions();
//         resultsDiv.style.display = 'none';
//         searchInput.value = '';
//       });
//       parentDiv.appendChild(subRow);
//     });
//   }









// SUB PRODUCT CARDS (IMAGE UP, NAME DOWN)
function buildSubList(subs, parentDiv) {
  subs.forEach((sub) => {
    const subRow = document.createElement("div");
    subRow.style.display = "flex";
    subRow.style.flexDirection = "column";
    subRow.style.alignItems = "center";
    subRow.style.padding = "10px";
    subRow.style.marginTop = "6px";
    subRow.style.borderRadius = "10px";
    subRow.style.cursor = "pointer";
    subRow.style.border = "1px solid #eee";
    subRow.style.transition = "0.2s";

    subRow.onmouseover = () => (subRow.style.background = "#eef9e8");
    subRow.onmouseout = () => (subRow.style.background = "transparent");

    // SUB PRODUCT IMAGE
    const img = document.createElement("img");
    img.src = sub.img || "static/placeholder.png";
    img.style.width = "70px";
    img.style.height = "70px";
    img.style.objectFit = "cover";
    img.style.borderRadius = "8px";
    img.style.border = "1px solid #ddd";
    img.style.marginBottom = "6px";

    // NAME BELOW IMAGE
    const name = document.createElement("div");
    name.textContent = sub.name;
    name.style.fontSize = "13px";
    name.style.fontWeight = "500";
    name.style.textAlign = "center";
    name.style.color = "#444";

    subRow.appendChild(img);
    subRow.appendChild(name);

    subRow.addEventListener("click", (ev) => {
      ev.stopPropagation();

      selectedProduct = parentDiv.getAttribute("data-id");
      selectedSubProduct = sub.id;

      renderProducts();
      updateSubOptions();

      document.getElementById("productSearchResults").style.display = "none";
      document.getElementById("productSearchInput").value = "";
    });

    parentDiv.appendChild(subRow);
  });
}










  function showNoResults(){
    resultsDiv.innerHTML = `<div class="no-results">No products or variants found.</div>`;
    resultsDiv.style.display = 'block';
  }

  function doSearch(q){
    const qn = norm(q);
    if(!qn){
      resultsDiv.style.display = 'none';
      resultsDiv.innerHTML = '';
      return;
    }

    const matches = [];

    allProducts.forEach(p => {
      const pname = norm(p.name);
      // match product name
      if(pname.includes(qn) || norm(p.id).includes(qn)){
        matches.push({ product: p, matchingSubs: p.subOptions || [] });
        return;
      }
      // match suboptions
      const matchingSubs = (p.subOptions || []).filter(s => norm(s.name).includes(qn) || norm(s.id).includes(qn));
      if(matchingSubs.length) matches.push({ product: p, matchingSubs });
    });

    if(matches.length === 0) { showNoResults(); return; }

    // render result list
    resultsDiv.innerHTML = '';
    matches.forEach(match => {
      const p = match.product;
      const row = buildProductRow(p);
      // attach attribute for sub clicks
      row.setAttribute('data-id', p.id);
      // if there are specific matching subs, list them
      if(match.matchingSubs && match.matchingSubs.length){
        buildSubList(match.matchingSubs, row);
      }
      resultsDiv.appendChild(row);
    });
    resultsDiv.style.display = 'block';
  }

  // debounce helper
  let debounceTimer = null;
  searchInput.addEventListener('input', (e) => {
    const v = e.target.value;
    if(debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => doSearch(v), 120);
  });

  // close results on outside click
  document.addEventListener('click', (ev) => {
    if(!resultsDiv.contains(ev.target) && ev.target !== searchInput) {
      resultsDiv.style.display = 'none';
    }
  });

})();








    </script>





<!-- üì¶ Mobile Product Floating Button -->
<button id="mobileProductBtn" class="mobile-product-fab">
  <i class="bi bi-box-seam"></i>
</button>



 

<script>
/* ===============================
   IMAGE CLICK ‚Üí PREVIEW MODAL
   =============================== */

document.addEventListener("click", function (e) {
  const img = e.target;

  if (img.classList.contains("message-image")) {
    openImagePreview(img.src);
  }
});

function openImagePreview(src) {
  // remove old modal if exists
  const old = document.getElementById("imagePreviewModal");
  if (old) old.remove();

  const modal = document.createElement("div");
  modal.id = "imagePreviewModal";

  modal.innerHTML = `
    <img src="${src}" class="preview-img" />
  `;

  // close on click anywhere
  modal.addEventListener("click", () => modal.remove());

  document.body.appendChild(modal);
}
</script>

</body>




<!-- ====== AUTO-SLIDE (NO DRAW) ‚Äî clean version (paste before </body>) ====== -->
<style>
/* Fullscreen overlay */
#autoSuperLoader {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 999999;
  background: linear-gradient(180deg, rgba(255,255,255,0.5), rgba(245,250,240,0.45));
  backdrop-filter: blur(6px) saturate(1.05);
  -webkit-backdrop-filter: blur(6px) saturate(1.05);
  align-items: center;
  justify-content: center;
  padding: 20px;
}

/* Card */
#autoSuperLoader .card {
  width: min(920px, 96vw);
  max-width: 920px;
  border-radius: 16px;
  padding: 20px;
  background: linear-gradient(180deg,#ffffff,#fbfff7);
  box-shadow: 0 28px 80px rgba(30,60,20,0.12);
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:center;
  position:relative;
  overflow:visible;
}

/* Top text */
#autoSuperLoader .title {
  font-weight:800;
  font-size:18px;
  color:#234f21;
  letter-spacing:.5px;
  text-align:center;
}

/* VIEWPORT: hosts visual stage */
.loader-stage {
  width:100%;
  height:260px;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  border-radius:14px;
  background: linear-gradient(180deg,#f9fff6,#eff8ea);
  border:1px solid #e9f1e6;
  box-shadow: inset 0 6px 22px rgba(10,20,10,0.02);
}

/* slide stack for crossfade */
.slide-stack {
  position: absolute;
  inset:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}

/* Each slide is absolute and centered; we animate opacity & transform */
.slide-item {
  position:absolute;
  width: 320px;
  height: 200px;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  transform-origin:center;
  transition: transform 700ms cubic-bezier(.2,.9,.25,1), opacity 700ms ease;
  opacity:0;
  will-change: transform, opacity;
  pointer-events:none;
  backdrop-filter: none;
}

/* visible slide */
.slide-item.visible {
  opacity:1;
  transform: translateY(-6px) scale(1.02);
  pointer-events:auto;
}

/* image container with tilt support */
.slide-visual {
  width:260px;
  height:152px;
  border-radius:10px;
  overflow:hidden;
  position:relative;
  box-shadow: 0 18px 44px rgba(40,80,30,0.08);
  background: #fff;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* image */
.slide-visual img {
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
  transform-origin:center;
  transition: transform 800ms cubic-bezier(.2,.9,.25,1);
  -webkit-user-drag: none;
  pointer-events:none;
}

/* label below */
.slide-label {
  font-weight:800;
  color:#2d5a27;
  font-size:14px;
  letter-spacing:.2px;
}

/* small controls row */
.controls {
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

/* progress */
.progress {
  flex:1;
  height:10px;
  border-radius:999px;
  background: linear-gradient(90deg,#eef9ea,#f8fff8);
  border:1px solid #e6efe0;
  overflow:hidden;
}
.progress > i { display:block; width:0; height:100%; background: linear-gradient(90deg,#5f973f,#a6db78); transition: width 380ms cubic-bezier(.2,.9,.25,1); box-shadow: 0 10px 30px rgba(90,140,60,0.14); }

.progress-text {
  width:86px;
  font-weight:700;
  font-size:13px;
  color:#274d24;
  text-align:right;
}

/* helper: small caption */
.sub { color:#546c48; font-size:12px; text-align:center; margin-top:6px; }

/* pause overlay icon when hovered */
.card.paused::after {
  content:'Paused';
  position:absolute;
  top:12px;
  right:16px;
  background:rgba(255,255,255,0.9);
  padding:6px 10px;
  border-radius:10px;
  font-weight:700;
  color:#3b6a2f;
  border:1px solid #e6efe0;
  box-shadow:0 6px 14px rgba(0,0,0,0.04);
  font-size:12px;
  letter-spacing:0.3px;
}




.slide-visual {
  border-radius: 14px !important;
  background: #ffffff;
  box-shadow:
    0 20px 40px rgba(0,0,0,0.10),
    0 10px 15px rgba(0,0,0,0.06);
  transform: translateY(4px);
  transition: all 0.6s ease;
}

.slide-item.visible .slide-visual {
  transform: translateY(-4px) scale(1.04);
}


.slide-svg {
  display: none !important;
}




/* 3D tilt transform smoother */
.tilt-wrap { transition: transform 650ms cubic-bezier(.2,.9,.25,1); transform-style: preserve-3d; }

/* responsive */
@media (max-width:760px){
  .slide-item { width:240px; height:180px; }
  .slide-visual { width:200px; height:120px; }
  #autoSuperLoader .card { padding:14px; }
  .progress-text { width:70px; font-size:12px; }
}
</style>

<div id="autoSuperLoader" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true" aria-label="Loading designs">
    <div class="title" id="autoTitle">Generating beautiful mockups for your brand</div>

    <div class="loader-stage" id="loaderStage" aria-hidden="true">
      <div class="slide-stack" id="slideStack" aria-hidden="true">
        <!-- slides injected by JS -->
      </div>
    </div>

    <div class="controls" aria-hidden="true">
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><i id="autoFill"></i></div>
      <div class="progress-text" id="autoPct">0%</div>
    </div>

    <div class="sub" id="autoSub">Relax ‚Äî applying brand patterns, colors and photoreal renders.</div>
  </div>
</div>


<script>
/* ====== Auto changing slides (NO DRAW) with tilt ====== */

/* configure products (only your products) */
const AUTO_PRODUCTS = [
  { id:'paper_cup', name:'Paper Cup', img:'static/cup.png' },
  { id:'paper_bag', name:'Paper Bag', img:'static/Paper_Bag.webp' },
  { id:'pizza_box', name:'Pizza Box', img:'static/pizza_box.jpeg' },
  { id:'Meal_Box', name:'Meal Box', img:'static/Meal_Box.png' },
];

/* utility placeholder */
function placeholderDataUrl(text,w=320,h=220){
  const bg = '#f6fbf4';
  const color = '#6a994e';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect width='100%' height='100%' fill='${bg}' /><text x='50%' y='50%' font-family='Segoe UI, Arial' font-size='20' fill='${color}' dominant-baseline='middle' text-anchor='middle'>${text}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

(function(){
  const root = document.getElementById('autoSuperLoader');
  const stack = document.getElementById('slideStack');
  const title = document.getElementById('autoTitle');
  const sub = document.getElementById('autoSub');
  const fillEl = document.getElementById('autoFill');
  const pctEl = document.getElementById('autoPct');

  let idx = 0;
  let timer = null;
  let progress = 0;
  let intervalMs = 1700; // default per-slide time
  let playing = false;

  // Create slide nodes
  function buildSlides(){
    stack.innerHTML = '';
    AUTO_PRODUCTS.forEach((p,i) => {
      const item = document.createElement('div');
      item.className = 'slide-item';
      item.dataset.index = i;

      const tiltWrap = document.createElement('div');
      tiltWrap.className = 'tilt-wrap';
      tiltWrap.style.width = '100%';
      tiltWrap.style.height = '100%';
      tiltWrap.style.display = 'flex';
      tiltWrap.style.alignItems = 'center';
      tiltWrap.style.justifyContent = 'center';

      const visual = document.createElement('div');
      visual.className = 'slide-visual';

      const img = document.createElement('img');
      img.alt = p.name;
      img.src = p.img;
      img.onerror = function(){ this.src = placeholderDataUrl(p.name,320,220); };

      visual.appendChild(img);
      tiltWrap.appendChild(visual);

      const label = document.createElement('div');
      label.className = 'slide-label';
      label.textContent = p.name;

      item.appendChild(tiltWrap);
      item.appendChild(label);

      stack.appendChild(item);
    });
  }

  // show specific index
  function showIndex(n){
    const slides = [...stack.children];
    slides.forEach(s=> s.classList.remove('visible'));
    const target = slides[n];
    if(!target) return;
    target.classList.add('visible');

    // reset tilt transform for visible image
    const img = target.querySelector('img');
    if(img) img.style.transform = 'translateZ(0) rotateX(0deg) rotateY(0deg)';

    // set focus title/subtext optionally
  }

  // auto loop
  function startLoop(){
    stopLoop();
    playing = true;
    timer = setInterval(()=> {
      idx = (idx + 1) % AUTO_PRODUCTS.length;
      showIndex(idx);
    }, intervalMs);
  }
  function stopLoop(){ if(timer) { clearInterval(timer); timer = null; } playing = false; }

  // tilt effect (parallax) - on mouse move over stage
  function enableTilt(){
    const stage = document.getElementById('loaderStage');
    if(!stage) return;
    stage.addEventListener('mousemove', onMove);
    stage.addEventListener('touchmove', onTouchMove, {passive:true});
    stage.addEventListener('mouseleave', () => resetTilt());
    stage.addEventListener('touchend', () => resetTilt());
    function onMove(e){
      if(window.innerWidth < 760) return; // skip on small screens
      const rect = stage.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const x = (e.clientX - cx) / (rect.width/2);
      const y = (e.clientY - cy) / (rect.height/2);
      applyTilt(x,y);
    }
    function onTouchMove(e){
      if(!e.touches || !e.touches[0]) return;
      onMove({clientX: e.touches[0].clientX, clientY: e.touches[0].clientY});
    }
    function applyTilt(x,y){
      const slides = [...stack.children];
      const visible = slides.find(s=> s.classList.contains('visible'));
      if(!visible) return;
      const img = visible.querySelector('img');
      if(!img) return;
      const rx = Math.max(-10, Math.min(10, -y * 8));
      const ry = Math.max(-12, Math.min(12, x * 10));
      img.style.transform = `perspective(800px) rotateX(${rx}deg) rotateY(${ry}deg) scale(1.03)`;
    }
    function resetTilt(){
      const slides = [...stack.children];
      slides.forEach(s=>{
        const img = s.querySelector('img');
        if(img) img.style.transform = 'translateZ(0) rotateX(0deg) rotateY(0deg) scale(1)';
      });
    }
  }

  // pause on hover / focus
  function attachPauseBehavior(){
    const card = document.querySelector('#autoSuperLoader .card');
    card.addEventListener('mouseenter', ()=> {
      stopLoop();
      card.classList.add('paused');
    });
    card.addEventListener('mouseleave', ()=> {
      card.classList.remove('paused');
      startLoop();
    });
    // also pause on focusin
    card.addEventListener('focusin', ()=> { stopLoop(); card.classList.add('paused'); });
    card.addEventListener('focusout', ()=> { card.classList.remove('paused'); startLoop(); });
  }

  // public API
  window.showLoading = function(message){
  title.textContent = "Generating your design‚Ä¶";

    root.style.display = 'flex';
    root.setAttribute('aria-hidden','false');
    buildSlides();
    // small delay so images load and layout settles
    setTimeout(()=>{
      idx = 0;
      showIndex(idx);
      startLoop();
    }, 80);
    enableTilt();
    attachPauseBehavior();
    setLoadingProgress(6);
  };

  window.hideLoading = function(){
    root.style.display = 'none';
    root.setAttribute('aria-hidden','true');
    stopLoop();
    // reset small
    setTimeout(()=> { setLoadingProgress(0); idx = 0; }, 400);
  };

  // progress setter ‚Äî also speeds slider near the end
  function setLoadingProgress(n){
    progress = Math.max(0, Math.min(100, Math.round(n)));
    fillEl.style.width = progress + '%';
    pctEl.textContent = progress + '%';
    const pb = document.querySelector('.progress');
    if(pb) pb.setAttribute('aria-valuenow', progress);

    // adaptive speed: lower interval when almost done for drama
    const prevInterval = intervalMs;
    if(progress < 50) intervalMs = 1700;
    else if(progress < 85) intervalMs = 1200;
    else intervalMs = 800;

    if(prevInterval !== intervalMs && playing){
      startLoop(); // restart with new speed
    }

    // update small message
    if(progress < 20) sub.textContent = 'Starting ‚Äî preparing brand assets';
    else if(progress < 50) sub.textContent = 'Applying colors & patterns';
    else if(progress < 85) sub.textContent = 'Rendering photorealistic mockups';
    else if(progress < 100) sub.textContent = 'Finalizing and optimizing files';
    else sub.textContent = 'Ready ‚Äî preparing your download';
  }

  window.setLoadingProgress = setLoadingProgress;

  // init (build but stay hidden)
  buildSlides();
  // responsive: reset tilt on resize
  window.addEventListener('resize', ()=> { /* no-op but keeps layout responsive */ });

})();
window.addEventListener("resize", () => {
    if (highlightEl && TOOLTIP.classList.contains("visible")) {
        positionTooltip(highlightEl);
    }
});
window.addEventListener("scroll", () => {
    if (highlightEl && TOOLTIP.classList.contains("visible")) {
        positionTooltip(highlightEl);
    }
});








</script>






<script>
/* ====== AUTO-PROGRESS FALLBACK WRAPPER ‚Äî paste after your loader widget ====== */
(function(){
  // avoid installing twice
  if (window.__auto_progress_installed) return;
  window.__auto_progress_installed = true;

  // references to DOM used by your loader
  const fillEl = document.getElementById('autoFill');
  const pctEl  = document.getElementById('autoPct');
  const subEl  = document.getElementById('autoSub');
  const root   = document.getElementById('autoSuperLoader');

  let autoTimer = null;
  let autoValue = null;   // current auto progress value
  let externalSet = false; // whether external setLoadingProgress was called
  let lastExternal = -1;

  // safe setter that updates DOM and keeps internal state
  function applyProgress(n){
    n = Math.max(0, Math.min(100, Math.round(n)));
    if (fillEl) fillEl.style.width = n + '%';
    if (pctEl) pctEl.textContent = n + '%';
    // keep track so auto increments are aware
    autoValue = n;
    // small aria update if present
    const pb = document.querySelector('#autoSuperLoader .progress');
    if (pb) pb.setAttribute('aria-valuenow', n);
  }

  // Auto-increment function: gently climbs when no external updates
  function startAutoProgress() {
    stopAutoProgress();
    // if external already provided progress, start from there; else start from current DOM or 6
    let start = typeof autoValue === 'number' ? autoValue : 6;
    autoValue = start;
    autoTimer = setInterval(()=> {
      // if external set happened recently, back off (let external values drive)
      if (externalSet && typeof lastExternal === 'number') {
        // if external progress advances, keep it; if external stalls long, resume auto after cooldown
        const now = lastExternal;
        // if external >= 98, stop auto
        if (now >= 98) { stopAutoProgress(); return; }
        // if external > autoValue, sync to external and keep autoValue above it
        if (now > autoValue) autoValue = now;
      }

      // compute increment: smaller as it grows, avoid reaching 100%
      let incr = 1 + Math.random()*2; // 1..3
      if (autoValue >= 60) incr = 0.6 + Math.random()*1.2;
      if (autoValue >= 85) incr = 0.25 + Math.random()*0.6;
      autoValue = Math.min(98, +(autoValue + incr).toFixed(2));

      applyProgress(autoValue);
      // update sub text lightly if element exists
      if (subEl) {
        if (autoValue < 20) subEl.textContent = 'Starting ‚Äî preparing brand assets';
        else if (autoValue < 50) subEl.textContent = 'Applying colors & patterns';
        else if (autoValue < 85) subEl.textContent = 'Rendering photorealistic mockups';
        else subEl.textContent = 'Almost ready ‚Äî finishing up';
      }
    }, 700);
  }

  function stopAutoProgress(){
    if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
  }

  // Wrap original functions (if present) so we can intercept calls.
  const origShow = window.showLoading || function(msg){ if(root){ root.style.display = 'flex'; root.setAttribute('aria-hidden','false'); } };
  const origSet  = window.setLoadingProgress || function(n){ applyProgress(n); };
  const origHide = window.hideLoading || function(){ if(root){ root.style.display = 'none'; root.setAttribute('aria-hidden','true'); } };

  // New wrapped functions
  window.showLoading = function(message){
    // call original behaviour (buildSlides, show UI, etc.)
    try { origShow(message); } catch(e){ console.warn('origShow error', e); }
    // mark that no external updates yet, start auto-progress fallback
    externalSet = false;
    lastExternal = -1;
    // small visual reset if needed
    applyProgress(6);
    // start auto increment to avoid staying stuck at 6%
    startAutoProgress();
  };

  window.setLoadingProgress = function(n){
    // mark external update and apply immediately
    externalSet = true;
    lastExternal = Math.max(0, Math.min(100, Math.round(n)));
    applyProgress(lastExternal);

    // if external indicates near-complete, speed-up and stop auto
    if (lastExternal >= 98) {
      stopAutoProgress();
    } else {
      // keep auto running but make sure it never lags behind external
      if (!autoTimer) startAutoProgress();
      // bring autoValue up to external value so increments continue from there
      autoValue = Math.max(autoValue || 0, lastExternal);
    }
    // retain original behaviour, if any
    try { origSet(n); } catch(e){ /* ignore */ }
  };

  window.hideLoading = function(){
    // on hide: force 100% for a brief moment then hide
    try {
      applyProgress(100);
      stopAutoProgress();
      setTimeout(()=> {
        try { origHide(); } catch(e){ console.warn('origHide error', e); }
        // reset to 0 for next use
        setTimeout(()=> applyProgress(0), 220);
      }, 220);
    } catch(err){
      console.warn('hideLoading wrapper error', err);
      try { origHide(); } catch(e){ }
    }
  };

  // helpful: expose direct control if needed
  window.__stopAutoProgress = stopAutoProgress;
  window.__startAutoProgress = startAutoProgress;

  // debug log
  console.info('Auto-progress fallback installed for loader (prevents sticking at 6%).');
})();
</script>





<!-- ===== Compact loader override ‚Äî paste AFTER your loader widget ===== -->
<style>
/* Make the loader card narrower and shorter */
#autoSuperLoader .card {
  width: min(740px, 92vw) !important;
  max-width: 740px !important;
  padding: 14px 16px !important;
  border-radius: 12px !important;
  transform-origin: center;
}

/* Reduce stage height and padding */
#autoSuperLoader .loader-stage {
  height: 200px !important;
  border-radius: 12px !important;
  inset: 10px;
}

/* Smaller slide items & visuals */
#autoSuperLoader .slide-item {
  width: 260px !important;
  height: 160px !important;
  border-radius: 10px !important;
}
#autoSuperLoader .slide-visual {
  width: 220px !important;
  height: 120px !important;
  border-radius: 10px !important;
}

/* Smaller images */
#autoSuperLoader .slide-visual img {
  transition: transform 520ms cubic-bezier(.2,.9,.25,1);
}



/* Adjust label and title sizes */
#autoSuperLoader .title {
  font-size: 16px !important;
}
#autoSuperLoader .slide-label {
  font-size: 13px !important;
}

/* Progress smaller and tighter */
#autoSuperLoader .progress {
  height: 8px !important;
}
#autoSuperLoader .progress > i::after {
  width: 26% !important;
}
#autoSuperLoader .progress-text {
  font-size: 12px !important;
  width: 64px !important;
}

/* Reduce gap & overall spacing */
#autoSuperLoader .card,
#autoSuperLoader .card .title,
#autoSuperLoader .card .sub {
  gap: 8px;
  margin: 0;
  padding: 0;
}
#autoSuperLoader .sub { font-size: 12px !important; margin-top: 6px !important; }

/* Make floating accents smaller */
#autoSuperLoader .pulse-dot { width:8px; height:8px; opacity:0.85; }

/* Mobile tweaks */
@media (max-width:720px){
  #autoSuperLoader .card { width: calc(96vw); padding:12px; }
  #autoSuperLoader .loader-stage { height:180px; }
  #autoSuperLoader .slide-item { width:220px; height:150px; }
  #autoSuperLoader .slide-visual { width:190px; height:110px; }
}
</style>

<script>
/* Optional: slightly re-center and keep card compact when shown */
(function(){
  const root = document.getElementById('autoSuperLoader');
  const card = document.querySelector('#autoSuperLoader .card');
  if (!root || !card) return;
  const origShow = window.showLoading || function(msg){ root.style.display='flex'; };
  window.showLoading = function(message){
    try { origShow(message); } catch(e){}
    // force compact class (visual)
    card.style.maxWidth = '740px';
    card.style.padding = '14px 16px';
    // re-trigger small entrance
    card.classList.add('enter');
    setTimeout(()=> card.classList.remove('enter'), 520);
  };
})();



async function saveUserData(email, phone, product, prompt, logo, mockup) {
    return await fetch("https://script.google.com/macros/s/AKfycbwntnictkKuf5LZp00OAWO6TMsNUX2tCumtlmZYgbgiJ1ny9oT2cSwdY81bqiQDIdg9zg/exec", {
        method: "POST",
        body: new URLSearchParams({
            email: email,
            phone: phone,
            prompt: prompt,
            product: product,
            logo: logo,
            mockup: mockup
        })
    });
}




 
 
  window.addEventListener("load", function () {
    const loader = document.getElementById("pageLoader");

    // thoda smooth delay (AI feel ke liye)
    setTimeout(() => {
      loader.classList.add("hide");
    }, 1200);
  });





  const searchInput = document.getElementById("productSearchInput");
const clearBtn = document.getElementById("clearSearchBtn");
const resultsBox = document.getElementById("productSearchResults");

function handleProductSearch(value) {
  const q = value.trim();

  // show / hide ‚ùå
  clearBtn.style.display = q ? "block" : "none";

  if (!q) {
    resultsBox.style.display = "none";
    resultsBox.innerHTML = "";
    return;
  }

  // yahan tum apna product + sub-product search logic rakho
  resultsBox.style.display = "block";
}

function clearProductSearch() {
  searchInput.value = "";
  clearBtn.style.display = "none";
  resultsBox.innerHTML = "";
  resultsBox.style.display = "none";
  searchInput.focus();
}








document.addEventListener("DOMContentLoaded", function () {
  const productBtn = document.getElementById("mobileProductBtn");
  const designerPanel = document.querySelector(".designer-panel");
  const backdrop = document.getElementById("mobile-backdrop");

  if (!productBtn || !designerPanel) return;

  function openPanel() {
    designerPanel.classList.add("open");
    backdrop && backdrop.classList.add("visible");
  }

  function closePanel() {
    designerPanel.classList.remove("open");
    backdrop && backdrop.classList.remove("visible");
  }

  // üîÅ TOGGLE ON SAME BUTTON
  productBtn.addEventListener("click", function () {
    if (designerPanel.classList.contains("open")) {
      closePanel();
    } else {
      openPanel();
    }
  });

  // backdrop click = close
  if (backdrop) {
    backdrop.addEventListener("click", closePanel);
  }
});
</script>


</script>
<!-- ===== end compact override ===== -->


<!-- ====== END AUTO-SLIDE (NO DRAW) ====== -->



<!-- <script>
let step = 0;

const overlay = document.getElementById("onboardingOverlay");
const tooltip = document.getElementById("onboardingTooltip");
const text = document.getElementById("onboardingText");

const productSection = document.querySelector(".product-selector-wrapper");
const colorSection = document.querySelector(".color-palette-header");
const logoSection = document.querySelector(".logo-preview-container");

/* Show tooltip near element */
function showStep(target, message) {
  document.querySelectorAll(".onboarding-active")
    .forEach(el => el.classList.remove("onboarding-active"));

  target.classList.add("onboarding-active");
  overlay.classList.remove("hidden");

  const rect = target.getBoundingClientRect();
  tooltip.style.top = rect.top - 60 + "px";
  tooltip.style.left = rect.left + "px";

  text.innerText = message;
}

/* Start onboarding */
function startOnboarding() {
  showStep(productSection, "Select the product first");
}

/* STEP EVENTS */
productSection.addEventListener("click", () => {
  if (step === 0) {
    step = 1;
    showStep(colorSection, "Choose color (optional)");
  }
});

colorSection.addEventListener("click", () => {
  if (step === 1) {
    step = 2;
    showStep(logoSection, "Upload your logo");
  }
});

logoSection.addEventListener("click", () => {
  if (step === 2) {
    overlay.classList.add("hidden");
    document.querySelectorAll(".onboarding-active")
      .forEach(el => el.classList.remove("onboarding-active"));
    localStorage.setItem("onboardingDone", "yes");
  }
});

/* Run only first time */
window.addEventListener("load", () => {
  if (!localStorage.getItem("onboardingDone")) {
    startOnboarding();
  }
});
</script>
<script>
window.addEventListener("load", () => {

  const overlay = document.getElementById("tourOverlay");
  const box = document.getElementById("tourBox");
  const text = document.getElementById("tourText");

  // üî¥ REAL selectors from your file
  const product = document.querySelector(".product-selector-wrapper");
  const color = document.querySelector(".select-color-btn");
  const logo = document.querySelector(".logo-label");

  if(!product || !color || !logo){
    console.error("‚ùå Tour elements not found");
    return;
  }

  let step = 0;

  function show(target,msg){
    document.querySelectorAll(".tour-highlight")
      .forEach(e=>e.classList.remove("tour-highlight"));

    target.classList.add("tour-highlight");
    overlay.style.display="block";
    box.style.display="block";

    const r = target.getBoundingClientRect();
    box.style.top = (r.top - 70) + "px";
    box.style.left = r.left + "px";

    text.innerText = msg;
  }

  // üî• START
  if(!localStorage.getItem("tourDone")){
    show(product,"üëâ Select the product first");
  }

  product.addEventListener("click",()=>{
    if(step===0){
      step=1;
      show(color,"üëâ Choose color (optional)");
    }
  });

  color.addEventListener("click",()=>{
    if(step===1){
      step=2;
      show(logo,"üëâ Upload your logo");
    }
  });

  logo.addEventListener("click",()=>{
    if(step===2){
      overlay.style.display="none";
      box.style.display="none";
      document.querySelectorAll(".tour-highlight")
        .forEach(e=>e.classList.remove("tour-highlight"));
      localStorage.setItem("tourDone","yes");
    }
  });

});
</script> -->





<!-- <style>
/* =========================================================================
   ONBOARDING TUTORIAL SYSTEM CSS
   ========================================================================= */

#onboarding-overlay{
    position:fixed;
    inset:0;
    z-index:9998;
    pointer-events:none;
}

/* .onboarding-backdrop{
    position:fixed;
    inset:0;
    backdrop-filter:blur(4px);
    background:rgba(0,0,0,.25);
} */

.onboarding-highlight{
    position:relative;
    z-index:100001;
    pointer-events:auto;
    box-shadow:0 0 0 4px #6a994e,0 0 18px 8px rgba(106,153,78,.6);
    border-radius:8px;
}

#onboarding-tooltip{
    position:absolute;
    z-index:100003;
    background:#fff;
    padding:16px;
    width:300px;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    font-family:Segoe UI,sans-serif;
    opacity:0;
    transform:scale(.9);
    transition:.3s;
    pointer-events:auto;
}

#onboarding-tooltip.visible{
    opacity:1;
    transform:scale(1);
}

#onboarding-tooltip::before{
    content:'';
    position:absolute;
    left:-10px;
    top:50%;
    transform:translateY(-50%);
    border-width:10px 10px 10px 0;
    border-style:solid;
    border-color:transparent #fff transparent transparent;
}

#onboarding-tooltip h4{
    color:#6a994e;
    margin:0 0 8px;
}

#onboarding-tooltip p{
    font-size:14px;
    margin-bottom:14px;
}

.onboarding-actions{
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.onboarding-btn{
    padding:8px 14px;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
}

#onboarding-next-btn{
    background:#6a994e;
    color:#fff;
    border:none;
}

#onboarding-skip-btn{
    background:none;
    border:1px solid #6a994e;
    color:#6a994e;
}

.onboarding-step-counter{
    font-size:12px;
    color:#666;
}

/* keep color panel clean */
.color-swatch,
.select-color-btn,
.color-palette,
.brand-input,
.logo-label{
    z-index:100002!important;
    position:relative;
    filter:none!important;
    backdrop-filter:none!important;
}

@media(max-width:768px){
    #onboarding-tooltip{
        left:50%!important;
        bottom:20px;
        top:auto!important;
        transform:translateX(-50%) scale(.9);
        width:90%;
    }
    #onboarding-tooltip.visible{
        transform:translateX(-50%) scale(1);
    }
    #onboarding-tooltip::before{display:none;}
}
</style>

<div id="onboarding-overlay" style="display:none">
    <div class="onboarding-backdrop"></div>
    <div id="onboarding-tooltip">
        <h4 id="onboarding-title"></h4>
        <p id="onboarding-description"></p>
        <div class="onboarding-actions">
            <span class="onboarding-step-counter"></span>
            <div>
                <button id="onboarding-skip-btn" class="onboarding-btn">Skip</button>
                <button id="onboarding-next-btn" class="onboarding-btn">Next</button>
            </div>
        </div>
    </div>
</div>

<script>
/* =========================================================================
   ONBOARDING TUTORIAL SYSTEM JS
   ========================================================================= */

const OVERLAY = document.getElementById("onboarding-overlay");
const TOOLTIP = document.getElementById("onboarding-tooltip");
const TITLE = document.getElementById("onboarding-title");
const DESC = document.getElementById("onboarding-description");
const COUNTER = document.querySelector(".onboarding-step-counter");
const NEXT = document.getElementById("onboarding-next-btn");
const SKIP = document.getElementById("onboarding-skip-btn");

let current = 0;
let highlightEl = null;

const steps = [
  {
    title:"Step 1: Select Product",
    desc:"Select any product to continue.",
    selector:".product-selector-wrapper",
    action:".product-item",
    mandatory:true
  },
  
    {
  title:"Step 2: Choose Color (Optional)",
  desc:"Choose a color or skip.",
  selector:".select-color-btn",
  action:".color-swatch",
  mandatory:false
},

  
  {
  title:"Step 3: Brand Name (Optional)",
  desc:"Enter brand name or skip.",
  selector:".brand-input",
  action:".brand-input",
  mandatory:false
}
,
  {
  title:"Step 4: Upload Logo (Optional)",
  desc:"Upload logo or skip.",
  selector:".logo-label",
  action:"input[type='file']",
  mandatory:false
},

  {
    title:"Step 5: Generate",
    desc:"Click Generate to create design.",
    selector:"#generateMockupBtn",
    mandatory:false,
    finish:true
  }
];

function showStep(i){
    if(i>=steps.length) return finish();
    current=i;

    if(highlightEl) highlightEl.classList.remove("onboarding-highlight");

    const step=steps[i];
    const el=document.querySelector(step.selector);
    if(!el){ showStep(i+1); return; }

    highlightEl=el;
    el.classList.add("onboarding-highlight");

    TITLE.innerText=step.title;
    DESC.innerText=step.desc;
    COUNTER.innerText=`Step ${i+1} of ${steps.length}`;

    positionTooltip(el);
    OVERLAY.style.display="block";
    TOOLTIP.classList.add("visible");

    NEXT.disabled=false;

    if(step.mandatory && step.action){
        document.querySelectorAll(step.action).forEach(x=>{
            x.addEventListener("click",()=>next(),{once:true});
        });
    }

    if(step.finish){
        el.addEventListener("click",finish,{once:true});
    }
}

// function positionTooltip(el){
//     const r=el.getBoundingClientRect();
//     TOOLTIP.style.top=(r.top+r.height/2-TOOLTIP.offsetHeight/2)+"px";
//     TOOLTIP.style.left=(r.right+20)+"px";
// }

function positionTooltip(el){
    if(!el) return;

    const r = el.getBoundingClientRect();
    const tooltipHeight = TOOLTIP.offsetHeight;

    let top = r.top + window.scrollY + (r.height / 2) - (tooltipHeight / 2);
    let left = r.right + window.scrollX + 20;

    // keep tooltip inside viewport vertically
    if (top < window.scrollY + 10) {
        top = window.scrollY + 10;
    }

    TOOLTIP.style.top = top + "px";
    TOOLTIP.style.left = left + "px";
}


function next(){
    TOOLTIP.classList.remove("visible");
    setTimeout(()=>showStep(current+1),300);
}

function finish(){
    if(highlightEl) highlightEl.classList.remove("onboarding-highlight");
    OVERLAY.style.display="none";
    TOOLTIP.classList.remove("visible");
    localStorage.setItem("onboarding_done","1");
}

NEXT.onclick=next;
SKIP.onclick=next;

document.addEventListener("DOMContentLoaded",()=>{
    // remove below line if you want only first time
    // if(localStorage.getItem("onboarding_done")) return;
    showStep(0);
});
</script> -->





<!-- ====== END AUTO-SLIDE (NO DRAW) ====== -->
<style>
/* =========================================================================
   ONBOARDING TUTORIAL SYSTEM CSS
   ========================================================================= */

/* --- 1. OVERLAY AND BACKDROP --- */
#onboarding-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9998; /* Below the tooltip, above everything else */
    pointer-events: none; /* Allow clicks to pass through by default */
    transition: opacity 0.3s ease;
}

.onboarding-backdrop {
   display: none !important;
}

/* --- 2. HIGHLIGHT EFFECT (GREEN GLOW) --- */
.onboarding-highlight {
    position: relative;
    z-index: 9999; /* Above the overlay */
    pointer-events: auto; /* Re-enable clicks on the highlighted element */
    transition: box-shadow 0.4s ease-in-out, transform 0.2s ease;
    /* Apply the green glow */
    box-shadow: 0 0 0 4px #6a994e, 0 0 15px 8px rgba(106, 153, 78, 0.7);
    border-radius: 8px; /* Match common element border-radius */
}

/* --- 3. TOOLTIP --- */
#onboarding-tooltip {
    position: absolute;
    z-index: 99999; /* Highest z-index */
    background-color: white;
    color: #333;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    max-width: 300px;
    opacity: 0;
    transform: scale(0.9);
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: auto; /* Allow interaction with buttons */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#onboarding-tooltip.visible {
    opacity: 1;
    transform: scale(1);
}

/* Tooltip Arrow (Pointing to the left - default side position) */
#onboarding-tooltip::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 10px 10px 10px 0;
    border-color: transparent white transparent transparent;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
}

/* --- 4. TOOLTIP CONTENT --- */
#onboarding-tooltip h4 {
    color: #6a994e;
    margin-top: 0;
    margin-bottom: 8px;
    font-size: 1.1em;
}

#onboarding-tooltip p {
    margin-bottom: 15px;
    font-size: 0.95em;
    line-height: 1.4;
}

.onboarding-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.onboarding-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s ease, opacity 0.2s ease;
}

#onboarding-next-btn {
    background-color: #6a994e;
    color: white;
}

#onboarding-next-btn:hover:not(:disabled) {
    background-color: #4a7738;
}

#onboarding-next-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
    opacity: 0.7;
}

#onboarding-skip-btn {
    background-color: transparent;
    color: #6a994e;
    border: 1px solid #6a994e;
}

#onboarding-skip-btn:hover {
    background-color: #f0f5ee;
}

.onboarding-step-counter {
    font-size: 0.85em;
    color: #666;
}

/* --- 5. MOBILE RESPONSIVENESS --- */
@media (max-width: 768px) {
    .onboarding-backdrop {
        backdrop-filter: blur(2px);
    }

    #onboarding-tooltip {
        max-width: 90%;
        left: 50% !important;
        transform: translateX(-50%) scale(0.9);
        top: auto !important;
        bottom: 20px; /* Position at the bottom of the screen */
    }

    #onboarding-tooltip.visible {
        transform: translateX(-50%) scale(1);
    }

    /* Remove arrow for mobile (bottom position) */
    #onboarding-tooltip::before {
        content: none;
    }
    /* Allow interaction clearly */
.onboarding-highlight {
    pointer-events: auto !important;
}

}
/* üî• Ensure color palette is NEVER dim during onboarding */
#colorPalette.onboarding-highlight {
    background: #ffffff !important;
    opacity: 1 !important;
    filter: none !important;
    backdrop-filter: none !important;
    box-shadow: 0 0 0 4px #6a994e, 0 0 18px rgba(106,153,78,0.8) !important;
    z-index: 100000 !important;
}

</style>

<div id="onboarding-overlay" style="display: none;">
    <div class="onboarding-backdrop"></div>
    <div id="onboarding-tooltip">
        <h4 id="onboarding-title"></h4>
        <p id="onboarding-description"></p>
        <div class="onboarding-actions">
            <span class="onboarding-step-counter"></span>
            <div>
                <button id="onboarding-skip-btn" class="onboarding-btn">Skip</button>
                <button id="onboarding-next-btn" class="onboarding-btn" disabled>Next</button>
            </div>
        </div>
    </div>
</div>

<script>
/* =========================================================================
   ONBOARDING TUTORIAL SYSTEM JAVASCRIPT
   ========================================================================= */

const TUTORIAL_KEY = 'onboarding_tutorial_completed';
const HIGHLIGHT_CLASS = 'onboarding-highlight';
const OVERLAY = document.getElementById('onboarding-overlay');
const TOOLTIP = document.getElementById('onboarding-tooltip');
const NEXT_BTN = document.getElementById('onboarding-next-btn');
const SKIP_BTN = document.getElementById('onboarding-skip-btn');
const TITLE_EL = document.getElementById('onboarding-title');
const DESC_EL = document.getElementById('onboarding-description');
const COUNTER_EL = document.querySelector('.onboarding-step-counter');

let currentStepIndex = 0;
let currentHighlightedElement = null;
let isActionCompleted = false;

const steps = [
    {
        title: "Step 1: Select Your Product",
        description: "Start by choosing the type of packaging you want to design. Click on any product item to proceed.",
        selector: ".product-selector-wrapper", // Highlight the wrapper for visibility
        actionSelector: ".product-item", // Listen for click on an item inside
        requiredAction: true,
        actionEvent: 'click'
    },
  //   {
  // title: "Step 2: Choose a Color",
  // description: "Now, select a base color for your design from the available swatches.",
  // selector: "#openColorPaletteBtn",   // ‚úÖ visible element
  // actionSelector: ".color-swatch",    // ‚úÖ actual click
  // requiredAction: true,
  // actionEvent: "click"


  //   },
  //   {
  //       title: "Step 3: Upload Your Logo (Optional)",
  //       description: "You can upload your brand logo here. This step is optional, so you can click 'Next' to continue.",
  //       selector: ".logo-label", // Highlight the visible label/button for upload
  //       actionSelector: null,
  //       requiredAction: false
  //   },

  {
  title:"Step 2: Choose Color (Optional)",
  desc:"Choose a color or skip.",
  selector:".select-color-btn",
  action:".color-swatch",
  mandatory:false
},

  {
  title:"Step 4: Upload Logo (Optional)",
  desc:"Upload logo or skip.",
  selector:".logo-label",
  action:"input[type='file']",
  mandatory:false
},

{
  title:"Step 3: Brand Name (Optional)",
  description:"Enter your brand name here. This step is optional.",
  selector:"#brandNameInput",
  action:"#brandNameInput",
  requiredAction:false,
  actionEvent:"input"
},
    {
        title: "Step 4: Generate Mockup",
        description: "You're all set! Click the 'Generate Mockup' button to see your AI-powered design.",
        selector: "#generateMockupBtn",
        actionSelector: null,
        requiredAction: true,
        actionEvent: 'click'
    }
];

// --- CORE FUNCTIONS ---

function showStep(index) {
    if (index >= steps.length) {
        finishTutorial();
        return;
    }

    currentStepIndex = index;
    const step = steps[index];
    // üî• SPECIAL FIX FOR COLOR STEP
if (index === 1) {
  const palette = document.getElementById("colorPalette");
  if (palette) {
    palette.style.display = "flex"; // force open palette
  }
}

    const targetEl = document.querySelector(step.selector);
    // Auto close tutorial on Generate click
if (step.selector === "#generateMockupBtn") {
    targetEl.addEventListener("click", finishTutorial, { once: true });
}


    if (!targetEl) {
        console.warn(`Onboarding: Target element not found for step ${index}: ${step.selector}. Skipping step.`);
        nextStep(); // Skip if element is missing
        return;
    }

    // 1. Clean up previous step
    if (currentHighlightedElement) {
        currentHighlightedElement.classList.remove(HIGHLIGHT_CLASS);
        removeActionListeners();
    }

    // 2. Set up new step
    currentHighlightedElement = targetEl;
    currentHighlightedElement.classList.add(HIGHLIGHT_CLASS);
    
    TITLE_EL.textContent = step.title;
    DESC_EL.textContent = step.description;
    COUNTER_EL.textContent = `Step ${index + 1} of ${steps.length}`;
    
    // 3. Conditional Next Button
    isActionCompleted = !step.requiredAction;
    NEXT_BTN.disabled = !isActionCompleted;
    
    // 4. Position Tooltip
    positionTooltip(targetEl);
    TOOLTIP.classList.add('visible');
    OVERLAY.style.display = 'block';

    // 5. Set up action listeners for required steps
    // Listen action for BOTH mandatory & optional steps
if (step.actionSelector) {
    setupActionListener(step);
}


function positionTooltip(targetEl) {
    const targetRect = targetEl.getBoundingClientRect();
    const tooltipWidth = 300; // Max width from CSS
    const padding = 20;
    
    // Default position: Right side
    let top = targetRect.top + (targetRect.height / 2) - (TOOLTIP.offsetHeight / 2);
    let left = targetRect.right + padding;
    
    // Check if it fits on the right
    if (left + tooltipWidth > window.innerWidth) {
        // Try left side
        left = targetRect.left - tooltipWidth - padding;
        
        // Update arrow position to point right
        TOOLTIP.style.setProperty('--arrow-left', 'auto');
        TOOLTIP.style.setProperty('--arrow-right', '-10px');
        TOOLTIP.style.setProperty('--arrow-border', 'transparent transparent transparent white');
        TOOLTIP.classList.add('left-side');
        
        // Check if it fits on the left
        if (left < 0) {
            // Fallback to bottom-center (Mobile style)
            left = (window.innerWidth / 2) - (tooltipWidth / 2);
            top = targetRect.bottom + padding;
            
            // Remove arrow
            TOOLTIP.classList.remove('left-side');
            TOOLTIP.style.setProperty('--arrow-border', 'none');
        }
    } else {
        // Default right side (ensure arrow points left)
        TOOLTIP.classList.remove('left-side');
        TOOLTIP.style.setProperty('--arrow-left', '-10px');
        TOOLTIP.style.setProperty('--arrow-right', 'auto');
        TOOLTIP.style.setProperty('--arrow-border', 'transparent white transparent transparent');
    }
    
    // Clamp top position to keep it on screen
    if (top < 10) top = 10;
    if (top + TOOLTIP.offsetHeight > window.innerHeight - 10) {
        top = window.innerHeight - TOOLTIP.offsetHeight - 10;
    }

    TOOLTIP.style.top = `${top}px`;
    TOOLTIP.style.left = `${left}px`;
    
    // Mobile check: If screen is small, force bottom position (overrides desktop logic)
    if (window.innerWidth <= 768) {
        TOOLTIP.style.top = 'auto';
        TOOLTIP.style.bottom = '20px';
        TOOLTIP.style.left = '50%';
        TOOLTIP.style.transform = 'translateX(-50%)';
        TOOLTIP.classList.remove('left-side');
        TOOLTIP.style.position = 'absolute';

        // Arrow is handled by CSS media query
    }
}

// function setupActionListener(step) {
//     const actionHandler = (event) => {
//         // For step 4 (Generate button), we only track the click, but don't prevent the default action
//         if (currentStepIndex === 3) {
//             // The action is completed, allow the button to proceed
//             markActionCompleted();
//             // The next step will be called by the click handler below
//         } else {
//             // For other steps, mark completed and proceed to next tutorial step
//             markActionCompleted();
//             nextStep();
//         }
//     };

//     // Attach listener to the action selector
//     document.querySelectorAll(step.actionSelector).forEach(el => {
//         el.addEventListener(step.actionEvent, actionHandler, { once: true });
//     });

function setupActionListener(step) {
    const handler = () => {
        markActionCompleted();

        // üî• AUTO MOVE FOR OPTIONAL + REQUIRED STEPS
        setTimeout(() => {
            nextStep();
        }, 200);
    };

    document.querySelectorAll(step.actionSelector).forEach(el => {
        el.addEventListener("click", handler, { once: true });
        el.addEventListener("change", handler, { once: true });
        el.addEventListener("input", handler, { once: true });
    });

    TOOLTIP.currentActionHandler = handler;
    TOOLTIP.currentActionSelector = step.actionSelector;
}

    
    // Store the handler and selector for cleanup
    TOOLTIP.currentActionHandler = actionHandler;
    TOOLTIP.currentActionSelector = step.actionSelector;
    TOOLTIP.currentActionEvent = step.actionEvent;
}

function removeActionListeners() {
    if (TOOLTIP.currentActionSelector && TOOLTIP.currentActionHandler) {
        document.querySelectorAll(TOOLTIP.currentActionSelector).forEach(el => {
            el.removeEventListener(TOOLTIP.currentActionEvent, TOOLTIP.currentActionHandler);
        });
        TOOLTIP.currentActionSelector = null;
        TOOLTIP.currentActionHandler = null;
        TOOLTIP.currentActionEvent = null;
    }
}

function markActionCompleted() {
    isActionCompleted = true;
    NEXT_BTN.disabled = false;
    // Remove listeners immediately after action is completed to prevent multiple triggers
    removeActionListeners(); 
}

function nextStep() {
    // Only proceed if the action was completed or not required
    if (isActionCompleted || !steps[currentStepIndex].requiredAction) {
        TOOLTIP.classList.remove('visible');
        // Wait for transition before showing next step
        setTimeout(() => {
            showStep(currentStepIndex + 1);
        }, 300);
    }
}

function finishTutorial() {
    if (currentHighlightedElement) {
        currentHighlightedElement.classList.remove(HIGHLIGHT_CLASS);
    }
    removeActionListeners();
    OVERLAY.style.opacity = '0';
    TOOLTIP.classList.remove('visible');
    localStorage.setItem(TUTORIAL_KEY, 'true');
    
    setTimeout(() => {
        OVERLAY.style.display = 'none';
    }, 300);
}

// --- EVENT LISTENERS ---

// Next button click (for optional steps or after action is completed)
NEXT_BTN.addEventListener('click', nextStep);

// Skip button click
SKIP_BTN.addEventListener('click', finishTutorial);

// Window resize for responsiveness
window.addEventListener('resize', () => {
    if (OVERLAY.style.display !== 'none') {
        positionTooltip(currentHighlightedElement);
    }
});
window.addEventListener('scroll', () => {
    if (OVERLAY.style.display !== 'none' && currentHighlightedElement) {
        positionTooltip(currentHighlightedElement);
    }
}, true);

/// --- INITIALIZATION ---

function initOnboarding() {
    // 1. Check if Mobile View (Mobile par tutorial nhi dikhana)
    if (window.innerWidth <= 768) {
        OVERLAY.style.display = 'none';
        return; // Mobile hai toh yahi se stop ho jao
    }

    // 2. Check if tutorial has been completed
    const isCompleted = localStorage.getItem(TUTORIAL_KEY);
    
    if (isCompleted === 'true') {
        OVERLAY.style.display = 'none';
        return;
    }
    
    // 3. Start the tutorial only for Desktop
    showStep(0);
}

// Start the tutorial once the DOM is fully loaded
document.addEventListener('DOMContentLoaded', initOnboarding);

// --- Global Action Tracking (Fallback/General) ---
// This ensures that even if the user clicks the required element outside of the tutorial flow, 
// the 'Next' button is enabled for the current step.

document.addEventListener('click', (event) => {
    const step = steps[currentStepIndex];
    if (step && step.requiredAction && step.actionSelector && !isActionCompleted) {
        // Check if the clicked element matches the required action selector
        if (event.target.closest(step.actionSelector)) {
            markActionCompleted();
            // If it's not the final step, automatically advance
            if (currentStepIndex !== 3) {
                nextStep();
            }
        }
    }
});





// ‚ùå Disable right-click globally
  document.addEventListener('contextmenu', function (e) {
    e.preventDefault();
    return false;
  });

    document.addEventListener('keydown', function (e) {
    if (
      (e.ctrlKey && e.key.toLowerCase() === 's') ||  // Ctrl+S
      (e.ctrlKey && e.key.toLowerCase() === 'u') ||  // Ctrl+U
      (e.ctrlKey && e.shiftKey && e.key === 'I')     // DevTools
    ) {
      e.preventDefault();
      return false;
    }
  });

</script>








<!-- üîí SCREENSHOT WARNING SYSTEM (CLEAN VIEW) -->
<!--<style>
/* Popup UI */
#screenshot-popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000000;
  font-family: system-ui, Arial, sans-serif;
}

#screenshot-popup .box {
  background: #fff;
  padding: 22px 26px;
  border-radius: 14px;
  text-align: center;
  width: 280px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.35);
  animation: pop 0.25s ease;
}

#screenshot-popup h3 {
  margin: 0 0 8px;
  font-size: 18px;
}

#screenshot-popup p {
  margin: 0 0 14px;
  font-size: 14px;
  color: #555;
}

#screenshot-popup button {
  background: #111;
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
}

@keyframes pop {
  from { transform: scale(0.9); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
</style>

<div id="screenshot-popup">
  <div class="box">
    <h3>‚ö†Ô∏è Screenshot Disabled</h3>
    <p>Please download the mockup<br>instead of taking screenshot.</p>
    <button onclick="closeScreenshotPopup()">OK</button>
  </div>
</div>

<script>
/* Utility */
function showScreenshotPopup() {
  const pop = document.getElementById("screenshot-popup");
  pop.style.display = "flex";
}
function closeScreenshotPopup() {
  document.getElementById("screenshot-popup").style.display = "none";
}

/* ‚ùå Disable right click & drag (basic protection) */
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("dragstart", e => e.preventDefault());

/* üö® Print / Save attempt */
window.addEventListener("beforeprint", showScreenshotPopup);

/* üö® Tab switch / minimize / screenshot tools */
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    showScreenshotPopup();
  }
});

/* üö® Keyboard shortcuts */
document.addEventListener("keydown", e => {
  if (
    e.key === "PrintScreen" ||
    (e.ctrlKey && e.key.toLowerCase() === "p") ||
    (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === "s")
  ) {
    showScreenshotPopup();
    e.preventDefault();
  }
});

/* üö® Mobile screenshot / recorder hint */
window.addEventListener("blur", () => {
  showScreenshotPopup();
});
</script>
<!-- üîí END -->






<!-- üîê SCREENSHOT PREVENTION (MAX POSSIBLE) -->
<style>
#ss-warning {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999999;
  font-family: system-ui, Arial;
}

#ss-warning .card {
  background: #fff;
  padding: 22px 26px;
  border-radius: 14px;
  text-align: center;
  width: 300px;
  box-shadow: 0 20px 50px rgba(0,0,0,0.4);
}

#ss-warning h3 {
  margin: 0 0 8px;
  font-size: 18px;
}

#ss-warning p {
  margin: 0;
  font-size: 14px;
  color: #555;
}

#ss-warning button {
  margin-top: 14px;
  background: #000;
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
}
</style>

<div id="ss-warning">
  <div class="card">
    <h3>üö´ Screenshot Disabled</h3>
    <p>Please download the mockup.<br>Screenshot is not allowed.</p>
    <button onclick="hideSS()">OK</button>
  </div>
</div>

<!-- VM Button & Dropdown -->
<div class="vm-button-container">
    <button class="vm-btn" id="vmMenuBtn" title="Generate VM Branding Sheet">
        <i class="bi bi-file-earmark-pdf"></i>
        <span>VM</span>
        <i class="bi bi-chevron-down dropdown-arrow"></i>
        <span class="vm-selected-count" id="vmSelectedCount" style="display: none;">0</span>
    </button>
    
    <!-- Loading Overlay -->
    <div id="vmLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; flex-direction: column; align-items: center; justify-content: center;">
        <div class="vm-loader"></div>
        <p style="margin-top: 20px; font-weight: 600; color: #00B050;">Generating Your VM Sheet...</p>
    </div>

    <!-- Dropdown Menu -->
    <div class="vm-dropdown-menu" id="vmDropdownMenu">
        <div class="vm-dropdown-header">
            <h3><i class="bi bi-box-seam"></i> Select Products</h3>
            <button class="vm-select-all-btn" id="vmSelectAllBtn">Select All</button>
        </div>
        
        <div class="vm-product-list" id="vmProductList"></div>
        
        <div class="vm-dropdown-footer">
            <button class="vm-action-btn generate-selected" id="vmGenerateSelectedBtn" style="display: none;">
                <i class="bi bi-check-circle"></i>
                Generate Selected (<span id="selectedCountText">0</span>)
            </button>
            <button class="vm-action-btn generate-all" id="vmGenerateAllBtn">
                <i class="bi bi-stars"></i>
                Generate All Products
            </button>
            <button class="vm-action-btn cancel" id="vmCancelBtn">
                <i class="bi bi-x-circle"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- VM Verification Modal (reuse download modal structure) -->
<div class="download-modal" id="vmVerificationModal">
    <div class="download-modal-content">
        <div class="download-modal-header">
            <h3>Verify to Download VM Sheet</h3>
            <button class="download-modal-close" id="closeVmModalBtn">&times;</button>
        </div>
        <div class="download-modal-body">
            <p>We require a valid contact to provide the VM branding sheet.</p>

            <div class="download-form-group" id="vmEmailGroup">
                <label>Email Address</label>
                <input type="email" id="vmEmail" placeholder="your.email@example.com" />
                <div class="download-error-message">Please enter a valid email address</div>
            </div>

            <div class="download-form-group" id="vmPhoneGroup">
                <label>Phone Number</label>
                <input id="vmPhone" type="tel" placeholder="Phone Number" />
                <div class="download-error-message">Please enter a valid phone number</div>
            </div>

            <button class="download-submit-btn" id="vmSubmitBtn">Generate VM Sheet</button>

            <p class="download-disclaimer">
                Your information will be used for verification and contact purposes only.
            </p>
        </div>
    </div>
</div>

<script>
const popup = document.getElementById("ss-warning");

function showSS() {
  popup.style.display = "flex";
}
function hideSS() {
  popup.style.display = "none";
}

/* ‚ùå Disable right click & drag */
document.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("dragstart", e => e.preventDefault());

/* üö® ALL COMMON SCREENSHOT KEYS */
document.addEventListener("keydown", e => {
  const k = e.key.toLowerCase();

  if (
    e.key === "PrintScreen" ||
    (e.ctrlKey && k === "p") ||
    (e.ctrlKey && k === "s") ||
    (e.ctrlKey && e.shiftKey && k === "s") ||
    (e.metaKey && k === "shift") ||
    (e.metaKey && k === "s")
  ) {
    showSS();
    e.preventDefault();
    return false;
  }
});

/* üö® TAB SWITCH / SCREEN RECORDER */
// document.addEventListener("visibilitychange", () => {
//   if (document.visibilityState === "hidden") {
//     showSS();
//   }
// });

/* üö® WINDOW BLUR (mobile + desktop) */
// window.addEventListener("blur", showSS);

/* üö´ PRINT */
window.addEventListener("beforeprint", showSS);




</script>
<!-- üîê END -->






<script>
let CURRENT_SELECTED_PRODUCT = null;

/* product select detect */
document.addEventListener("click", function(e){
  const item = e.target.closest(".product-item");
  if(!item) return;

  CURRENT_SELECTED_PRODUCT = item.dataset.product;
});
</script>
<script>
const PRODUCT_CART_LINKS = {
  "Paper Cup": "https://greenwichpackaging.co.uk/products/paper-cup",
  "Burger Box": "https://yourstore.com/burger-box",
  "Paper Bag": "https://yourstore.com/paper-bag",
  "Pizza Box": "https://yourstore.com/pizza-box"
};

function addToCart(){
  if(!window.CURRENT_SELECTED_PRODUCT){
    alert("Please select a product first");
    return;
  }

  const link = PRODUCT_CART_LINKS[window.CURRENT_SELECTED_PRODUCT];

  if(!link){
    alert("Cart link not added for this product yet");
    return;
  }

  window.open(link, "_blank");
}
</script>

<script>
window.CURRENT_SELECTED_PRODUCT = null;
</script>
<script>
document.addEventListener("click", function(e){
  const item = e.target.closest(".product-item");
  if(!item) return;

  // yahan product identify ho raha hai
  window.CURRENT_SELECTED_PRODUCT =
    item.dataset.product || item.querySelector("span")?.innerText;
});

// vm sheet //
document.addEventListener('DOMContentLoaded', function() {
    const vmBtn = document.getElementById('vmMenuBtn');
    const vmMenu = document.getElementById('vmDropdownMenu');
    const vmList = document.getElementById('vmProductList');
    const vmSelectAllBtn = document.getElementById('vmSelectAllBtn');
    const vmGenAll = document.getElementById('vmGenerateAllBtn');
    const vmGenSelected = document.getElementById('vmGenerateSelectedBtn');
    const vmCancel = document.getElementById('vmCancelBtn');
    const selectedCountSpan = document.getElementById('vmSelectedCount');
    const selectedCountText = document.getElementById('selectedCountText');
    
    // ‚úÖ NEW: Verification Modal Elements
    const vmVerificationModal = document.getElementById('vmVerificationModal');
    const closeVmModalBtn = document.getElementById('closeVmModalBtn');
    const vmSubmitBtn = document.getElementById('vmSubmitBtn');
    const vmEmailInput = document.getElementById('vmEmail');
    const vmPhoneInput = document.getElementById('vmPhone');
    
    if (!vmBtn || !vmMenu) return;
    
    let selectedProducts = new Set();
    let allProductIds = [];
    let pendingVmProducts = [];
    
    // ‚úÖ Initialize Phone Input for VM Modal
    let vmIti = null;
    if (vmPhoneInput) {
        vmIti = window.intlTelInput(vmPhoneInput, {
            initialCountry: "GB",
            separateDialCode: true,
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
        });
    }
    
  const vmProducts = [
        { id: 'paper_cup', name: 'Paper Cup', subs: [
            { id: 'single_wall', name: 'Single Wall' },
            { id: 'double_wall', name: 'Double Wall' }
        ]},
        { id: 'paper_bag', name: 'Paper Bag', subs: [
            { id: 'flat', name: 'White Flat Handle' },
            { id: 'white_twisted', name: 'White Twisted Handle' },
            { id: 'k_paper_bag_twisted', name: 'Kraft Twisted' },
            { id: 'k_paper_bag_flat', name: 'Kraft Flat' }
        ]},
        { id: 'paper_bowl', name: 'Paper Bowl', subs: [] },
        { id: 'pizza_box', name: 'Pizza Box', subs: [
            { id: 'pizza_box', name: 'Standard Kraft' },
            { id: 'triangular_pizza_box', name: 'Triangular Slice' },
            { id: 'white_pizza_box', name: 'White Pizza Box' }
        ]},
        { id: 'burger_box', name: 'Burger Box', subs: [] },
        { id: 'sandwich_box', name: 'Sandwich Box', subs: [
            { id: 'sandwich_box', name: 'Window Box' },
            { id: 'sandwich_box2', name: 'Standard Box' }
        ]},
        { id: 'Meal_Box', name: 'Meal Box', subs: [] },
        { id: 'roll_box', name: 'Roll Box', subs: [
            { id: 'roll_box', name: 'Standard' },
            { id: 'roll_locking_box', name: 'Locking' },
            { id: 'roll_sliding_box', name: 'Sliding' }
        ]},
        { id: 'noodle_pasta_box', name: 'Noodle Box', subs: [] },
        { id: 'popcorn_holder', name: 'Popcorn & Fries', subs: [
            { id: 'popcorn_holder', name: 'Popcorn' },
            { id: 'popcorn_holder2', name: 'Large Popcorn' },
            { id: 'fries_holder', name: 'Fries' }
        ]},
        { id: 'paper_tray', name: 'Paper Tray', subs: [] },
        { id: 'white_paper_stand_up_bag', name: 'Stand Up Pouch', subs: [
            { id: 'white_paper_stand_up_bag', name: 'White' },
            { id: 'paper_stand_up_bag', name: 'Kraft' }
        ]},
        { id: 'k pastry box', name: 'Pastry Box', subs: [
            { id: 'k pastry box', name: 'Kraft Box' },
            { id: 'pastry_box_with_handle', name: 'With Handle' }
        ]},
        { id: 'handle_cake_box', name: 'Cake Box', subs: [
            { id: 'handle_cake_box', name: 'Handle Box' },
            { id: 'cake_box', name: 'Standard' },
            { id: 'cake_box2', name: 'Window' }
        ]},
        { id: 'flat_box', name: 'Flat Box', subs: [
            { id: 'flat_box', name: 'White' },
            { id: 'flat_box2', name: 'Kraft' }
        ]},
        { id: 'Biryani_box2', name: 'Biryani Box', subs: [
            { id: 'Biryani_box2', name: 'Kraft' },
            { id: 'biryani_box', name: 'Standard' }
        ]},
        { id: 'ice cream box 2', name: 'Ice Cream Box', subs: [
            { id: 'ice cream box 2', name: 'Premium' },
            { id: 'ice cream box', name: 'Standard' }
        ]},
        { id: 'chocolate_box', name: 'Chocolate Box', subs: [
            { id: 'chocolate_box', name: 'Flat' },
            { id: 'chocolate_box2', name: 'Tall Handle' }
        ]}
    ];
    
    function buildAllProductIds() {
        allProductIds = [];
        vmProducts.forEach(p => {
            if (p.subs.length > 0) {
                p.subs.forEach(s => allProductIds.push(s.id));
            } else {
                allProductIds.push(p.id);
            }
        });
    }
    
    function buildDropdown() {
        vmList.innerHTML = '';
        
        vmProducts.forEach(product => {
            const row = document.createElement('div');
            row.className = 'vm-product-row';
            
            const hasSubs = product.subs.length > 0;
            
            const mainItem = document.createElement('div');
            mainItem.className = 'vm-product-item';
            mainItem.dataset.id = hasSubs ? '' : product.id;
            mainItem.innerHTML = `
                <span>${product.name}</span>
                ${hasSubs ? '<i class="bi bi-chevron-right sub-arrow"></i>' : ''}
            `;
            
            row.appendChild(mainItem);
            
            if (!hasSubs) {
                mainItem.addEventListener('click', function() {
                    toggleProduct(product.id);
                });
            }
            
            if (hasSubs) {
                const subContainer = document.createElement('div');
                subContainer.className = 'vm-sub-list';
                subContainer.style.display = 'none';
                
                product.subs.forEach(sub => {
                    const subItem = document.createElement('div');
                    subItem.className = 'vm-product-item vm-sub-item';
                    subItem.dataset.id = sub.id;
                    subItem.innerHTML = `<span>‚Ä¢ ${sub.name}</span>`;
                    
                    subItem.addEventListener('click', function() {
                        toggleProduct(sub.id);
                    });
                    
                    subContainer.appendChild(subItem);
                });
                
                row.appendChild(subContainer);
                
                mainItem.addEventListener('click', function(e) {
                    const isOpen = subContainer.style.display === 'block';
                    subContainer.style.display = isOpen ? 'none' : 'block';
                    mainItem.querySelector('.sub-arrow').style.transform = 
                        isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
                });
            }
            
            vmList.appendChild(row);
        });
        
        updateUI();
    }
    
    function toggleProduct(id) {
        if (selectedProducts.has(id)) {
            selectedProducts.delete(id);
        } else {
            selectedProducts.add(id);
        }
        updateUI();
    }
    
    function updateUI() {
        const count = selectedProducts.size;
        
        selectedCountSpan.textContent = count;
        selectedCountText.textContent = count;
        
        document.querySelectorAll('.vm-product-item').forEach(item => {
            const id = item.dataset.id;
            if (id && selectedProducts.has(id)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
        
        if (count > 0) {
            vmGenSelected.style.display = 'flex';
            vmGenAll.style.display = 'none';
            selectedCountSpan.style.display = 'flex';
        } else {
            vmGenSelected.style.display = 'none';
            vmGenAll.style.display = 'flex';
            selectedCountSpan.style.display = 'none';
        }
        
        if (count === allProductIds.length) {
            vmSelectAllBtn.classList.add('selected');
            vmSelectAllBtn.textContent = 'Deselect All';
        } else {
            vmSelectAllBtn.classList.remove('selected');
            vmSelectAllBtn.textContent = 'Select All';
        }
    }
    
    vmSelectAllBtn.addEventListener('click', function() {
        if (selectedProducts.size === allProductIds.length) {
            selectedProducts.clear();
        } else {
            selectedProducts = new Set(allProductIds);
        }
        updateUI();
    });
    
    vmBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = vmMenu.classList.toggle('active');
        if (isOpen) {
            buildAllProductIds();
            buildDropdown();
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!vmBtn.contains(e.target) && !vmMenu.contains(e.target)) {
            vmMenu.classList.remove('active');
        }
    });
    
    // ‚úÖ Generate All - Opens Verification Modal
    vmGenAll.addEventListener('click', function() {
        pendingVmProducts = allProductIds;
        openVmVerificationModal();
    });
    
    // ‚úÖ Generate Selected - Opens Verification Modal
    vmGenSelected.addEventListener('click', function() {
        if (selectedProducts.size > 0) {
            pendingVmProducts = Array.from(selectedProducts);
            openVmVerificationModal();
        }
    });
    
    vmCancel.addEventListener('click', function() {
        vmMenu.classList.remove('active');
        selectedProducts.clear();
        updateUI();
    });
    
    // ‚úÖ Open Verification Modal
    function openVmVerificationModal() {
        if (!uploadedLogoBase64) {
            alert('üö® Please upload a logo first!');
            return;
        }
        
        vmMenu.classList.remove('active');
        vmVerificationModal.classList.add('active');
        
        vmEmailInput.value = '';
        if (vmIti) vmIti.setNumber('');
        document.getElementById('vmEmailGroup').classList.remove('error');
        document.getElementById('vmPhoneGroup').classList.remove('error');
    }
    
    // ‚úÖ Close Modal
    closeVmModalBtn.addEventListener('click', function() {
        vmVerificationModal.classList.remove('active');
    });
    
    window.addEventListener('click', function(e) {
        if (e.target === vmVerificationModal) {
            vmVerificationModal.classList.remove('active');
        }
    });
    
    // ‚úÖ Submit Verification and Generate VM Sheet
    vmSubmitBtn.addEventListener('click', async function() {
        const email = vmEmailInput.value.trim();
        const phone = vmIti ? vmIti.getNumber() : '';
        const isPhoneValid = vmIti ? vmIti.isValidNumber() : false;
        const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        
        if (!emailValid) {
            document.getElementById('vmEmailGroup').classList.add('error');
            return;
        } else {
            document.getElementById('vmEmailGroup').classList.remove('error');
        }
        
        if (!isPhoneValid) {
            document.getElementById('vmPhoneGroup').classList.add('error');
            return;
        } else {
            document.getElementById('vmPhoneGroup').classList.remove('error');
        }
        
        const originalText = vmSubmitBtn.textContent;
        vmSubmitBtn.textContent = 'Verifying...';
        vmSubmitBtn.disabled = true;
        
        vmVerificationModal.classList.remove('active');
        document.getElementById('vmLoadingOverlay').style.display = 'flex';
        
        try {
            const response = await fetch('/generate_vm_sheet_enhanced', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    products: pendingVmProducts,
                    logo_b64: uploadedLogoBase64,
                    brand_name: document.getElementById('brandNameInput')?.value || 'Greenwich Packaging',
                    color: selectedColor || '#FFFFFF',
                    logo_mime_type: uploadedLogoMimeType || 'image/png',
                    email: email,
                    phone: phone
                })
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Greenwich_VM_Sheet_${Date.now()}.pdf`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('‚úÖ VM Sheet downloaded successfully!');
            selectedProducts.clear();
            updateUI();
            
        } catch (error) {
            console.error('VM Error:', error);
            alert(`‚ùå Error: ${error.message}`);
        } finally {
            document.getElementById('vmLoadingOverlay').style.display = 'none';
            vmSubmitBtn.textContent = originalText;
            vmSubmitBtn.disabled = false;
        }
    });

    // üì± INITIAL MOBILE VIEW: Open Designer Panel by default
    if (window.innerWidth <= 768) {
        if (typeof toggleMobileSidebar === 'function') {
            toggleMobileSidebar(true);
        }
    }
});







// ‚úÖ METHOD 1: Hidden iFrame Method (Best for CORS)
async function saveUserData(email, phone, product, prompt, logo, mockup) {
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwoyWqDZGifZOMFNovKMetriPBuu-bVnOwkqacrnaz0XIh1wK_L4q09LC8tn9VW40Ug/exec';
    
    
    return new Promise((resolve) => {
        try {
            // Create hidden iframe
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'sheet-submit-frame';
            document.body.appendChild(iframe);
            
            // Create form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = WEB_APP_URL;
            form.target = 'sheet-submit-frame';
            form.style.display = 'none';
            
            // Add form fields
            const fields = {
                email: email || '',
                phone: phone || '',
                product: product || '',
                prompt: prompt || '',
                logoImage: logo || '',
                mockupImage: mockup || ''
            };
            
            for (const [key, value] of Object.entries(fields)) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            
            // Submit form
            form.submit();
            
            // Cleanup after 2 seconds
            setTimeout(() => {
                document.body.removeChild(form);
                document.body.removeChild(iframe);
            }, 2000);
            resolve(true);
        } catch (error) {
            resolve(false);
        }
    });
}

// ========================================
// EXPANDABLE DESCRIPTION TOGGLE
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('descToggleBtn');
    const content = document.getElementById('descContent');
    
    if (toggleBtn && content) {
        toggleBtn.addEventListener('click', function() {
            // Toggle expanded class
            content.classList.toggle('expanded');
            toggleBtn.classList.toggle('active');
            
            // Smooth scroll to description
            if (content.classList.contains('expanded')) {
                setTimeout(() => {
                    content.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 100);
            }
        });
    }
});

</script>





















</html>
