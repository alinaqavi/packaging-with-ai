<!-- ========================================================================
     üé® VM BUTTON & DROPDOWN MENU ENHANCEMENT
     ======================================================================== 
     This code should be added to your existing index.html
     
     PLACEMENT:
     - Add the CSS to your <style> section
     - Add the HTML button to the chat-panel header or top-right area
     - Add the JavaScript to your existing script section
     ======================================================================== -->

<!-- ========================================================================
     1. CSS STYLES FOR VM BUTTON & DROPDOWN
     ======================================================================== -->
<style>
/* ========================================================================
   VM BUTTON - Top Right Corner
 * VM Button Styles - White Background */
.vm-button-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.vm-btn {
    background: white !important;
    color: #00B050 !important;
    border: 2px solid #00B050 !important;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 176, 80, 0.2);
    transition: all 0.3s ease;
}

.vm-btn:hover {
    background: #f0faf0 !important;
    border-color: #008030 !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 176, 80, 0.3);
}

.vm-btn.active {
    background: #00B050 !important;
    color: white !important;
}

.vm-dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: white;
    border: 2px solid #00B050;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 320px;
    max-width: 400px;
    max-height: 600px;
    overflow-y: auto;
    display: none;
    z-index: 1001;
}

.vm-dropdown-menu.active {
    display: block;
}

.vm-dropdown-header {
    padding: 16px;
    border-bottom: 2px solid #f0f0f0;
    background: white;
}

.vm-dropdown-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    color: #1A1A1A;
}

.vm-product-list {
    padding: 0;
    background: white;
}

.vm-dropdown-footer {
    padding: 12px 16px;
    border-top: 2px solid #f0f0f0;
    background: white;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.vm-action-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.vm-action-btn.generate-all {
    background: #FF6B35;
    color: white;
}

.vm-action-btn.generate-all:hover {
    background: #F7931E;
}

.vm-action-btn.cancel {
    background: #e0e0e0;
    color: #333;
}

.vm-selected-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #FF6B35;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}
/* ========================================================================
   PRODUCT LIST
   ======================================================================== */
.vm-product-list {
    padding: 8px;
}

.vm-product-item {
    padding: 12px 16px;
    margin-bottom: 6px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.vm-product-item:hover {
    background: #f0faf0;
    transform: translateX(4px);
}

.vm-product-item.has-sub::after {
    content: '‚ñ∂';
    color: #00B050;
    font-size: 12px;
    font-weight: bold;
}

.vm-product-item-text {
    flex-grow: 1;
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.vm-product-item-text .product-name {
    display: block;
    font-weight: 600;
    color: #1A1A1A;
}

.vm-product-item-text .product-desc {
    display: block;
    font-size: 12px;
    color: #666;
    margin-top: 2px;
}

/* ========================================================================
   NESTED SUB-PRODUCTS DROPDOWN
   ======================================================================== */
.vm-sub-dropdown {
    position: absolute;
    top: 0;
    left: 100%;
    margin-left: 8px;
    background: white;
    border: 2px solid #00B050;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 280px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
    z-index: 1002;
    animation: slideRight 0.3s ease;
}

.vm-sub-dropdown.active {
    display: block;
}

@keyframes slideRight {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.vm-sub-dropdown-header {
    padding: 12px 16px;
    border-bottom: 2px solid #f0f0f0;
    background: linear-gradient(135deg, #f8fdf6 0%, #f0faf0 100%);
    font-size: 13px;
    font-weight: 600;
    color: #00B050;
    display: flex;
    align-items: center;
    gap: 6px;
}

.vm-sub-item {
    padding: 10px 16px;
    margin: 4px 0;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.vm-sub-item:hover {
    background: #e6f6e0;
    transform: translateX(4px);
    color: #00B050;
    font-weight: 600;
}

.vm-sub-item::before {
    content: '‚óè';
    color: #FF6B35;
    font-size: 10px;
}

/* ========================================================================
   ACTION BUTTONS
   ======================================================================== */
.vm-dropdown-footer {
    padding: 12px 16px;
    border-top: 2px solid #f0f0f0;
    background: #f8fdf6;
    border-radius: 0 0 10px 10px;
    display: flex;
    gap: 8px;
    flex-direction: column;
}

.vm-action-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.vm-action-btn.generate-all {
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
    color: white;
}

.vm-action-btn.generate-all:hover {
    background: linear-gradient(135deg, #F7931E 0%, #FF6B35 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.vm-action-btn.cancel {
    background: #e0e0e0;
    color: #333;
}

.vm-action-btn.cancel:hover {
    background: #d0d0d0;
}

/* ========================================================================
   SELECTED PRODUCTS INDICATOR
   ======================================================================== */
.vm-selected-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #FF6B35;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
}

/* ========================================================================
   SCROLLBAR STYLING
   ======================================================================== */
.vm-dropdown-menu::-webkit-scrollbar,
.vm-sub-dropdown::-webkit-scrollbar {
    width: 6px;
}

.vm-dropdown-menu::-webkit-scrollbar-track,
.vm-sub-dropdown::-webkit-scrollbar-track {
    background: #f0f0f0;
}

.vm-dropdown-menu::-webkit-scrollbar-thumb,
.vm-sub-dropdown::-webkit-scrollbar-thumb {
    background: #00B050;
    border-radius: 3px;
}

.vm-dropdown-menu::-webkit-scrollbar-thumb:hover,
.vm-sub-dropdown::-webkit-scrollbar-thumb:hover {
    background: #008030;
}

/* ========================================================================
   RESPONSIVE DESIGN
   ======================================================================== */
@media (max-width: 768px) {
    .vm-button-container {
        top: 10px;
        right: 10px;
    }
    
    .vm-btn {
        padding: 10px 16px;
        font-size: 13px;
    }
    
    .vm-dropdown-menu {
        min-width: 280px;
        max-width: 90vw;
    }
    
    .vm-sub-dropdown {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        min-width: 280px;
        max-width: 90vw;
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .vm-btn {
        padding: 8px 12px;
        font-size: 12px;
    }
    
    .vm-dropdown-menu {
        min-width: 260px;
    }
    
    .vm-product-item {
        padding: 10px 12px;
    }
    
    .vm-product-item-text .product-desc {
        display: none;
    }
}

/* ========================================================================
   LOADING STATE
   ======================================================================== */
.vm-action-btn.loading {
    opacity: 0.7;
    pointer-events: none;
}

.vm-action-btn.loading::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ========================================================================
   DARK MODE SUPPORT (Optional)
   ======================================================================== */
@media (prefers-color-scheme: dark) {
    .vm-dropdown-menu {
        background: #2a2a2a;
        border-color: #00B050;
    }
    
    .vm-dropdown-header,
    .vm-dropdown-footer {
        background: #1f1f1f;
        color: #fff;
    }
    
    .vm-product-item {
        color: #e0e0e0;
    }
    
    .vm-product-item:hover {
        background: #333;
    }
    
    .vm-product-item-text {
        color: #e0e0e0;
    }
    
    .vm-product-item-text .product-name {
        color: #fff;
    }
    
    .vm-product-item-text .product-desc {
        color: #999;
    }
}
</style>

<!-- ========================================================================
     2. HTML - VM BUTTON & DROPDOWN
     ======================================================================== -->
<!-- Place this in your chat-panel header or create a new container -->
<div class="vm-button-container">
    <button class="vm-btn" id="vmMenuBtn" title="Generate VM Branding Sheet">
        <i class="bi bi-file-earmark-pdf"></i>
        <span>VM</span>
        <i class="bi bi-chevron-down dropdown-arrow"></i>
        <span class="vm-selected-count" id="vmSelectedCount" style="display: none;">0</span>
    </button>
    
    <!-- Dropdown Menu -->
    <div class="vm-dropdown-menu" id="vmDropdownMenu">
        <!-- Header -->
        <div class="vm-dropdown-header">
            <h3>
                <i class="bi bi-box-seam"></i>
                Select Products
            </h3>
        </div>
        
        <!-- Product List -->
        <div class="vm-product-list" id="vmProductList">
            <!-- Dynamically populated by JavaScript -->
        </div>
        
        <!-- Footer with Actions -->
        <div class="vm-dropdown-footer">
            <button class="vm-action-btn generate-all" id="vmGenerateAllBtn">
                <i class="bi bi-stars"></i>
                Generate All Products
            </button>
            <button class="vm-action-btn" id="vmGenerateSelectedBtn" style="display: none;">
                <i class="bi bi-check-circle"></i>
                Generate Selected
            </button>
            <button class="vm-action-btn cancel" id="vmCancelBtn">
                <i class="bi bi-x-circle"></i>
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- ========================================================================
     3. JAVASCRIPT - VM BUTTON & DROPDOWN LOGIC
     ======================================================================== -->
<script>
// ========================================================================
// VM BUTTON & DROPDOWN FUNCTIONALITY
// ========================================================================

const vmMenuBtn = document.getElementById('vmMenuBtn');
const vmDropdownMenu = document.getElementById('vmDropdownMenu');
const vmProductList = document.getElementById('vmProductList');
const vmGenerateAllBtn = document.getElementById('vmGenerateAllBtn');
const vmGenerateSelectedBtn = document.getElementById('vmGenerateSelectedBtn');
const vmCancelBtn = document.getElementById('vmCancelBtn');
const vmSelectedCount = document.getElementById('vmSelectedCount');

// Product data (same as in your backend)
const vmProductsData = [
    { id: 'paper_cup', name: 'Paper Cup', desc: 'Premium hot & cold beverage cups', subOptions: [
        { id: 'single_wall', name: 'Single Wall Paper Cup' },
        { id: 'double_wall', name: 'Double Wall Paper Cup' }
    ]},
    { id: 'paper_bag', name: 'Paper Bag', desc: 'Eco-friendly kraft & white bags', subOptions: [
        { id: 'flat', name: 'White Flat Handle' },
        { id: 'white_twisted', name: 'White Twisted Handle' },
        { id: 'k_paper_bag_twisted', name: 'Kraft Twisted Handle' },
        { id: 'k_paper_bag_flat', name: 'Kraft Flat Handle' }
    ]},
    { id: 'paper_bowl', name: 'Paper Bowl', desc: 'Durable & leak-resistant bowls', subOptions: [] },
    { id: 'wrapping_paper', name: 'Food Wrapping Paper', desc: 'Greaseproof wrapping rolls', subOptions: [] },
    { id: 'pizza_box', name: 'Pizza Box', desc: 'Premium corrugated pizza boxes', subOptions: [
        { id: 'pizza_box', name: 'Standard Kraft Pizza Box' },
        { id: 'triangular_pizza_box', name: 'Triangular Slice Pizza Box' },
        { id: 'white_pizza_box', name: 'White Pizza Box' }
    ]},
    { id: 'burger_box', name: 'Burger Box', desc: 'Sturdy burger & sandwich boxes', subOptions: [] },
    { id: 'sandwich_box', name: 'Sandwich Box', desc: 'Wedge-style with clear windows', subOptions: [
        { id: 'sandwich_box', name: 'Window Sandwich Box' },
        { id: 'sandwich_box2', name: 'Standard Sandwich Box' }
    ]},
    { id: 'Meal_Box', name: 'Meal Box', desc: 'Multi-compartment meal boxes', subOptions: [] },
    { id: 'roll_box', name: 'Roll Box', desc: 'Versatile roll-style boxes', subOptions: [
        { id: 'roll_box', name: 'Standard Roll Box' },
        { id: 'roll_locking_box', name: 'Roll Locking Box' },
        { id: 'roll_sliding_box', name: 'Roll Sliding Box' }
    ]},
    { id: 'noodle_pasta_box', name: 'Noodle Box', desc: 'Asian-style noodle boxes', subOptions: [] },
    { id: 'popcorn_holder', name: 'Popcorn & Fries', desc: 'Cinema-style holders', subOptions: [
        { id: 'popcorn_holder', name: 'Popcorn Holder' },
        { id: 'popcorn_holder2', name: 'Large Popcorn Holder' },
        { id: 'fries_holder', name: 'French Fries Holder' }
    ]},
    { id: 'paper_tray', name: 'Paper Tray', desc: 'Disposable food trays', subOptions: [] },
    { id: 'white_paper_stand_up_bag', name: 'Stand Up Pouch', desc: 'Premium resealable pouches', subOptions: [
        { id: 'white_paper_stand_up_bag', name: 'White Stand Up Bag' },
        { id: 'paper_stand_up_bag', name: 'Kraft Stand Up Bag' }
    ]},
    { id: 'k pastry box', name: 'Pastry Box', desc: 'Premium bakery boxes', subOptions: [
        { id: 'k pastry box', name: 'Kraft Pastry Box' },
        { id: 'pastry_box_with_handle', name: 'Pastry Box with Handle' },
        { id: 'k pastry holder', name: 'Kraft Pastry Holder' },
        { id: 'pastry holder', name: 'Pastry Tray Holder' },
        { id: 'pastry holder 2', name: 'Premium Pastry Holder' }
    ]},
    { id: 'handle_cake_box', name: 'Cake Box', desc: 'Sturdy cake boxes', subOptions: [
        { id: 'handle_cake_box', name: 'Cake Box with Handle' },
        { id: 'cake_box', name: 'Standard Cake Box' },
        { id: 'cake_box2', name: 'Window Cake Box' }
    ]},
    { id: 'flat_box', name: 'Flat Box', desc: 'Versatile rectangular boxes', subOptions: [
        { id: 'flat_box', name: 'White Flat Box' },
        { id: 'flat_box2', name: 'Kraft Flat Box' }
    ]},
    { id: 'Biryani_box2', name: 'Biryani Box', desc: 'Specialized rice dish boxes', subOptions: [
        { id: 'Biryani_box2', name: 'Kraft Biryani Box' },
        { id: 'biryani_box', name: 'Standard Biryani Box' }
    ]},
    { id: 'ice cream box 2', name: 'Ice Cream Box', desc: 'Insulated ice cream boxes', subOptions: [
        { id: 'ice cream box 2', name: 'Premium Ice Cream Box' },
        { id: 'ice cream box', name: 'Standard Ice Cream Box' }
    ]},
    { id: 'chocolate_box', name: 'Chocolate Box', desc: 'Elegant confectionery boxes', subOptions: [
        { id: 'chocolate_box', name: 'Flat Chocolate Box' },
        { id: 'chocolate_box2', name: 'Tall Handle Chocolate Box' }
    ]}
];

let vmSelectedProducts = new Set();

// Initialize VM dropdown
function initializeVMDropdown() {
    vmProductList.innerHTML = '';
    
    vmProductsData.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.style.position = 'relative';
        
        // Main product item
        const productItem = document.createElement('div');
        productItem.className = `vm-product-item ${product.subOptions.length > 0 ? 'has-sub' : ''}`;
        productItem.innerHTML = `
            <div class="vm-product-item-text">
                <span class="product-name">${product.name}</span>
                <span class="product-desc">${product.desc}</span>
            </div>
        `;
        
        // Handle product selection
        productItem.addEventListener('click', (e) => {
            e.stopPropagation();
            
            if (product.subOptions.length > 0) {
                // Show sub-dropdown
                const subDropdown = productDiv.querySelector('.vm-sub-dropdown');
                if (subDropdown) {
                    subDropdown.classList.toggle('active');
                }
            } else {
                // Toggle product selection
                if (vmSelectedProducts.has(product.id)) {
                    vmSelectedProducts.delete(product.id);
                    productItem.style.background = '';
                } else {
                    vmSelectedProducts.add(product.id);
                    productItem.style.background = '#e6f6e0';
                }
                updateVMCount();
            }
        });
        
        productDiv.appendChild(productItem);
        
        // Sub-products dropdown
        if (product.subOptions.length > 0) {
            const subDropdown = document.createElement('div');
            subDropdown.className = 'vm-sub-dropdown';
            
            const subHeader = document.createElement('div');
            subHeader.className = 'vm-sub-dropdown-header';
            subHeader.innerHTML = `<i class="bi bi-arrow-right"></i> ${product.name}`;
            subDropdown.appendChild(subHeader);
            
            product.subOptions.forEach(sub => {
                const subItem = document.createElement('div');
                subItem.className = 'vm-sub-item';
                subItem.textContent = sub.name;
                
                subItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (vmSelectedProducts.has(sub.id)) {
                        vmSelectedProducts.delete(sub.id);
                        subItem.style.background = '';
                    } else {
                        vmSelectedProducts.add(sub.id);
                        subItem.style.background = '#e6f6e0';
                    }
                    updateVMCount();
                });
                
                subDropdown.appendChild(subItem);
            });
            
            productDiv.appendChild(subDropdown);
        }
        
        vmProductList.appendChild(productDiv);
    });
}

// Update selected count badge
function updateVMCount() {
    const count = vmSelectedProducts.size;
    if (count > 0) {
        vmSelectedCount.textContent = count;
        vmSelectedCount.style.display = 'flex';
        vmGenerateSelectedBtn.style.display = 'flex';
    } else {
        vmSelectedCount.style.display = 'none';
        vmGenerateSelectedBtn.style.display = 'none';
    }
}

// Toggle dropdown menu
vmMenuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    vmDropdownMenu.classList.toggle('active');
    vmMenuBtn.classList.toggle('active');
    
    if (vmDropdownMenu.classList.contains('active')) {
        initializeVMDropdown();
    }
});

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.vm-button-container')) {
        vmDropdownMenu.classList.remove('active');
        vmMenuBtn.classList.remove('active');
    }
});

// Generate All Products
vmGenerateAllBtn.addEventListener('click', () => {
    vmSelectedProducts.clear();
    vmProductsData.forEach(p => vmSelectedProducts.add(p.id));
    triggerVMGeneration();
});

// Generate Selected Products
vmGenerateSelectedBtn.addEventListener('click', () => {
    if (vmSelectedProducts.size > 0) {
        triggerVMGeneration();
    }
});

// Cancel
vmCancelBtn.addEventListener('click', () => {
    vmSelectedProducts.clear();
    vmDropdownMenu.classList.remove('active');
    vmMenuBtn.classList.remove('active');
    updateVMCount();
});

// Trigger VM generation
function triggerVMGeneration() {
    if (!uploadedLogoBase64) {
        alert('‚ö†Ô∏è Please upload a logo first!');
        return;
    }
    
    if (vmSelectedProducts.size === 0) {
        alert('‚ö†Ô∏è Please select at least one product!');
        return;
    }
    
    // Call the existing VM generation function
    generateVMSheet(Array.from(vmSelectedProducts));
    
    // Close dropdown
    vmDropdownMenu.classList.remove('active');
    vmMenuBtn.classList.remove('active');
}

// Function to call backend VM generation
async function generateVMSheet(selectedProducts) {
    try {
        vmGenerateAllBtn.classList.add('loading');
        vmGenerateSelectedBtn.classList.add('loading');
        
        const payload = {
            products: selectedProducts,
            logo_b64: uploadedLogoBase64,
            brand_name: document.getElementById('brandNameInput')?.value || 'Visual Merchandising',
            color: selectedColor || '#FFFFFF',
            logo_mime_type: logoMimeType || 'image/png'
        };
        
        const response = await fetch('/generate_vm_sheet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) throw new Error('Failed to generate VM sheet');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `VM_Branding_Sheet_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        addMessage('ai', '‚úÖ **VM Branding Sheet Generated!**\n\nüìÑ Your professional PDF has been downloaded.\n\nüé® Includes:\n- Professional cover page\n- Product mockups\n- Branding guidelines\n- Premium formatting');
        
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error generating VM sheet. Please try again.');
    } finally {
        vmGenerateAllBtn.classList.remove('loading');
        vmGenerateSelectedBtn.classList.remove('loading');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initializeVMDropdown();
});
</script>
